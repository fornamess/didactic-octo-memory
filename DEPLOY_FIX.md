# Решение проблемы EADDRINUSE (порт 3000 занят)

## Проблема
Приложение не может запуститься, так как порт 3000 уже занят. PM2 пытается перезапустить приложение, но процесс падает с ошибкой `EADDRINUSE: address already in use :::3000`.

## Быстрое решение

### Вариант 1: Использовать скрипт экстренной очистки

На сервере выполните:

```bash
cd /home/appuser/app
chmod +x fix-port-urgent.sh
./fix-port-urgent.sh
```

Затем запустите PM2:

```bash
pm2 start ecosystem.config.js --update-env
pm2 save
```

### Вариант 2: Ручная очистка (если скрипт не доступен)

```bash
cd /home/appuser/app

# 1. Остановить PM2
pm2 stop all || true
pm2 delete all || true
pm2 kill || true
sleep 3

# 2. Найти процессы на порту 3000
ss -tlnp | grep :3000

# 3. Убить найденные процессы (замените PID на реальный)
# kill -9 <PID>

# 4. Убить все Node.js процессы
pkill -9 -f "next start" || true
pkill -9 -f "node.*next" || true
killall -9 node 2>/dev/null || true

# 5. Подождать
sleep 5

# 6. Проверить, что порт свободен
ss -tlnp | grep :3000  # Должно быть пусто

# 7. Запустить PM2
pm2 start ecosystem.config.js --update-env
pm2 save
pm2 status
```

### Вариант 3: Использовать обновлённый скрипт деплоя

После того как порт освобождён, используйте обновлённый скрипт:

```bash
cd /home/appuser/app
chmod +x fix-deploy.sh
./fix-deploy.sh
```

## Что изменено

1. **fix-deploy.sh** - улучшен скрипт деплоя с более агрессивной очисткой порта 3000
2. **fix-port-urgent.sh** - новый скрипт для экстренной очистки порта

## Профилактика

Проблема обычно возникает, когда:
- Приложение падает, но PM2 пытается его перезапустить до освобождения порта
- Остаются "висячие" процессы Node.js
- Неправильно остановлен предыдущий процесс

Обновлённый `fix-deploy.sh` теперь:
- Полностью останавливает PM2 перед запуском
- Использует несколько методов для поиска процессов на порту
- Агрессивно очищает все Node.js процессы
- Проверяет, что порт свободен перед запуском
