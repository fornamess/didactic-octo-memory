================================================================================
–°–ë–û–† –í–°–ï–• –ò–°–•–û–î–ù–ò–ö–û–í –ò–ó –ü–ê–ü–ö–ò SRC
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 04.12.2025, 23:05:38
–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: 69
================================================================================


================================================================================
–§–ê–ô–õ 1/69: app\admin\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\admin\page.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { useRouter } from "next/navigation";
import Link from "next/link";
import {
  Users,
  Search,
  Settings,
  LogOut,
  ArrowLeft,
  ChevronRight,
  Coins,
  FileText,
  History,
  Save,
  Eye,
  EyeOff,
  Loader,
  Shield,
  DollarSign,
  Calendar,
  Filter,
  Plus,
  X,
} from "lucide-react";

interface User {
  id: number;
  email: string;
  nickname: string;
  first_name: string;
  last_name: string;
  balance: number;
  orders_count: number;
  created_at: string;
}

interface Order {
  id: number;
  order_number: string;
  service_name: string;
  status: string;
  created_at: string;
  video_url: string | null;
}

export default function AdminPage() {
  const router = useRouter();
  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<"users" | "settings" | "finances">("users");
  const [users, setUsers] = useState<User[]>([]);
  const [searchQuery, setSearchQuery] = useState("");
  const [topupModal, setTopupModal] = useState<{ userId: number; nickname: string } | null>(null);
  const [topupAmount, setTopupAmount] = useState("");
  const [topupLoading, setTopupLoading] = useState(false);

  // –§–∏–Ω–∞–Ω—Å—ã
  const [invoices, setInvoices] = useState<any[]>([]);
  const [invoicesLoading, setInvoicesLoading] = useState(false);
  const [dateFilter, setDateFilter] = useState({ start: "", end: "" });
  const [statusFilter, setStatusFilter] = useState<"all" | "completed" | "pending">("all");
  const [nicknameFilter, setNicknameFilter] = useState("");

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  const [settings, setSettings] = useState({
    emailVerificationRequired: false,
    agreementText: "",
    contactsText: "",
  });
  const [settingsSaving, setSettingsSaving] = useState(false);

  useEffect(() => {
    checkAdminAccess();
  }, []);

  const checkAdminAccess = async () => {
    try {
      const token = localStorage.getItem("token");
      if (!token) {
        router.push("/login");
        return;
      }

      const response = await fetch("/api/admin/check", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) {
        router.push("/");
        return;
      }

      setIsAdmin(true);
      loadUsers();
      loadSettings();
    } catch (error) {
      router.push("/");
    } finally {
      setLoading(false);
    }
  };

  const loadUsers = async () => {
    try {
      const token = localStorage.getItem("token");
      const response = await fetch("/api/admin/users", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      if (data.users) {
        setUsers(data.users);
      }
    } catch (error) {
      console.error("Load users error:", error);
    }
  };

  const loadSettings = async () => {
    try {
      const token = localStorage.getItem("token");
      const response = await fetch("/api/admin/settings", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      if (data.settings) {
        setSettings({
          emailVerificationRequired: data.settings.email_verification_required === "1",
          agreementText: data.settings.user_agreement_text || "",
          contactsText: data.settings.contacts_text || "",
        });
      }
    } catch (error) {
      console.error("Load settings error:", error);
    }
  };


  const handleSaveSettings = async () => {
    setSettingsSaving(true);
    try {
      const token = localStorage.getItem("token");
      await fetch("/api/admin/settings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(settings),
      });
      alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
    } catch (error) {
      alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫");
    } finally {
      setSettingsSaving(false);
    }
  };

  const handleSearch = async () => {
    if (!searchQuery.trim()) {
      loadUsers();
      return;
    }

    try {
      const token = localStorage.getItem("token");
      const response = await fetch(
        `/api/admin/users/search?q=${encodeURIComponent(searchQuery)}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const data = await response.json();
      setUsers(data.users || []);
    } catch (error) {
      console.error("Search error:", error);
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
    });
  };

  const formatDateTime = (dateString: string) => {
    const date = new Date(dateString);
    return {
      date: date.toLocaleDateString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      }),
      time: date.toLocaleTimeString("ru-RU", {
        hour: "2-digit",
        minute: "2-digit",
      }),
    };
  };

  const handleTopup = async () => {
    if (!topupModal) return;
    const amount = parseFloat(topupAmount);
    if (!amount || amount <= 0) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
      return;
    }

    setTopupLoading(true);
    try {
      const token = localStorage.getItem("token");
      const response = await fetch(`/api/admin/users/${topupModal.userId}/topup`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ amount }),
      });

      const data = await response.json();
      if (response.ok && data.success) {
        alert(`–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${topupModal.nickname} —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount} –ö–æ–π–Ω–æ–≤`);
        setTopupModal(null);
        setTopupAmount("");
        loadUsers();
      } else {
        alert(data.error || "–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞");
      }
    } catch (error) {
      console.error("Topup error:", error);
      alert("–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞");
    } finally {
      setTopupLoading(false);
    }
  };


  const loadInvoices = async () => {
    setInvoicesLoading(true);
    try {
      const token = localStorage.getItem("token");
      const params = new URLSearchParams();
      if (dateFilter.start) params.append("startDate", dateFilter.start);
      if (dateFilter.end) params.append("endDate", dateFilter.end);
      if (statusFilter !== "all") params.append("status", statusFilter);
      if (nicknameFilter.trim()) params.append("nickname", nicknameFilter.trim());

      const response = await fetch(
        `/api/admin/invoices?${params.toString()}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const data = await response.json();
      if (data.invoices) {
        setInvoices(data.invoices);
      }
    } catch (error) {
      console.error("Load invoices error:", error);
    } finally {
      setInvoicesLoading(false);
    }
  };

  useEffect(() => {
    if (activeTab === "finances") {
      loadInvoices();

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      const interval = setInterval(async () => {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ Bitbanker API
        try {
          const token = localStorage.getItem("token");
          await fetch("/api/admin/invoices/check-status", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });
        } catch (error) {
          console.error("Check invoices status error:", error);
        }

        // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        loadInvoices();
      }, 30000);

      return () => clearInterval(interval);
    }
  }, [activeTab, dateFilter, statusFilter, nicknameFilter]);

  if (loading) {
    return (
      <main className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <Loader className="w-12 h-12 text-[#ffd700] animate-spin" />
      </main>
    );
  }

  if (!isAdmin) {
    return null;
  }

  return (
    <main className="min-h-screen bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –•–µ–¥–µ—Ä */}
      <header className="bg-black/30 border-b border-white/10">
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-4">
            <Link
              href="/"
              className="text-[#a8d8ea] hover:text-white transition-colors"
            >
              <ArrowLeft className="w-5 h-5" />
            </Link>
            <div className="flex items-center gap-2">
              <Shield className="w-6 h-6 text-[#ffd700]" />
              <h1 className="text-xl font-bold text-white">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            </div>
          </div>

          <button
            onClick={() => {
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              router.push("/");
            }}
            className="text-[#a8d8ea]/60 hover:text-red-400 transition-colors flex items-center gap-2"
          >
            <LogOut className="w-5 h-5" />
            –í—ã–π—Ç–∏
          </button>
        </div>
      </header>

      <div className="container mx-auto px-4 py-8">
        {/* –¢–∞–±—ã */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={() => setActiveTab("users")}
            className={`px-6 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2 ${
              activeTab === "users"
                ? "bg-[#c41e3a] text-white"
                : "glass text-[#a8d8ea] hover:bg-white/10"
            }`}
          >
            <Users className="w-5 h-5" />
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
          </button>
          <button
            onClick={() => setActiveTab("finances")}
            className={`px-6 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2 ${
              activeTab === "finances"
                ? "bg-[#c41e3a] text-white"
                : "glass text-[#a8d8ea] hover:bg-white/10"
            }`}
          >
            <DollarSign className="w-5 h-5" />
            –§–∏–Ω–∞–Ω—Å—ã
          </button>
          <button
            onClick={() => setActiveTab("settings")}
            className={`px-6 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2 ${
              activeTab === "settings"
                ? "bg-[#c41e3a] text-white"
                : "glass text-[#a8d8ea] hover:bg-white/10"
            }`}
          >
            <Settings className="w-5 h-5" />
            –ù–∞—Å—Ç—Ä–æ–π–∫–∏
          </button>
        </div>

        <AnimatePresence mode="wait">
          {activeTab === "users" && (
            <motion.div
              key="users"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
            >
              {/* –ü–æ–∏—Å–∫ */}
              <div className="card-festive rounded-xl p-4 mb-6">
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && handleSearch()}
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É –∏–ª–∏ email..."
                    className="input-magic flex-1 px-4 py-3 rounded-xl text-[#f0f8ff]"
                  />
                  <button
                    onClick={handleSearch}
                    className="btn-magic px-6 py-3 rounded-xl text-white flex items-center gap-2"
                  >
                    <Search className="w-5 h-5" />
                    –ù–∞–π—Ç–∏
                  </button>
                </div>
              </div>

              {/* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */}
              <div className="card-festive rounded-3xl p-6">
                <h2 className="text-xl font-bold text-white mb-4">
                  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({users.length})
                </h2>

                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="text-[#a8d8ea]/60 text-left border-b border-white/10">
                        <th className="pb-3 pr-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th className="pb-3 pr-4">–ë–∞–ª–∞–Ω—Å</th>
                        <th className="pb-3 pr-4">–ó–∞–∫–∞–∑–æ–≤</th>
                        <th className="pb-3 pr-4">–î–µ–π—Å—Ç–≤–∏—è</th>
                        <th className="pb-3"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {users.map((user) => (
                        <tr
                          key={user.id}
                          className="border-b border-white/5 hover:bg-white/5"
                        >
                          <td
                            className="py-4 pr-4 cursor-pointer"
                            onClick={() => router.push(`/admin/users/${user.id}`)}
                          >
                            <div>
                              <p className="text-white font-semibold">
                                {user.nickname}
                              </p>
                              <p className="text-[#a8d8ea]/60 text-sm">
                                {user.email}
                              </p>
                            </div>
                          </td>
                          <td
                            className="py-4 pr-4 cursor-pointer"
                            onClick={() => router.push(`/admin/users/${user.id}`)}
                          >
                            <span className="text-[#ffd700] font-bold">
                              {user.balance}
                            </span>
                            <span className="text-[#a8d8ea]/60 ml-1">
                              –ö–æ–π–Ω–æ–≤
                            </span>
                          </td>
                          <td
                            className="py-4 pr-4 text-[#a8d8ea] cursor-pointer"
                            onClick={() => router.push(`/admin/users/${user.id}`)}
                          >
                            {user.orders_count}
                          </td>
                          <td className="py-4 pr-4">
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setTopupModal({ userId: user.id, nickname: user.nickname });
                              }}
                              className="btn-magic px-3 py-1.5 rounded-lg text-white text-sm flex items-center gap-2 hover:scale-105 transition-transform"
                              title="–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"
                            >
                              <Plus className="w-4 h-4" />
                              –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                            </button>
                          </td>
                          <td
                            className="py-4 cursor-pointer"
                            onClick={() => router.push(`/admin/users/${user.id}`)}
                          >
                            <ChevronRight className="w-5 h-5 text-[#a8d8ea]/40" />
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </motion.div>
          )}

          {activeTab === "finances" && (
            <motion.div
              key="finances"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
            >
              {/* –§–∏–ª—å—Ç—Ä—ã */}
              <div className="card-festive rounded-xl p-4 mb-6">
                <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                  <Filter className="w-5 h-5" />
                  –§–∏–ª—å—Ç—Ä—ã
                </h2>
                <div className="grid md:grid-cols-4 gap-4">
                  {/* –ü–µ—Ä–∏–æ–¥ */}
                  <div>
                    <label className="block text-[#a8d8ea] text-sm mb-2">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label>
                    <input
                      type="date"
                      value={dateFilter.start}
                      onChange={(e) =>
                        setDateFilter({ ...dateFilter, start: e.target.value })
                      }
                      className="input-magic w-full px-4 py-2 rounded-xl text-[#f0f8ff]"
                    />
                  </div>
                  <div>
                    <label className="block text-[#a8d8ea] text-sm mb-2">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label>
                    <input
                      type="date"
                      value={dateFilter.end}
                      onChange={(e) =>
                        setDateFilter({ ...dateFilter, end: e.target.value })
                      }
                      className="input-magic w-full px-4 py-2 rounded-xl text-[#f0f8ff]"
                    />
                  </div>
                  {/* –°—Ç–∞—Ç—É—Å */}
                  <div>
                    <label className="block text-[#a8d8ea] text-sm mb-2">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</label>
                    <select
                      value={statusFilter}
                      onChange={(e) =>
                        setStatusFilter(e.target.value as "all" | "completed" | "pending")
                      }
                      className="input-magic w-full px-4 py-2 rounded-xl text-[#f0f8ff]"
                    >
                      <option value="all">–í—Å–µ</option>
                      <option value="completed">–û–ø–ª–∞—á–µ–Ω</option>
                      <option value="pending">–ù–µ –æ–ø–ª–∞—á–µ–Ω</option>
                    </select>
                  </div>
                  {/* –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∏–∫—É */}
                  <div>
                    <label className="block text-[#a8d8ea] text-sm mb-2">–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input
                      type="text"
                      value={nicknameFilter}
                      onChange={(e) => setNicknameFilter(e.target.value)}
                      placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..."
                      className="input-magic w-full px-4 py-2 rounded-xl text-[#f0f8ff]"
                    />
                  </div>
                </div>
              </div>

              {/* –¢–∞–±–ª–∏—Ü–∞ –∏–Ω–≤–æ–π—Å–æ–≤ */}
              <div className="card-festive rounded-3xl p-6">
                <h2 className="text-xl font-bold text-white mb-4">
                  –ò–Ω–≤–æ–π—Å—ã ({invoices.length})
                </h2>

                {invoicesLoading ? (
                  <div className="flex justify-center py-8">
                    <Loader className="w-8 h-8 text-[#ffd700] animate-spin" />
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="text-[#a8d8ea]/60 text-left border-b border-white/10">
                          <th className="pb-3 pr-4">–î–∞—Ç–∞</th>
                          <th className="pb-3 pr-4">–í—Ä–µ–º—è</th>
                          <th className="pb-3 pr-4">–ù–∏–∫</th>
                          <th className="pb-3 pr-4">–°—É–º–º–∞</th>
                          <th className="pb-3 pr-4">–°—Ç–∞—Ç—É—Å</th>
                          <th className="pb-3 pr-4">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å</th>
                          <th className="pb-3">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                      </thead>
                      <tbody>
                        {invoices.length > 0 ? (
                          invoices.map((invoice: any) => {
                            const { date, time } = formatDateTime(invoice.created_at);
                            return (
                              <tr
                                key={invoice.id}
                                className="border-b border-white/5 hover:bg-white/5"
                              >
                                <td className="py-4 pr-4 text-white">{date}</td>
                                <td className="py-4 pr-4 text-[#a8d8ea]">{time}</td>
                                <td className="py-4 pr-4">
                                  <Link
                                    href={`/admin/users/${invoice.user_id}`}
                                    className="text-[#ffd700] hover:text-[#ffed4e] transition-colors font-semibold"
                                  >
                                    {invoice.nickname ||
                                     (invoice.first_name && invoice.last_name ? `${invoice.first_name} ${invoice.last_name}` : null) ||
                                     invoice.email ||
                                     `ID: ${invoice.user_id}`}
                                  </Link>
                                </td>
                                <td className="py-4 pr-4 text-[#ffd700] font-bold">
                                  {invoice.amount} –ö–æ–π–Ω–æ–≤
                                </td>
                                <td className="py-4 pr-4">
                                  <span
                                    className={`px-3 py-1 rounded-lg text-sm font-semibold ${
                                      invoice.status === "completed"
                                        ? "bg-green-500/20 text-green-400"
                                        : "bg-yellow-500/20 text-yellow-400"
                                    }`}
                                  >
                                    {invoice.status === "completed" ? "–û–ø–ª–∞—á–µ–Ω" : "–ù–µ –æ–ø–ª–∞—á–µ–Ω"}
                                  </span>
                                </td>
                                <td className="py-4 pr-4">
                                  {invoice.invoice_url ? (
                                    <a
                                      href={invoice.invoice_url}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="text-[#a8d8ea] hover:text-white transition-colors underline"
                                    >
                                      –û—Ç–∫—Ä—ã—Ç—å
                                    </a>
                                  ) : (
                                    <span className="text-[#a8d8ea]/40">‚Äî</span>
                                  )}
                                </td>
                                <td className="py-4">
                                  {/* –ö–Ω–æ–ø–∫–∞ —É–±—Ä–∞–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ */}
                                </td>
                              </tr>
                            );
                          })
                        ) : (
                          <tr>
                            <td colSpan={7} className="py-8 text-center text-[#a8d8ea]/60">
                              –ò–Ω–≤–æ–π—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </motion.div>
          )}

          {activeTab === "settings" && (
            <motion.div
              key="settings"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="card-festive rounded-3xl p-6"
            >
              <h2 className="text-xl font-bold text-white mb-6">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞
              </h2>

              <div className="space-y-6">
                {/* –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email */}
                <div className="flex items-center justify-between p-4 bg-white/5 rounded-xl">
                  <div>
                    <h3 className="text-white font-semibold">
                      –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    </h3>
                    <p className="text-[#a8d8ea]/60 text-sm">
                      –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email
                    </p>
                  </div>
                  <button
                    onClick={() =>
                      setSettings({
                        ...settings,
                        emailVerificationRequired:
                          !settings.emailVerificationRequired,
                      })
                    }
                    className={`w-14 h-8 rounded-full transition-colors ${
                      settings.emailVerificationRequired
                        ? "bg-green-500"
                        : "bg-white/20"
                    }`}
                  >
                    <div
                      className={`w-6 h-6 rounded-full bg-white transition-transform ${
                        settings.emailVerificationRequired
                          ? "translate-x-7"
                          : "translate-x-1"
                      }`}
                    />
                  </button>
                </div>

                {/* –¢–µ–∫—Å—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è */}
                <div>
                  <label className="block text-white font-semibold mb-2">
                    –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è
                  </label>
                  <textarea
                    value={settings.agreementText}
                    onChange={(e) =>
                      setSettings({ ...settings, agreementText: e.target.value })
                    }
                    rows={15}
                    className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] resize-none"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è..."
                  />
                </div>

                {/* –ö–æ–Ω—Ç–∞–∫—Ç—ã */}
                <div>
                  <label className="block text-white font-semibold mb-2">
                    –ö–æ–Ω—Ç–∞–∫—Ç—ã (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML)
                  </label>
                  <textarea
                    value={settings.contactsText}
                    onChange={(e) =>
                      setSettings({ ...settings, contactsText: e.target.value })
                    }
                    rows={10}
                    className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] resize-none"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML, –Ω–∞–ø—Ä–∏–º–µ—Ä: &lt;a href=&quot;https://t.me/username&quot;&gt;Telegram&lt;/a&gt;)"
                  />
                  <p className="text-[#a8d8ea]/60 text-sm mt-2">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML —Ä–∞–∑–º–µ—Ç–∫–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: &lt;a href="https://t.me/username"&gt;Telegram&lt;/a&gt;
                  </p>
                </div>

                <button
                  onClick={handleSaveSettings}
                  disabled={settingsSaving}
                  className="btn-magic px-6 py-3 rounded-xl text-white flex items-center gap-2 disabled:opacity-50"
                >
                  {settingsSaving ? (
                    <Loader className="w-5 h-5 animate-spin" />
                  ) : (
                    <Save className="w-5 h-5" />
                  )}
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ */}
      {topupModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="card-festive rounded-3xl p-6 max-w-md w-full"
          >
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold text-white">
                –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å: {topupModal.nickname}
              </h3>
              <button
                onClick={() => {
                  setTopupModal(null);
                  setTopupAmount("");
                }}
                className="text-[#a8d8ea]/60 hover:text-white transition-colors"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="mb-4">
              <label className="block text-[#a8d8ea] text-sm mb-2">
                –°—É–º–º–∞ (–ö–æ–π–Ω–æ–≤)
              </label>
              <input
                type="number"
                value={topupAmount}
                onChange={(e) => setTopupAmount(e.target.value)}
                min="1"
                step="1"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff]"
                autoFocus
              />
            </div>

            <div className="flex gap-3">
              <button
                onClick={handleTopup}
                disabled={topupLoading || !topupAmount}
                className="btn-magic flex-1 px-4 py-3 rounded-xl text-white flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {topupLoading ? (
                  <Loader className="w-5 h-5 animate-spin" />
                ) : (
                  <>
                    <Save className="w-5 h-5" />
                    –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                  </>
                )}
              </button>
              <button
                onClick={() => {
                  setTopupModal(null);
                  setTopupAmount("");
                }}
                className="glass px-4 py-3 rounded-xl text-[#a8d8ea] hover:bg-white/10 transition-colors"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </motion.div>
        </div>
      )}
    </main>
  );
}



================================================================================
–§–ê–ô–õ 2/69: app\admin\users\[userId]\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\admin\users\[userId]\page.tsx
================================================================================

'use client';

import { motion } from 'framer-motion';
import { ArrowLeft, Coins, History, Loader, Plus, Save, Shield, X } from 'lucide-react';
import Link from 'next/link';
import { useParams, useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';

interface User {
  id: number;
  email: string;
  nickname: string;
  first_name: string;
  last_name: string;
  balance: number;
  orders_count: number;
  created_at: string;
}

interface Order {
  id: number;
  order_number: string;
  service_name: string;
  status: string;
  created_at: string;
  video_url: string | null;
}

export default function UserDetailPage() {
  const router = useRouter();
  const params = useParams();
  const userId = params?.userId as string;

  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState<User | null>(null);
  const [userOrders, setUserOrders] = useState<Order[]>([]);
  const [userTransactions, setUserTransactions] = useState<
    Array<{
      id: number;
      amount: number;
      status: string;
      created_at: string;
    }>
  >([]);
  const [showTopupModal, setShowTopupModal] = useState(false);
  const [topupAmount, setTopupAmount] = useState('');
  const [topupLoading, setTopupLoading] = useState(false);

  useEffect(() => {
    checkAdminAccess();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (isAdmin && userId) {
      loadUserData();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isAdmin, userId]);

  const checkAdminAccess = async () => {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        router.push('/login');
        return;
      }

      const response = await fetch('/api/admin/check', {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) {
        router.push('/');
        return;
      }

      setIsAdmin(true);
    } catch {
      router.push('/');
    } finally {
      setLoading(false);
    }
  };

  const loadUserData = async () => {
    try {
      const token = localStorage.getItem('token');

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userRes = await fetch(`/api/admin/users/${userId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (userRes.ok) {
        const userData = await userRes.json();
        if (userData.user) {
          setUser(userData.user);
        } else {
          setLoading(false);
          return;
        }
      } else if (userRes.status === 404) {
        setLoading(false);
        return;
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
      const ordersRes = await fetch(`/api/admin/users/${userId}/orders`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const ordersData = await ordersRes.json();
      setUserOrders(ordersData.orders || []);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      const transRes = await fetch(`/api/admin/users/${userId}/transactions`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const transData = await transRes.json();
      setUserTransactions(transData.transactions || []);
    } catch (error) {
      console.error('Load user data error:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  const handleTopup = async () => {
    const amount = parseFloat(topupAmount);
    if (!amount || amount <= 0) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
      return;
    }

    setTopupLoading(true);
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/admin/users/${userId}/topup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ amount }),
      });

      const data = await response.json();
      if (response.ok && data.success) {
        alert(`–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount} –ö–æ–π–Ω–æ–≤`);
        setShowTopupModal(false);
        setTopupAmount('');
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        loadUserData();
      } else {
        alert(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞');
      }
    } catch (error) {
      console.error('Topup error:', error);
      alert('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞');
    } finally {
      setTopupLoading(false);
    }
  };

  if (loading) {
    return (
      <main className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <Loader className="w-12 h-12 text-[#ffd700] animate-spin" />
      </main>
    );
  }

  if (!isAdmin) {
    return null;
  }

  if (!user) {
    return (
      <main className="min-h-screen bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <header className="bg-black/30 border-b border-white/10">
          <div className="container mx-auto px-4 py-4 flex justify-between items-center">
            <div className="flex items-center gap-4">
              <Link href="/admin" className="text-[#a8d8ea] hover:text-white transition-colors">
                <ArrowLeft className="w-5 h-5" />
              </Link>
              <div className="flex items-center gap-2">
                <Shield className="w-6 h-6 text-[#ffd700]" />
                <h1 className="text-xl font-bold text-white">–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
              </div>
            </div>
          </div>
        </header>
        <div className="container mx-auto px-4 py-8">
          <div className="card-festive rounded-3xl p-6 text-center">
            <p className="text-[#a8d8ea] text-lg">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
            <p className="text-[#a8d8ea]/60 mt-2">
              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {userId} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—ã–ª —É–¥–∞–ª–µ–Ω
            </p>
          </div>
        </div>
      </main>
    );
  }

  return (
    <main className="min-h-screen bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –•–µ–¥–µ—Ä */}
      <header className="bg-black/30 border-b border-white/10">
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-4">
            <Link href="/admin" className="text-[#a8d8ea] hover:text-white transition-colors">
              <ArrowLeft className="w-5 h-5" />
            </Link>
            <div className="flex items-center gap-2">
              <Shield className="w-6 h-6 text-[#ffd700]" />
              <h1 className="text-xl font-bold text-white">–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="container mx-auto px-4 py-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="card-festive rounded-3xl p-6"
        >
          <div className="flex justify-between items-center mb-6">
            <div>
              <h2 className="text-2xl font-bold text-white">{user.nickname}</h2>
              <p className="text-[#a8d8ea]/60">{user.email}</p>
            </div>
            <button
              onClick={() => setShowTopupModal(true)}
              className="btn-magic px-4 py-2 rounded-xl text-white flex items-center gap-2"
            >
              <Plus className="w-5 h-5" />
              –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
            </button>
          </div>

          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
          <div className="grid md:grid-cols-3 gap-4 mb-6">
            <div className="glass-dark p-4 rounded-xl">
              <p className="text-[#a8d8ea]/60 text-sm">–ò–º—è</p>
              <p className="text-white">
                {user.first_name} {user.last_name}
              </p>
            </div>
            <div className="glass-dark p-4 rounded-xl">
              <p className="text-[#a8d8ea]/60 text-sm">–ë–∞–ª–∞–Ω—Å</p>
              <p className="text-[#ffd700] font-bold text-xl">{user.balance} –ö–æ–π–Ω–æ–≤</p>
            </div>
            <div className="glass-dark p-4 rounded-xl">
              <p className="text-[#a8d8ea]/60 text-sm">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
              <p className="text-white">{formatDate(user.created_at)}</p>
            </div>
          </div>

          {/* –ó–∞–∫–∞–∑—ã */}
          <div className="mb-6">
            <h3 className="text-lg font-bold text-white mb-3 flex items-center gap-2">
              <History className="w-5 h-5" />
              –ó–∞–∫–∞–∑—ã ({userOrders.length})
            </h3>
            {userOrders.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-[#a8d8ea]/60 text-left text-sm border-b border-white/10">
                      <th className="pb-2 pr-4">–ù–æ–º–µ—Ä</th>
                      <th className="pb-2 pr-4">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                      <th className="pb-2 pr-4">–°—Ç–∞—Ç—É—Å</th>
                      <th className="pb-2">–î–∞—Ç–∞</th>
                    </tr>
                  </thead>
                  <tbody>
                    {userOrders.map((order) => (
                      <tr key={order.id} className="border-b border-white/5">
                        <td className="py-3 pr-4 text-[#ffd700] font-mono text-sm">
                          {order.order_number}
                        </td>
                        <td className="py-3 pr-4 text-white">{order.service_name}</td>
                        <td className="py-3 pr-4 text-[#a8d8ea]">{order.status}</td>
                        <td className="py-3 text-[#a8d8ea]/60">{formatDate(order.created_at)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <p className="text-[#a8d8ea]/60">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>
            )}
          </div>

          {/* –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ */}
          <div>
            <h3 className="text-lg font-bold text-white mb-3 flex items-center gap-2">
              <Coins className="w-5 h-5" />
              –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π ({userTransactions.length})
            </h3>
            {userTransactions.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-[#a8d8ea]/60 text-left text-sm border-b border-white/10">
                      <th className="pb-2 pr-4">–°—É–º–º–∞</th>
                      <th className="pb-2 pr-4">–°—Ç–∞—Ç—É—Å</th>
                      <th className="pb-2">–î–∞—Ç–∞</th>
                    </tr>
                  </thead>
                  <tbody>
                    {userTransactions.map((t) => (
                      <tr key={t.id} className="border-b border-white/5">
                        <td className="py-3 pr-4 text-green-400 font-bold">+{t.amount} –ö–æ–π–Ω–æ–≤</td>
                        <td className="py-3 pr-4 text-[#a8d8ea]">{t.status}</td>
                        <td className="py-3 text-[#a8d8ea]/60">{formatDate(t.created_at)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <p className="text-[#a8d8ea]/60">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π –Ω–µ—Ç</p>
            )}
          </div>
        </motion.div>
      </div>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ */}
      {showTopupModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="card-festive rounded-3xl p-6 max-w-md w-full"
          >
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold text-white">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
              <button
                onClick={() => setShowTopupModal(false)}
                className="text-[#a8d8ea]/60 hover:text-white transition-colors"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="mb-4">
              <label className="block text-[#a8d8ea] text-sm mb-2">–°—É–º–º–∞ (–ö–æ–π–Ω–æ–≤)</label>
              <input
                type="number"
                value={topupAmount}
                onChange={(e) => setTopupAmount(e.target.value)}
                min="1"
                step="1"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff]"
              />
            </div>

            <div className="flex gap-3">
              <button
                onClick={handleTopup}
                disabled={topupLoading || !topupAmount}
                className="btn-magic flex-1 px-4 py-3 rounded-xl text-white flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {topupLoading ? (
                  <Loader className="w-5 h-5 animate-spin" />
                ) : (
                  <>
                    <Save className="w-5 h-5" />
                    –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                  </>
                )}
              </button>
              <button
                onClick={() => setShowTopupModal(false)}
                className="glass px-4 py-3 rounded-xl text-[#a8d8ea] hover:bg-white/10 transition-colors"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </motion.div>
        </div>
      )}
    </main>
  );
}



================================================================================
–§–ê–ô–õ 3/69: app\api\admin\check\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\check\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    return NextResponse.json({ success: true, isAdmin: true });
  } catch (error) {
    console.error('Admin check error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 4/69: app\api\admin\cleanup-videos\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\cleanup-videos\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { VIDEO_STORAGE_PATH } from '@/lib/config';
import { ensureDbInitialized, getExpiredOrders, clearExpiredVideo } from '@/lib/db';
import fs from 'fs';
import path from 'path';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –∑–∞–∫–∞–∑—ã
    const expiredOrders = await getExpiredOrders();

    let deletedCount = 0;
    let errors: string[] = [];

    for (const order of expiredOrders) {
      try {
        // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –≤–∏–¥–µ–æ –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (order.video_url && order.video_url.startsWith('/api/videos/stream/')) {
          const relativePath = order.video_url.replace('/api/videos/stream/', '');
          const filePath = path.join(VIDEO_STORAGE_PATH, relativePath);

          if (fs.existsSync(filePath)) {
            try {
              fs.unlinkSync(filePath);
              console.log(`üóëÔ∏è Deleted expired video file: ${filePath}`);
            } catch (fileError) {
              console.error(`Error deleting file ${filePath}:`, fileError);
              errors.push(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${order.id}`);
            }
          }
        }

        // –û—á–∏—â–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î
        await clearExpiredVideo(order.id);
        deletedCount++;
      } catch (error) {
        console.error(`Error processing order ${order.id}:`, error);
        errors.push(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞ ${order.id}`);
      }
    }

    return NextResponse.json({
      success: true,
      deletedCount,
      totalExpired: expiredOrders.length,
      errors: errors.length > 0 ? errors : undefined,
      message: `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∏—Å—Ç–µ–∫—à–∏—Ö –≤–∏–¥–µ–æ`,
    });
  } catch (error) {
    console.error('Cleanup videos error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤–∏–¥–µ–æ' }, { status: 500 });
  }
}

// GET –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏—Å—Ç–µ–∫—à–∏—Ö –≤–∏–¥–µ–æ
export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const expiredOrders = await getExpiredOrders();

    return NextResponse.json({
      success: true,
      expiredCount: expiredOrders.length,
      expiredOrders: expiredOrders.map((o) => ({
        id: o.id,
        expiresAt: o.video_expires_at,
      })),
    });
  } catch (error) {
    console.error('Get expired videos error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 5/69: app\api\admin\init\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\init\route.ts
================================================================================

import { hashPassword } from '@/lib/auth';
import { createUser, ensureDbInitialized, getUserByEmail } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

// –î–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏–∑ —Å–∫—Ä–∏–ø—Ç–∞)
const SYSTEM_ADMIN = {
  email: 'system@gmail.com',
  password: 'I8378HVGDSKAHGFIO473IEUWH@UKGHLFDHLKZ;O;L;',
  nickname: 'System Admin',
  firstName: 'System',
  lastName: 'Administrator',
};

/**
 * POST /api/admin/init
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
 * –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ - –Ω–µ —Å–æ–∑–¥–∞—Å—Ç –¥—É–±–ª–∏–∫–∞—Ç)
 */
export async function POST(request: NextRequest) {
  try {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
    await ensureDbInitialized();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const existingUser = await getUserByEmail(SYSTEM_ADMIN.email);

    if (existingUser) {
      return NextResponse.json({
        success: true,
        message: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
        email: existingUser.email,
        id: existingUser.id,
      });
    }

    // –•–µ—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å
    const hashedPassword = await hashPassword(SYSTEM_ADMIN.password);

    // –°–æ–∑–¥–∞—ë–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const userId = await createUser(
      SYSTEM_ADMIN.email,
      hashedPassword,
      SYSTEM_ADMIN.nickname,
      SYSTEM_ADMIN.firstName,
      SYSTEM_ADMIN.lastName
    );

    return NextResponse.json({
      success: true,
      message: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!',
      user: {
        id: userId,
        email: SYSTEM_ADMIN.email,
        nickname: SYSTEM_ADMIN.nickname,
      },
      credentials: {
        email: SYSTEM_ADMIN.email,
        password: SYSTEM_ADMIN.password,
      },
    });
  } catch (error) {
    console.error('Admin init error:', error);
    return NextResponse.json(
      {
        error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}

/**
 * GET /api/admin/init
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
 */
export async function GET() {
  try {
    await ensureDbInitialized();

    const existingUser = await getUserByEmail(SYSTEM_ADMIN.email);

    if (existingUser) {
      return NextResponse.json({
        exists: true,
        email: existingUser.email,
        id: existingUser.id,
        nickname: existingUser.nickname,
      });
    }

    return NextResponse.json({
      exists: false,
      message: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ POST –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.',
    });
  } catch (error) {
    console.error('Admin check error:', error);
    return NextResponse.json(
      {
        error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}



================================================================================
–§–ê–ô–õ 6/69: app\api\admin\invoices\[invoiceId]\complete\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\invoices\[invoiceId]\complete\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import {
  completeBalanceTransaction,
  ensureDbInitialized,
  getBalanceTransactionByInvoiceId,
  updateUserBalance,
} from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ invoiceId: string }> }
) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { invoiceId } = await params;

    // –ù–∞—Ö–æ–¥–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ invoice_id
    const transaction = await getBalanceTransactionByInvoiceId(invoiceId);

    if (!transaction) {
      return NextResponse.json({ error: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' }, { status: 404 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
    if (transaction.status === 'completed') {
      return NextResponse.json({
        success: true,
        message: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞',
        transaction
      });
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    const coinsToAdd = transaction.amount;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    await completeBalanceTransaction(transaction.id);

    // –ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await updateUserBalance(transaction.user_id, coinsToAdd);

    console.log(
      `Manual payment completion: user ${transaction.user_id}, amount ${coinsToAdd} Coins, invoice ${invoiceId}`
    );

    return NextResponse.json({
      success: true,
      message: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞',
      transaction: {
        ...transaction,
        status: 'completed',
      }
    });
  } catch (error) {
    console.error('Complete invoice error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 7/69: app\api\admin\invoices\check-status\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\invoices\check-status\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { BITBANKER_API_KEY, BITBANKER_API_URL, isAdmin } from '@/lib/config';
import {
  completeBalanceTransaction,
  ensureDbInitialized,
  getAllTransactionsAdmin,
  getBalanceTransactionByInvoiceId,
  updateUserBalance,
} from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ pending –∏–Ω–≤–æ–π—Å—ã
    const pendingInvoices = await getAllTransactionsAdmin(undefined, undefined, 'pending');

    if (pendingInvoices.length === 0) {
      return NextResponse.json({ success: true, message: '–ù–µ—Ç –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤', processed: 0 });
    }

    let processedCount = 0;
    const errors: string[] = [];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ Bitbanker API
    for (const invoice of pendingInvoices) {
      if (!invoice.invoice_id) continue;

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–Ω–≤–æ–π—Å–∞ —á–µ—Ä–µ–∑ Bitbanker API
        if (BITBANKER_API_KEY) {
          const response = await fetch(`${BITBANKER_API_URL}/invoices/${invoice.invoice_id}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'X-API-KEY': BITBANKER_API_KEY,
            },
          });

          if (response.ok) {
            const data = await response.json();

            // –ï—Å–ª–∏ –∏–Ω–≤–æ–π—Å –æ–ø–ª–∞—á–µ–Ω
            if (data.result === 'success' && data.payed === true) {
              const transaction = await getBalanceTransactionByInvoiceId(invoice.invoice_id);

              if (transaction && transaction.status !== 'completed') {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                await completeBalanceTransaction(transaction.id);

                // –ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await updateUserBalance(transaction.user_id, transaction.amount);

                processedCount++;
                console.log(`‚úÖ Invoice ${invoice.invoice_id} marked as paid and processed`);
              }
            }
          }
        }
      } catch (error) {
        console.error(`Error checking invoice ${invoice.invoice_id}:`, error);
        errors.push(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–≤–æ–π—Å–∞ ${invoice.invoice_id}`);
      }
    }

    return NextResponse.json({
      success: true,
      processed: processedCount,
      total: pendingInvoices.length,
      errors: errors.length > 0 ? errors : undefined,
    });
  } catch (error) {
    console.error('Check invoices status error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–≤–æ–π—Å–æ–≤' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 8/69: app\api\admin\invoices\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\invoices\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getAllTransactionsAdmin } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { searchParams } = new URL(request.url);
    const startDate = searchParams.get('startDate') || undefined;
    const endDate = searchParams.get('endDate') || undefined;
    const status = (searchParams.get('status') as 'all' | 'completed' | 'pending') || 'all';
    const nickname = searchParams.get('nickname') || undefined;

    const invoices = await getAllTransactionsAdmin(startDate, endDate, status, nickname);

    return NextResponse.json({ success: true, invoices });
  } catch (error) {
    console.error('Get invoices error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–æ–≤' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 9/69: app\api\admin\reset-universal\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\reset-universal\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getDb, get, run } from '@/lib/db';
import fs from 'fs';
import path from 'path';
import { NextRequest, NextResponse } from 'next/server';

// POST /api/admin/reset-universal - —Å–±—Ä–æ—Å–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { videoType } = await request.json();

    if (!videoType || !['intro', 'outro'].includes(videoType)) {
      return NextResponse.json({ error: '–£–∫–∞–∂–∏—Ç–µ videoType: intro –∏–ª–∏ outro' }, { status: 400 });
    }

    const db = await getDb();

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    const current = await get(db, 'SELECT * FROM universal_videos WHERE video_type = ?', [
      videoType,
    ]);

    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
    await run(db, 'DELETE FROM universal_videos WHERE video_type = ?', [videoType]);

    db.close();

    console.log(`Universal video ${videoType} reset. Previous state:`, current);

    return NextResponse.json({
      success: true,
      message: `${videoType} —Å–±—Ä–æ—à–µ–Ω. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞.`,
      previousState: current,
    });
  } catch (error) {
    console.error('Error resetting universal video:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ' }, { status: 500 });
  }
}

// GET /api/admin/reset-universal - –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ
export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const db = await getDb();

    const intro = await get(db, 'SELECT * FROM universal_videos WHERE video_type = ?', ['intro']);
    const outro = await get(db, 'SELECT * FROM universal_videos WHERE video_type = ?', ['outro']);

    db.close();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
    const VIDEOS_DIR = path.join(process.cwd(), 'public', 'videos');
    const introFileExists = fs.existsSync(path.join(VIDEOS_DIR, 'intro.mp4'));
    const outroFileExists = fs.existsSync(path.join(VIDEOS_DIR, 'outro.mp4'));

    return NextResponse.json({
      success: true,
      intro: {
        db: intro,
        fileExists: introFileExists,
      },
      outro: {
        db: outro,
        fileExists: outroFileExists,
      },
    });
  } catch (error) {
    console.error('Error getting universal video status:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 10/69: app\api\admin\settings\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\settings\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getSetting, setSetting } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const emailVerificationRequired = await getSetting('email_verification_required');
    const userAgreementText = await getSetting('user_agreement_text');
    const contactsText = await getSetting('contacts_text');

    return NextResponse.json({
      success: true,
      settings: {
        email_verification_required: emailVerificationRequired,
        user_agreement_text: userAgreementText,
        contacts_text: contactsText,
      },
    });
  } catch (error) {
    console.error('Get settings error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫' }, { status: 500 });
  }
}

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { emailVerificationRequired, agreementText, contactsText } = await request.json();

    await setSetting('email_verification_required', emailVerificationRequired ? '1' : '0');
    await setSetting('user_agreement_text', agreementText || '');
    await setSetting('contacts_text', contactsText || '');

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Save settings error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 11/69: app\api\admin\users\[userId]\orders\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\users\[userId]\orders\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getUserOrdersAdmin } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ userId: string }> }
) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { userId } = await params;
    const orders = await getUserOrdersAdmin(Number(userId));

    return NextResponse.json({ success: true, orders });
  } catch (error) {
    console.error('Get user orders error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 12/69: app\api\admin\users\[userId]\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\users\[userId]\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getUserById } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ userId: string }> }
) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { userId } = await params;
    const userData = await getUserById(Number(userId));

    if (!userData) {
      return NextResponse.json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
    const { getDb, all } = await import('@/lib/db');
    const dbInstance = await getDb();
    const ordersCount = await all(
      dbInstance,
      'SELECT COUNT(*) as count FROM orders WHERE user_id = ?',
      [userId]
    );
    dbInstance.close();

    return NextResponse.json({
      success: true,
      user: {
        ...userData,
        orders_count: ordersCount[0]?.count || 0,
      },
    });
  } catch (error) {
    console.error('Get user error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 13/69: app\api\admin\users\[userId]\topup\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\users\[userId]\topup\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getUserById, updateUserBalance, createBalanceTransaction } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ userId: string }> }
) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { userId } = await params;
    const { amount } = await request.json();

    if (!amount || typeof amount !== 'number' || amount <= 0) {
      return NextResponse.json({ error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞' }, { status: 400 });
    }

    const targetUser = await getUserById(Number(userId));
    if (!targetUser) {
      return NextResponse.json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    await createBalanceTransaction(
      Number(userId),
      amount,
      'admin_topup',
      undefined,
      undefined
    );

    // –ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å
    await updateUserBalance(Number(userId), amount);

    // –û—Ç–º–µ—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
    const { getDb, all, run } = await import('@/lib/db');
    const db = await getDb();
    const transactions = await all(
      db,
      'SELECT id FROM balance_transactions WHERE user_id = ? AND type = ? AND status = ? ORDER BY id DESC LIMIT 1',
      [Number(userId), 'admin_topup', 'pending']
    );
    if (transactions.length > 0) {
      await run(
        db,
        'UPDATE balance_transactions SET status = ?, completed_at = CURRENT_TIMESTAMP WHERE id = ?',
        ['completed', transactions[0].id]
      );
    }
    db.close();

    return NextResponse.json({ success: true, message: '–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω' });
  } catch (error) {
    console.error('Topup error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 14/69: app\api\admin\users\[userId]\transactions\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\users\[userId]\transactions\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getUserTransactionsAdmin } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ userId: string }> }
) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { userId } = await params;
    const transactions = await getUserTransactionsAdmin(Number(userId));

    return NextResponse.json({ success: true, transactions });
  } catch (error) {
    console.error('Get user transactions error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 15/69: app\api\admin\users\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\users\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, getAllUsers } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const users = await getAllUsers();

    return NextResponse.json({ success: true, users });
  } catch (error) {
    console.error('Get users error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 16/69: app\api\admin\users\search\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\admin\users\search\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { isAdmin } from '@/lib/config';
import { ensureDbInitialized, searchUsers } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    if (!isAdmin(user.email)) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    const { searchParams } = new URL(request.url);
    const query = searchParams.get('q') || '';

    const users = await searchUsers(query);

    return NextResponse.json({ success: true, users });
  } catch (error) {
    console.error('Search users error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 17/69: app\api\auth\forgot-password\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\auth\forgot-password\route.ts
================================================================================

import { ensureDbInitialized, getUserByEmail } from '@/lib/db';
import { createResetToken } from '@/lib/reset-tokens';
import { NextRequest, NextResponse } from 'next/server';

/**
 * POST /api/auth/forgot-password
 * –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
 */
export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const { email } = await request.json();

    if (!email) {
      return NextResponse.json({ error: 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' }, { status: 400 });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email' }, { status: 400 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await getUserByEmail(email);

    // –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ —Å–æ–æ–±—â–∞–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    if (user) {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω —Å–±—Ä–æ—Å–∞
      const resetToken = createResetToken(user.email);

      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∞ email
      // –î–ª—è MVP –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–±—Ä–∞—Ç—å!)
      console.log(`[FORGOT PASSWORD] Reset token for ${email}: ${resetToken}`);
      console.log(
        `[FORGOT PASSWORD] Reset URL: ${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/reset-password?token=${resetToken}`
      );

      // TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å email —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
      // await sendResetPasswordEmail(user.email, resetToken);
    }

    // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    return NextResponse.json({
      success: true,
      message:
        '–ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º email —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–æ—á—Ç—É.',
    });
  } catch (error) {
    console.error('Forgot password error:', error);
    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞' },
      { status: 500 }
    );
  }
}

/**
 * GET /api/auth/forgot-password?token=...
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ —Å–±—Ä–æ—Å–∞
 */
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const token = searchParams.get('token');

    if (!token) {
      return NextResponse.json({ error: '–¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' }, { status: 400 });
    }

    const { getResetTokenData } = await import('@/lib/reset-tokens');
    const tokenData = getResetTokenData(token);

    if (!tokenData) {
      return NextResponse.json({ error: '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫' }, { status: 404 });
    }

    return NextResponse.json({
      valid: true,
      email: tokenData.email,
    });
  } catch (error) {
    console.error('Check reset token error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 18/69: app\api\auth\login\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\auth\login\route.ts
================================================================================

import { comparePassword, generateToken } from '@/lib/auth';
import { ensureDbInitialized, getUserByEmail } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const { email, password } = await request.json();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!email || !password) {
      return NextResponse.json({ error: 'Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' }, { status: 400 });
    }

    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await getUserByEmail(email);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' }, { status: 401 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    const isValid = await comparePassword(password, user.password);
    if (!isValid) {
      return NextResponse.json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' }, { status: 401 });
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
    const token = generateToken({
      id: user.id,
      email: user.email,
      name: user.nickname || user.first_name,
    });

    return NextResponse.json({
      success: true,
      token,
      user: {
        id: user.id,
        email: user.email,
        nickname: user.nickname,
        firstName: user.first_name,
        lastName: user.last_name,
        balance: user.balance || 0,
      },
    });
  } catch (error) {
    console.error('Login error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 19/69: app\api\auth\register\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\auth\register\route.ts
================================================================================

import { generateToken, hashPassword } from '@/lib/auth';
import { createUser, ensureDbInitialized, getUserByEmail } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const { email, password, nickname, firstName, lastName, agreedToTerms } = await request.json();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!email || !password || !nickname || !firstName || !lastName) {
      return NextResponse.json({ error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' }, { status: 400 });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email' }, { status: 400 });
    }

    if (!agreedToTerms) {
      return NextResponse.json(
        { error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è' },
        { status: 400 }
      );
    }

    if (password.length < 6) {
      return NextResponse.json(
        { error: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const existingUser = await getUserByEmail(email);
    if (existingUser) {
      return NextResponse.json(
        { error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' },
        { status: 409 }
      );
    }

    // –•–µ—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å
    const hashedPassword = await hashPassword(password);

    // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userId = await createUser(email, hashedPassword, nickname, firstName, lastName);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
    const token = generateToken({
      id: userId as number,
      email,
      name: nickname,
    });

    return NextResponse.json({
      success: true,
      token,
      user: {
        id: userId,
        email,
        nickname,
        firstName,
        lastName,
      },
    });
  } catch (error) {
    console.error('Registration error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 20/69: app\api\auth\reset-password\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\auth\reset-password\route.ts
================================================================================

import { ensureDbInitialized, getUserByEmail, getDb, run } from '@/lib/db';
import { hashPassword } from '@/lib/auth';
import { getResetTokenData, deleteResetToken } from '@/lib/reset-tokens';
import { NextRequest, NextResponse } from 'next/server';

/**
 * POST /api/auth/reset-password
 * –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É
 */
export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const { token, newPassword } = await request.json();

    if (!token || !newPassword) {
      return NextResponse.json(
        { error: '–¢–æ–∫–µ–Ω –∏ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' },
        { status: 400 }
      );
    }

    if (newPassword.length < 6) {
      return NextResponse.json(
        { error: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    const tokenData = getResetTokenData(token);

    if (!tokenData) {
      return NextResponse.json({ error: '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫' }, { status: 404 });
    }

    if (tokenData.expiresAt < Date.now()) {
      deleteResetToken(token);
      return NextResponse.json({ error: '–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫' }, { status: 410 });
    }

    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await getUserByEmail(tokenData.email);
    if (!user) {
      deleteResetToken(token);
      return NextResponse.json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    // –•–µ—à–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
    const hashedPassword = await hashPassword(newPassword);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –≤ –ë–î
    const db = await getDb();
    await run(db, 'UPDATE users SET password = ? WHERE id = ?', [hashedPassword, user.id]);
    db.close();

    // –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
    deleteResetToken(token);

    return NextResponse.json({
      success: true,
      message: '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω',
    });
  } catch (error) {
    console.error('Reset password error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 21/69: app\api\check-status\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\check-status\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import {
  ensureDbInitialized,
  getOrderByTaskId,
  getUniversalVideo,
  setUniversalVideo,
  updateOrderStatus,
  updateUniversalVideoStatus,
} from '@/lib/db';
import {
  checkTaskStatus,
  concatenateVideos,
  deleteOrderPhotos,
  deletePersonalVideo,
  downloadVideo,
  generateIntroVideo,
  generateOutroVideo,
  getFFmpegLockStatus,
  getFinalVideoPath,
  getPersonalVideoPath,
  getUniversalVideoPaths,
  saveIntroVideo,
  saveOutroVideo,
} from '@/lib/video-generator';
import fs from 'fs';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const taskId = searchParams.get('taskId');

    if (!taskId) {
      return NextResponse.json({ error: 'taskId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' }, { status: 400 });
    }

    console.log(`üîé [CHECK-STATUS] taskId: ${taskId}, userId: ${user.id}`);

    const order = await getOrderByTaskId(Number(taskId));
    if (!order) {
      return NextResponse.json({ error: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    if (order.user_id !== user.id) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç–∏
    const universalPaths = getUniversalVideoPaths();
    const finalPath = getFinalVideoPath(order.id);
    const personalPath = getPersonalVideoPath(order.id);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å FFmpeg –ª–æ–∫–∞
    const lockStatus = getFFmpegLockStatus();
    if (lockStatus.globalLocked) {
      console.log(`üîí FFmpeg is busy (lock age: ${Math.round((lockStatus.lockAge || 0) / 1000)}s)`);
    }

    // –ï–°–õ–ò –§–ò–ù–ê–õ–¨–ù–û–ï –í–ò–î–ï–û –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    if (fs.existsSync(finalPath)) {
      const finalSize = fs.statSync(finalPath).size;
      // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ~5MB –¥–ª—è 45 —Å–µ–∫ –≤–∏–¥–µ–æ
      if (finalSize > 5 * 1024 * 1024) {
        const finalVideoUrl = `/api/videos/stream/final/final_${order.id}.mp4`;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (order.status !== 'completed' || order.video_url !== finalVideoUrl) {
          await updateOrderStatus(Number(taskId), 'completed', '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ', finalVideoUrl);
        }

        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        deleteOrderPhotos(order.id);
        deletePersonalVideo(order.id);

        return NextResponse.json({
          success: true,
          taskId: Number(taskId),
          status: 2,
          statusDescription: 'completed',
          videoUrl: finalVideoUrl,
          isCompleted: true,
          isFailed: false,
        });
      } else {
        // –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π - —É–¥–∞–ª—è–µ–º
        console.log(`‚ö†Ô∏è Final video too small (${finalSize} bytes), removing`);
        try {
          fs.unlinkSync(finalPath);
        } catch {}
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ
    let introReady = universalPaths.introExists;
    let outroReady = universalPaths.outroExists;

    const introDb = await getUniversalVideo('intro');
    const outroDb = await getUniversalVideo('outro');

    const delay = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

    const customerId = `web_user_${user.id}`;

    // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ intro/outro –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    // –¢–∞–∫–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'pending' (–∑–∞—Å—Ç—Ä—è–ª)
    if (!introReady && (!introDb || introDb.status === 'failed' || introDb.status === 'pending')) {
      console.log('Auto-starting intro generation...');
      const result = await generateIntroVideo(customerId);
      if (result.success && result.taskId) {
        await setUniversalVideo('intro', result.taskId, 'processing');
      }
    } else if (!introReady && introDb?.task_id && introDb.status === 'processing') {
      await delay(500);
      const introStatus = await checkTaskStatus(introDb.task_id);
      if (introStatus.status === 'completed' && introStatus.videoUrl) {
        const saved = await saveIntroVideo(introStatus.videoUrl);
        if (saved) {
          introReady = true;
          await updateUniversalVideoStatus('intro', 'completed', introStatus.videoUrl);
        }
      } else if (introStatus.status?.includes('rejected')) {
        await updateUniversalVideoStatus('intro', 'failed');
      }
    }

    if (!outroReady && (!outroDb || outroDb.status === 'failed' || outroDb.status === 'pending')) {
      console.log('Auto-starting outro generation...');
      const result = await generateOutroVideo(customerId);
      if (result.success && result.taskId) {
        await setUniversalVideo('outro', result.taskId, 'processing');
      }
    } else if (!outroReady && outroDb?.task_id && outroDb.status === 'processing') {
      await delay(1000);
      const outroStatus = await checkTaskStatus(outroDb.task_id);
      if (outroStatus.status === 'completed' && outroStatus.videoUrl) {
        const saved = await saveOutroVideo(outroStatus.videoUrl);
        if (saved) {
          outroReady = true;
          await updateUniversalVideoStatus('outro', 'completed', outroStatus.videoUrl);
        }
      } else if (outroStatus.status?.includes('rejected')) {
        await updateUniversalVideoStatus('outro', 'failed');
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–æ–∫
    introReady = fs.existsSync(universalPaths.intro);
    outroReady = fs.existsSync(universalPaths.outro);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
    await delay(1500);
    const personalStatus = await checkTaskStatus(Number(taskId));

    if (!personalStatus.success) {
      if (!introReady || !outroReady) {
        return NextResponse.json({
          success: true,
          taskId: Number(taskId),
          status: 1,
          statusDescription: 'processing',
          isCompleted: false,
          isFailed: false,
          message: '–û–∂–∏–¥–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ...',
          introReady,
          outroReady,
          personalReady: false,
        });
      }
      return NextResponse.json({ error: personalStatus.error }, { status: 400 });
    }

    const isPersonalCompleted = personalStatus.status === 'completed';
    const personalVideoUrl = personalStatus.videoUrl;

    // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
    if (isPersonalCompleted && personalVideoUrl) {
      // –°–∫–∞—á–∏–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
      if (!fs.existsSync(personalPath)) {
        console.log('üì• Downloading personal video...');
        const downloaded = await downloadVideo(personalVideoUrl, personalPath);
        if (!downloaded) {
          return NextResponse.json({
            success: true,
            taskId: Number(taskId),
            status: 1,
            statusDescription: 'processing',
            isCompleted: false,
            isFailed: false,
            message: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ, –ø–æ–≤—Ç–æ—Ä—è–µ–º...',
          });
        }
      }

      // –í—Å–µ —á–∞—Å—Ç–∏ –≥–æ—Ç–æ–≤—ã - —Å–∫–ª–µ–∏–≤–∞–µ–º
      if (introReady && outroReady && fs.existsSync(personalPath)) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ FFmpeg
        const lockStatus = getFFmpegLockStatus();
        if (lockStatus.globalLocked && (lockStatus.lockAge || 0) < 9 * 60 * 1000) {
          // FFmpeg –∑–∞–Ω—è—Ç –º–µ–Ω–µ–µ 9 –º–∏–Ω—É—Ç - –∂–¥—ë–º
          console.log('‚è≥ FFmpeg busy, will retry...');
          return NextResponse.json({
            success: true,
            taskId: Number(taskId),
            status: 1,
            statusDescription: 'processing',
            isCompleted: false,
            isFailed: false,
            message: '–ò–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–æ–≥–æ –≤–∏–¥–µ–æ, –∂–¥—ë–º...',
            introReady,
            outroReady,
            personalReady: true,
            ffmpegBusy: true,
          });
        }

        console.log('üîÑ Starting video concatenation...');

        const success = await concatenateVideos(
          universalPaths.intro,
          personalPath,
          universalPaths.outro,
          finalPath
        );

        if (success && fs.existsSync(finalPath)) {
          const finalVideoUrl = `/api/videos/stream/final/final_${order.id}.mp4`;
          await updateOrderStatus(Number(taskId), 'completed', '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ', finalVideoUrl);

          deleteOrderPhotos(order.id);
          deletePersonalVideo(order.id);

          return NextResponse.json({
            success: true,
            taskId: Number(taskId),
            status: 2,
            statusDescription: 'completed',
            videoUrl: finalVideoUrl,
            isCompleted: true,
            isFailed: false,
            message: '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!',
          });
        } else {
          // –°–∫–ª–µ–π–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∫–∞–∫ fallback
          console.log('‚ö†Ô∏è Concatenation failed, using personal video as fallback');

          const localPersonalUrl = `/api/videos/stream/personal/personal_${order.id}.mp4`;
          await updateOrderStatus(
            Number(taskId),
            'completed',
            '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ (–±–µ–∑ —Å–∫–ª–µ–π–∫–∏)',
            localPersonalUrl
          );

          deleteOrderPhotos(order.id);

          return NextResponse.json({
            success: true,
            taskId: Number(taskId),
            status: 2,
            statusDescription: 'completed',
            videoUrl: localPersonalUrl,
            isCompleted: true,
            isFailed: false,
            message: '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!',
            fallback: true,
          });
        }
      } else {
        // –ñ–¥—ë–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ
        return NextResponse.json({
          success: true,
          taskId: Number(taskId),
          status: 1,
          statusDescription: 'processing',
          isCompleted: false,
          isFailed: false,
          message: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ, –æ–∂–∏–¥–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏...',
          introReady,
          outroReady,
          personalReady: true,
        });
      }
    }

    // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –µ—â—ë –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
    const isFailed = personalStatus.status?.includes('rejected');

    if (isFailed) {
      await updateOrderStatus(
        Number(taskId),
        personalStatus.status || 'rejected',
        personalStatus.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏',
        undefined,
        personalStatus.error
      );
    }

    return NextResponse.json({
      success: true,
      taskId: Number(taskId),
      status:
        personalStatus.status === 'in queue'
          ? 0
          : personalStatus.status === 'in progress'
          ? 1
          : personalStatus.status === 'completed'
          ? 2
          : isFailed
          ? 3
          : 4,
      statusDescription: personalStatus.status,
      isCompleted: false,
      isFailed,
      error: personalStatus.error,
      introReady,
      outroReady,
      personalReady: false,
    });
  } catch (error) {
    console.error('Error checking status:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 22/69: app\api\generate-video\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\generate-video\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { BASE_URL, SERVICE_COST, VIDEO_STORAGE_PATH } from '@/lib/config';
import {
  createOrder,
  ensureDbInitialized,
  getUniversalVideo,
  getUserBalance,
  setUniversalVideo,
  updateOrderTaskId,
  updateUserBalance,
} from '@/lib/db';
import {
  checkUniversalVideosExist,
  createVideoTask,
  generateIntroVideo,
  generateOutroVideo,
  generatePersonalPrompt,
} from '@/lib/video-generator';
import fs from 'fs';
import { NextRequest, NextResponse } from 'next/server';
import path from 'path';

interface RequestBody {
  childName: string;
  childAge?: number;
  photo1: string;
  photo1Comment: string;
  photo2: string;
  photo2Comment: string;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function saveBase64Image(
  base64Data: string,
  orderId: number,
  photoNumber: 1 | 2
): Promise<string | null> {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç base64
    const base64Match = base64Data.match(/^data:image\/(\w+);base64,(.+)$/);
    if (!base64Match) {
      console.error('Invalid base64 image format');
      return null;
    }

    const [, imageType, base64String] = base64Match;
    const imageBuffer = Buffer.from(base64String, 'base64');

    // –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imagesDir = path.join(VIDEO_STORAGE_PATH, 'images');
    if (!fs.existsSync(imagesDir)) {
      fs.mkdirSync(imagesDir, { recursive: true });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const fileName = `photo${photoNumber}_order${orderId}.${
      imageType === 'jpeg' ? 'jpg' : imageType
    }`;
    const filePath = path.join(imagesDir, fileName);
    fs.writeFileSync(filePath, imageBuffer);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL
    const publicUrl = `${BASE_URL}/api/images/${fileName}`;
    return publicUrl;
  } catch (error) {
    console.error('Error saving base64 image:', error);
    return null;
  }
}

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' }, { status: 401 });
    }

    const body: RequestBody = await request.json();
    const { childName, childAge, photo1, photo1Comment, photo2, photo2Comment } = body;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!childName || !photo1Comment || !photo2Comment) {
      return NextResponse.json(
        { error: '–ò–º—è —Ä–µ–±—ë–Ω–∫–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ñ–æ—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' },
        { status: 400 }
      );
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if (childAge !== undefined && (childAge < 1 || childAge > 18)) {
      return NextResponse.json(
        { error: '–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 18 –ª–µ—Ç' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–Ω—ã–π)
    if (SERVICE_COST > 0) {
      const balance = await getUserBalance(user.id);
      if (balance < SERVICE_COST) {
        return NextResponse.json(
          { error: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è: ${SERVICE_COST} –ö–æ–π–Ω–æ–≤` },
          { status: 400 }
        );
      }
    }

    // –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –≤ –ë–î
    const { orderId, orderNumber } = await createOrder(
      user.id,
      childName,
      photo1 || '',
      photo1Comment,
      photo2 || '',
      photo2Comment,
      SERVICE_COST
    );

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–æ–ª—É—á–∞–µ–º –∏—Ö URL
    let photo1Url: string | null = null;
    let photo2Url: string | null = null;

    if (photo1) {
      photo1Url = await saveBase64Image(photo1, orderId, 1);
      if (!photo1Url) {
        console.warn('Failed to save photo1, continuing without image reference');
      }
    }

    if (photo2) {
      photo2Url = await saveBase64Image(photo2, orderId, 2);
      if (!photo2Url) {
        console.warn('Failed to save photo2, continuing without image reference');
      }
    }

    // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ (–µ—Å–ª–∏ –ø–ª–∞—Ç–Ω–æ)
    if (SERVICE_COST > 0) {
      await updateUserBalance(user.id, -SERVICE_COST);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ (—Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ)
    const universalVideos = checkUniversalVideosExist();
    console.log('=== Universal Videos Check ===');
    console.log('Universal videos exist:', universalVideos);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ
    let introDb = await getUniversalVideo('intro');
    let outroDb = await getUniversalVideo('outro');

    console.log('=== Universal Videos DB Status ===');
    console.log('introDb:', introDb);
    console.log('outroDb:', outroDb);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ –∏ —Å–±—Ä–æ—Å –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ check-status
    // –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ –ë–î

    const customerId = `web_user_${user.id}`;
    const tasksToGenerate: { type: string; taskId?: number }[] = [];

    // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    const generateTasks: Promise<void>[] = [];

    // –ï—Å–ª–∏ –Ω–µ—Ç intro —Ñ–∞–π–ª–∞ –∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
    // –¢–∞–∫–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'pending' (–∑–∞—Å—Ç—Ä—è–ª) –∏–ª–∏ 'failed'
    const shouldGenerateIntro = !universalVideos.intro && (!introDb || introDb.status === 'failed' || introDb.status === 'pending');
    console.log(
      'Should generate intro?',
      shouldGenerateIntro,
      '(file exists:',
      universalVideos.intro,
      ', db status:',
      introDb?.status,
      ')'
    );

    if (shouldGenerateIntro) {
      console.log('Intro video not found, will generate...');
      generateTasks.push(
        generateIntroVideo(customerId).then(async (result) => {
          if (result.success && result.taskId) {
            tasksToGenerate.push({ type: 'intro', taskId: result.taskId });
            await setUniversalVideo('intro', result.taskId, 'processing');
          } else {
            console.error('Failed to create intro task:', result.error);
          }
        })
      );
    } else if (introDb && introDb.task_id && introDb.status === 'processing') {
      // –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
      tasksToGenerate.push({ type: 'intro', taskId: introDb.task_id });
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç outro —Ñ–∞–π–ª–∞ –∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
    // –¢–∞–∫–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'pending' (–∑–∞—Å—Ç—Ä—è–ª) –∏–ª–∏ 'failed'
    const shouldGenerateOutro = !universalVideos.outro && (!outroDb || outroDb.status === 'failed' || outroDb.status === 'pending');
    console.log(
      'Should generate outro?',
      shouldGenerateOutro,
      '(file exists:',
      universalVideos.outro,
      ', db status:',
      outroDb?.status,
      ')'
    );

    if (shouldGenerateOutro) {
      console.log('Outro video not found, will generate...');
      generateTasks.push(
        generateOutroVideo(customerId).then(async (result) => {
          if (result.success && result.taskId) {
            tasksToGenerate.push({ type: 'outro', taskId: result.taskId });
            await setUniversalVideo('outro', result.taskId, 'processing');
          } else {
            console.error('Failed to create outro task:', result.error);
          }
        })
      );
    } else if (outroDb && outroDb.task_id) {
      // –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
      tasksToGenerate.push({ type: 'outro', taskId: outroDb.task_id });
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ —Å —É—á—ë—Ç–æ–º –≤–æ–∑—Ä–∞—Å—Ç–∞
    const personalPrompt = generatePersonalPrompt(
      childName,
      photo1Comment,
      photo2Comment,
      childAge
    );
    console.log('Creating personal video task for:', childName, childAge ? `age ${childAge}` : '');
    console.log('Personal prompt:', personalPrompt);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
    // Sora API –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å image_url –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –ø–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—É
    let personalTaskId: number | undefined;
    generateTasks.push(
      createVideoTask(personalPrompt, customerId, {
        imageUrl: photo1Url || undefined, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å
        resolution: 720, // –ò—Å–ø–æ–ª—å–∑—É–µ–º 720p –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (fallback –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        dimensions: '16:9',
        duration: 20, // –£–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        effectId: 0,
      }).then((result) => {
        if (result.success && result.taskId) {
          tasksToGenerate.push({ type: 'personal', taskId: result.taskId });
          personalTaskId = result.taskId;
        } else {
          console.error('Failed to create personal task:', result.error);
        }
      })
    );

    // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    await Promise.all(generateTasks);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ
    if (!personalTaskId) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      if (SERVICE_COST > 0) {
        await updateUserBalance(user.id, SERVICE_COST);
      }
      return NextResponse.json({ error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ' }, { status: 500 });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ —Å –æ—Å–Ω–æ–≤–Ω—ã–º task_id (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π)
    await updateOrderTaskId(orderId, personalTaskId);

    // –ù–∞—Ö–æ–¥–∏–º taskId –¥–ª—è intro –∏ outro
    const introTask = tasksToGenerate.find((t) => t.type === 'intro');
    const outroTask = tasksToGenerate.find((t) => t.type === 'outro');

    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
    const newBalance = await getUserBalance(user.id);

    return NextResponse.json({
      success: true,
      taskId: personalTaskId,
      introTaskId: introTask?.taskId,
      outroTaskId: outroTask?.taskId,
      orderNumber: orderNumber,
      orderId: orderId,
      message: `–ó–∞–∫–∞–∑ #${orderNumber} —Å–æ–∑–¥–∞–Ω! –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –Ω–∞—á–∞–ª–∞—Å—å...`,
      childName: childName,
      tasks: tasksToGenerate,
      universalVideosExist: universalVideos,
      balance: newBalance,
    });
  } catch (error) {
    console.error('Error in generate-video:', error);
    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' },
      { status: 500 }
    );
  }
}



================================================================================
–§–ê–ô–õ 23/69: app\api\images\[...path]\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\images\[...path]\route.ts
================================================================================

import { VIDEO_STORAGE_PATH } from '@/lib/config';
import fs from 'fs';
import path from 'path';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ path: string[] }> }
) {
  try {
    const { path: pathArray } = await params;
    const fileName = pathArray.join('/');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—É—Ç–∏ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º path traversal)
    if (fileName.includes('..') || fileName.includes('/') || fileName.includes('\\')) {
      return NextResponse.json({ error: 'Invalid file path' }, { status: 400 });
    }

    const filePath = path.join(VIDEO_STORAGE_PATH, 'images', fileName);

    if (!fs.existsSync(filePath)) {
      return NextResponse.json({ error: 'Image not found' }, { status: 404 });
    }

    const fileBuffer = fs.readFileSync(filePath);
    const fileStats = fs.statSync(filePath);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
    const ext = path.extname(fileName).toLowerCase();
    let contentType = 'image/jpeg';
    if (ext === '.png') {
      contentType = 'image/png';
    } else if (ext === '.jpg' || ext === '.jpeg') {
      contentType = 'image/jpeg';
    }

    return new NextResponse(fileBuffer, {
      headers: {
        'Content-Type': contentType,
        'Content-Length': fileStats.size.toString(),
        'Cache-Control': 'public, max-age=31536000, immutable',
      },
    });
  } catch (error) {
    console.error('Error serving image:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 24/69: app\api\init\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\init\route.ts
================================================================================

import { validateConfig } from '@/lib/config';
import { initDb } from '@/lib/db';
import { NextResponse } from 'next/server';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î —á–µ—Ä–µ–∑ API endpoint (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
export async function GET() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    const configValidation = validateConfig();

    await initDb();

    return NextResponse.json({
      success: true,
      message: 'Database initialized',
      configValid: configValidation.valid,
      configWarnings: configValidation.errors,
    });
  } catch (error) {
    console.error('Init error:', error);
    return NextResponse.json({ error: 'Failed to initialize database' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 25/69: app\api\payment\callback\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\payment\callback\route.ts
================================================================================

import { BITBANKER_API_KEY, BITBANKER_SECRET } from '@/lib/config';
import {
  completeBalanceTransaction,
  ensureDbInitialized,
  getBalanceTransactionByInvoiceId,
  updateUserBalance,
} from '@/lib/db';
import crypto from 'crypto';
import { NextRequest, NextResponse } from 'next/server';

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –æ—Ç Bitbanker (sign_2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API Secret)
function verifyBitbankerWebhookSign(
  currency: string,
  amount: string | number,
  header: string,
  description: string,
  receivedSign: string,
  secret: string
): boolean {
  if (!receivedSign || !secret) {
    return false;
  }

  try {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º amount –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    const amountStr =
      typeof amount === 'number'
        ? Number.isInteger(amount)
          ? amount.toString()
          : amount.toFixed(2)
        : amount;
    const signData = `${currency}${amountStr}${header}${description}`;
    const expectedSign = crypto.createHmac('sha256', secret).update(signData).digest('hex');

    return crypto.timingSafeEqual(Buffer.from(receivedSign), Buffer.from(expectedSign));
  } catch (error) {
    console.error('Signature verification error:', error);
    return false;
  }
}

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ sign (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç API Key)
function verifyBitbankerSign(
  currency: string,
  amount: string | number,
  header: string,
  description: string,
  receivedSign: string,
  apiKey: string
): boolean {
  if (!receivedSign || !apiKey) {
    return false;
  }

  try {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º amount –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    const amountStr =
      typeof amount === 'number'
        ? Number.isInteger(amount)
          ? amount.toString()
          : amount.toFixed(2)
        : amount;
    const signData = `${currency}${amountStr}${header}${description}`;
    const expectedSign = crypto.createHmac('sha256', apiKey).update(signData).digest('hex');

    return crypto.timingSafeEqual(Buffer.from(receivedSign), Buffer.from(expectedSign));
  } catch (error) {
    console.error('Signature verification error:', error);
    return false;
  }
}

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const bodyText = await request.text();
    console.log('Bitbanker webhook received:', bodyText);

    let body: {
      payed?: boolean;
      id?: string;
      amount?: number;
      currency?: string;
      payed_amount?: number;
      transactions?: Array<{
        tx_id: string;
        amount: number;
        fee: number;
        currency: string;
      }>;
      data?: {
        user_id?: number;
        user_email?: string;
        coins?: number;
      };
      sign?: string;
      sign_2?: string;
    };

    try {
      body = JSON.parse(bodyText);
    } catch {
      console.error('Invalid JSON in webhook:', bodyText);
      return NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });
    }

    console.log('Parsed webhook body:', body);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–ª–∞—Ç—ë–∂ –æ–ø–ª–∞—á–µ–Ω
    if (!body.payed) {
      console.log(`Payment ${body.id} not yet paid - skipping`);
      return NextResponse.json({ success: true, message: 'Payment not completed yet' });
    }

    const invoiceId = body.id;
    if (!invoiceId) {
      console.error('Missing invoice id in webhook');
      return NextResponse.json({ error: 'Missing invoice id' }, { status: 400 });
    }

    // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (–µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
    // Bitbanker –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç sign (hmac —Å api_key) –∏ sign_2 (hmac —Å api_secret)
    if (BITBANKER_SECRET && body.sign_2) {
      // –î–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞
      // –ù–æ –º—ã –∏—Ö –Ω–µ –∑–Ω–∞–µ–º –∏–∑ –≤–µ–±—Ö—É–∫–∞, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –¥–∞–Ω–Ω—ã–µ –∏–∑ body
      // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞
      console.log('Verifying webhook signature...');

      // –ü–æ–ø—Ä–æ–±—É–µ–º –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ data –µ—Å–ª–∏ –µ—Å—Ç—å
      // –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞!
      if (body.data?.coins) {
        const currency = body.currency || 'USDT';
        const amount = body.data.coins;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ header –∏ description —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞
        const header = 'Prizmabox';
        const description =
          "Payment for online platform services (top-up of the user's internal account balance)";

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º amount —Ç–∞–∫ –∂–µ –∫–∞–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
        const amountStr = Number.isInteger(amount) ? amount.toString() : amount.toFixed(2);

        const isValidSign2 = verifyBitbankerWebhookSign(
          currency,
          amountStr,
          header,
          description,
          body.sign_2,
          BITBANKER_SECRET
        );

        const isValidSign =
          body.sign && BITBANKER_API_KEY
            ? verifyBitbankerSign(
                currency,
                amountStr,
                header,
                description,
                body.sign,
                BITBANKER_API_KEY
              )
            : false;

        if (!isValidSign2 && !isValidSign) {
          console.warn(
            'Webhook signature verification failed, but proceeding (may need adjustment)'
          );
          console.log('Verification details:', {
            currency,
            amount: amountStr,
            header,
            description,
            hasSign: !!body.sign,
            hasSign2: !!body.sign_2,
          });
          // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É:
          // return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
        } else {
          console.log('Webhook signature verified successfully');
        }
      }
    }

    // –ù–∞—Ö–æ–¥–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ invoice_id
    const transaction = await getBalanceTransactionByInvoiceId(invoiceId);

    if (!transaction) {
      console.error(`Transaction not found for invoice: ${invoiceId}`);
      return NextResponse.json({ error: 'Transaction not found' }, { status: 404 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
    if (transaction.status === 'completed') {
      console.log(`Transaction ${invoiceId} already processed`);
      return NextResponse.json({ success: true, message: 'Already processed' });
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–º–º—É –∏–∑ –Ω–∞—à–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–æ–Ω–∞ –≤ –ö–æ–π–Ω–∞—Ö)
    const coinsToAdd = transaction.amount;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    await completeBalanceTransaction(transaction.id);

    // –ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await updateUserBalance(transaction.user_id, coinsToAdd);

    console.log(
      `Payment completed: user ${transaction.user_id}, amount ${coinsToAdd} Coins, invoice ${invoiceId}`
    );

    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –∫—Ä–∏–ø—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
    if (body.transactions && body.transactions.length > 0) {
      console.log('Crypto transactions:', body.transactions);
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Payment callback error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// GET –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
export async function GET() {
  return NextResponse.json({
    status: 'Bitbanker callback endpoint active',
    timestamp: new Date().toISOString(),
    note: 'POST webhook data here for payment notifications',
  });
}



================================================================================
–§–ê–ô–õ 26/69: app\api\payment\create\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\payment\create\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import {
  BASE_URL,
  BITBANKER_API_KEY,
  BITBANKER_API_URL,
  BITBANKER_PAYMENT_CURRENCIES,
  BITBANKER_SECRET,
  BitbankerCurrency,
} from '@/lib/config';
import { createBalanceTransaction, ensureDbInitialized, getUserById } from '@/lib/db';
import crypto from 'crypto';
import { NextRequest, NextResponse } from 'next/server';

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è Bitbanker API
// sign = hmac(currency + amount + header + description, api_key, sha256)
// –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Bitbanker, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è api_key, –∞ –Ω–µ api_secret
function generateBitbankerSign(
  currency: string,
  amount: number,
  header: string,
  description: string,
  apiKey: string
): string {
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º amount –≤ —Å—Ç—Ä–æ–∫—É –±–µ–∑ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤, –µ—Å–ª–∏ —ç—Ç–æ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
  const amountStr = Number.isInteger(amount) ? amount.toString() : amount.toFixed(2);
  const signData = `${currency}${amountStr}${header}${description}`;
  return crypto.createHmac('sha256', apiKey).update(signData).digest('hex');
}

export async function POST(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    const body = await request.json();
    const { amount, paymentCurrency } = body;

    if (!amount || amount < 1) {
      return NextResponse.json({ error: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: 1 –ö–æ–π–Ω' }, { status: 400 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏
    const userData = await getUserById(user.id);
    const payerName = userData
      ? `${userData.first_name} ${userData.last_name}`.trim() || user.email
      : user.email;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - —Ç–æ–ª—å–∫–æ BTC –∏ USDT
    let selectedCurrencies: BitbankerCurrency[] = ['BTC', 'USDT'];
    if (paymentCurrency) {
      if (Array.isArray(paymentCurrency)) {
        selectedCurrencies = paymentCurrency.filter((c: string) =>
          ['BTC', 'USDT'].includes(c)
        ) as BitbankerCurrency[];
      } else if (['BTC', 'USDT'].includes(paymentCurrency)) {
        selectedCurrencies = [paymentCurrency as BitbankerCurrency];
      }
    }

    if (selectedCurrencies.length === 0) {
      selectedCurrencies = ['BTC', 'USDT'];
    }

    let invoiceId: string;
    let invoiceUrl: string;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞ Bitbanker
    if (BITBANKER_API_KEY && BITBANKER_SECRET) {
      try {
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å—á—ë—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
        const currency = 'USDT'; // –í–∞–ª—é—Ç–∞ —Å—á—ë—Ç–∞
        const header = 'Prizmabox';
        const description =
          "Payment for online platform services (top-up of the user's internal account balance)";

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å
        // –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Bitbanker, –ø–æ–¥–ø–∏—Å—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫:
        // hmac(currency + amount + header + description, api_key, sha256)
        const sign = generateBitbankerSign(
          currency,
          amount,
          header,
          description,
          BITBANKER_API_KEY
        );

        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –ª–æ–≥–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
        const amountStr = Number.isInteger(amount) ? amount.toString() : amount.toFixed(2);
        const signData = `${currency}${amountStr}${header}${description}`;
        console.log('Sign data string:', signData);
        console.log('Using BITBANKER_API_KEY for signing');
        console.log('Sign (first 20 chars):', sign.substring(0, 20));

        const payload = {
          payment_currencies: selectedCurrencies, // ["BTC", "USDT"]
          currency: currency, // "USDT"
          amount: amount,
          description: description, // "Payment for online platform services (top-up of the user's internal account balance)"
          language: 'en', // "en"
          header: header, // "Prizmabox"
          payer: payerName, // –ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
          is_convert_payments: false, // false
          data: {
            user_id: user.id,
            user_email: user.email,
            coins: amount,
          },
          sign: sign, // hmac(currency + amount + header + description, api_secret, sha256)
        };

        console.log('Creating Bitbanker invoice:', {
          ...payload,
          sign: sign.substring(0, 10) + '...',
        });

        const bitbankerResponse = await fetch(`${BITBANKER_API_URL}/invoices`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-KEY': BITBANKER_API_KEY,
          },
          body: JSON.stringify(payload),
        });

        const responseText = await bitbankerResponse.text();
        console.log('Bitbanker response:', responseText);

        let invoiceData;
        try {
          invoiceData = JSON.parse(responseText);
        } catch {
          console.error('Failed to parse Bitbanker response:', responseText);
          throw new Error('Invalid Bitbanker response');
        }

        if (invoiceData.result !== 'success') {
          console.error('Bitbanker API error:', invoiceData);
          const errorMessage = invoiceData.message || invoiceData.code || 'Bitbanker API error';
          throw new Error(errorMessage);
        }

        invoiceId = invoiceData.id;
        invoiceUrl = invoiceData.link;

        if (!invoiceId || !invoiceUrl) {
          console.error('Missing invoice data:', invoiceData);
          throw new Error('Invalid Bitbanker response - missing id or link');
        }

        console.log('Invoice created:', { invoiceId, invoiceUrl });
      } catch (apiError) {
        console.error('Bitbanker integration error:', apiError);
        return NextResponse.json(
          {
            error:
              '–û—à–∏–±–∫–∞ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ. ' +
              (apiError instanceof Error ? apiError.message : ''),
          },
          { status: 503 }
        );
      }
    } else {
      // –î–µ–º–æ-—Ä–µ–∂–∏–º (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
      console.warn('BITBANKER_API_KEY not configured - using demo mode');
      invoiceId = `demo_${Date.now()}_${user.id}`;
      invoiceUrl = `${BASE_URL}/profile?payment=demo&amount=${amount}&invoice=${invoiceId}`;
    }

    // –°–æ–∑–¥–∞—ë–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ë–î
    await createBalanceTransaction(user.id, amount, 'topup', invoiceId, invoiceUrl);

    return NextResponse.json({
      success: true,
      invoiceId,
      invoiceUrl,
      amount,
      paymentCurrencies: selectedCurrencies,
      message: '–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',
      isDemoMode: !BITBANKER_API_KEY,
    });
  } catch (error) {
    console.error('Create payment error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞' }, { status: 500 });
  }
}

// GET –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
export async function GET() {
  return NextResponse.json({
    currencies: BITBANKER_PAYMENT_CURRENCIES,
    defaultCurrency: 'USDT',
  });
}



================================================================================
–§–ê–ô–õ 27/69: app\api\settings\agreement\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\settings\agreement\route.ts
================================================================================

import { ensureDbInitialized, getSetting } from '@/lib/db';
import { NextResponse } from 'next/server';

export async function GET() {
  try {
    await ensureDbInitialized();
    const text = await getSetting('user_agreement_text');
    return NextResponse.json({ text: text || '–¢–µ–∫—Å—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' });
  } catch (error) {
    console.error('Get agreement error:', error);
    return NextResponse.json({ text: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è' });
  }
}



================================================================================
–§–ê–ô–õ 28/69: app\api\settings\contacts\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\settings\contacts\route.ts
================================================================================

import { ensureDbInitialized, getSetting } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const contactsText = await getSetting('contacts_text');

    return NextResponse.json({
      success: true,
      contacts_text: contactsText || '',
    });
  } catch (error) {
    console.error('Get contacts error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 29/69: app\api\settings\support\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\settings\support\route.ts
================================================================================

import { ensureDbInitialized, getSetting } from '@/lib/db';
import { SUPPORT_EMAIL, SUPPORT_TELEGRAM } from '@/lib/config';
import { NextResponse } from 'next/server';

export async function GET() {
  try {
    await ensureDbInitialized();

    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–¥–º–∏–Ω–∫–∏
    const contactsText = await getSetting('contacts_text');

    // –ü–∞—Ä—Å–∏–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ HTML –µ—Å–ª–∏ –µ—Å—Ç—å
    let telegram = SUPPORT_TELEGRAM;
    let email = SUPPORT_EMAIL;

    if (contactsText) {
      // –ò—â–µ–º Telegram —Å—Å—ã–ª–∫—É
      const telegramMatch = contactsText.match(/https?:\/\/t\.me\/([a-zA-Z0-9_]+)/i) ||
                           contactsText.match(/@([a-zA-Z0-9_]+)/i);
      if (telegramMatch) {
        telegram = `@${telegramMatch[1]}`;
      }

      // –ò—â–µ–º email
      const emailMatch = contactsText.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i);
      if (emailMatch) {
        email = emailMatch[1];
      }
    }

    return NextResponse.json({
      telegram,
      email,
    });
  } catch (error) {
    console.error('Get support contacts error:', error);
    // Fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    return NextResponse.json({
      telegram: SUPPORT_TELEGRAM,
      email: SUPPORT_EMAIL,
    });
  }
}



================================================================================
–§–ê–ô–õ 30/69: app\api\user\balance\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\user\balance\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { ensureDbInitialized, getUserBalance } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    const balance = await getUserBalance(user.id);

    return NextResponse.json({
      success: true,
      balance,
    });
  } catch (error) {
    console.error('Get balance error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 31/69: app\api\user\transactions\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\user\transactions\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { ensureDbInitialized, getUserBalanceTransactions } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    const transactions = await getUserBalanceTransactions(user.id);

    return NextResponse.json({
      success: true,
      transactions,
    });
  } catch (error) {
    console.error('Get transactions error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 32/69: app\api\videos\download\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\videos\download\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { VIDEO_STORAGE_PATH } from '@/lib/config';
import { ensureDbInitialized, getOrderByTaskId } from '@/lib/db';
import fs from 'fs';
import { NextRequest, NextResponse } from 'next/server';
import path from 'path';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const taskId = searchParams.get('taskId');

    if (!taskId) {
      return NextResponse.json({ error: 'taskId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' }, { status: 400 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const order = await getOrderByTaskId(Number(taskId));
    if (!order) {
      return NextResponse.json({ error: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    if (order.user_id !== user.id) {
      return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω' }, { status: 403 });
    }

    if (!order.video_url) {
      return NextResponse.json({ error: '–í–∏–¥–µ–æ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–æ' }, { status: 400 });
    }

    try {
      let videoBuffer: Buffer;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø URL
      if (order.video_url.startsWith('/api/videos/stream/')) {
        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª - —á–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é —Å –¥–∏—Å–∫–∞
        // URL —Ñ–æ—Ä–º–∞—Ç: /api/videos/stream/final/final_2.mp4 -> /data/videos/final/final_2.mp4
        const relativePath = order.video_url.replace('/api/videos/stream/', '');
        const filePath = path.join(VIDEO_STORAGE_PATH, relativePath);

        console.log('Reading local video file:', filePath);

        if (!fs.existsSync(filePath)) {
          console.error('Video file not found:', filePath);
          return NextResponse.json({ error: '–§–∞–π–ª –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
        }

        videoBuffer = fs.readFileSync(filePath);
      } else if (order.video_url.startsWith('http')) {
        // –í–Ω–µ—à–Ω–∏–π URL - —Å–∫–∞—á–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ fetch
        console.log('Fetching external video:', order.video_url);
        const videoResponse = await fetch(order.video_url);
        if (!videoResponse.ok) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ');
        }
        videoBuffer = Buffer.from(await videoResponse.arrayBuffer());
      } else {
        // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –±–µ–∑ /api/videos/stream/ - –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        const filePath = path.join(VIDEO_STORAGE_PATH, order.video_url.replace(/^\/videos\//, ''));
        console.log('Trying relative path:', filePath);

        if (fs.existsSync(filePath)) {
          videoBuffer = fs.readFileSync(filePath);
        } else {
          return NextResponse.json({ error: '–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' }, { status: 404 });
        }
      }

      // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
      const safeFileName = order.child_name
        .replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å\s-]/g, '')
        .replace(/\s+/g, '-')
        .substring(0, 50);

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º RFC 5987 –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
      const encodedFileName = encodeURIComponent(`pozdravlenie-${safeFileName}.mp4`);
      const rfc5987FileName = `filename*=UTF-8''${encodedFileName}`;
      const asciiFileName = `pozdravlenie-${safeFileName}.mp4`.replace(/[^\x00-\x7F]/g, '');

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Buffer –≤ Uint8Array –¥–ª—è NextResponse (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∫–∞–∫ BodyInit)
      const uint8Array = new Uint8Array(videoBuffer);

      return new NextResponse(uint8Array, {
        headers: {
          'Content-Type': 'video/mp4',
          'Content-Disposition': `attachment; filename="${asciiFileName}"; ${rfc5987FileName}`,
          'Content-Length': videoBuffer.byteLength.toString(),
        },
      });
    } catch (error) {
      console.error('Video download error:', error);
      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
      return NextResponse.json({
        success: true,
        videoUrl: order.video_url,
        directDownload: true,
      });
    }
  } catch (error) {
    console.error('Download route error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 33/69: app\api\videos\example\random\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\videos\example\random\route.ts
================================================================================

import { ensureDbInitialized, getCompletedOrdersWithFinalVideos } from '@/lib/db';
import { getFinalVideoPath } from '@/lib/video-generator';
import fs from 'fs';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –≤–∏–¥–µ–æ
    const orders = await getCompletedOrdersWithFinalVideos();

    if (orders.length === 0) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –≤–∏–¥–µ–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
      const response = NextResponse.json({
        success: true,
        videoUrl: '/api/videos/stream/final/final_2.mp4',
        fallback: true,
      });
      response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=600');
      return response;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–∫–∞–∑—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ñ–∞–π–ª —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const validOrders = orders.filter((order) => {
      const finalPath = getFinalVideoPath(order.id);
      if (!fs.existsSync(finalPath)) {
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ - –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 1MB (–Ω–µ –ø—É—Å—Ç–æ–π/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π)
      try {
        const stats = fs.statSync(finalPath);
        return stats.size > 1024 * 1024; // –ú–∏–Ω–∏–º—É–º 1MB
      } catch {
        return false;
      }
    });

    if (validOrders.length === 0) {
      // –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –≤–∏–¥–µ–æ –Ω–µ –ø—Ä–æ—à–ª–æ –ø—Ä–æ–≤–µ—Ä–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
      const response = NextResponse.json({
        success: true,
        videoUrl: '/api/videos/stream/final/final_2.mp4',
        fallback: true,
      });
      response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=600');
      return response;
    }

    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∏–¥–µ–æ
    const randomOrder = validOrders[Math.floor(Math.random() * validOrders.length)];

    const response = NextResponse.json({
      success: true,
      videoUrl: `/api/videos/stream/final/final_${randomOrder.id}.mp4`,
      orderId: randomOrder.id,
    });

    // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ –≤–∏–¥–µ–æ –º–µ–Ω—è—é—Ç—Å—è –Ω–µ —á–∞—Å—Ç–æ)
    response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=600');

    return response;
  } catch (error) {
    console.error('Error getting random example video:', error);
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    const response = NextResponse.json({
      success: true,
      videoUrl: '/api/videos/stream/final/final_2.mp4',
      fallback: true,
      error: 'Failed to get random video',
    });
    response.headers.set('Cache-Control', 'public, s-maxage=60');
    return response;
  }
}



================================================================================
–§–ê–ô–õ 34/69: app\api\videos\history\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\videos\history\route.ts
================================================================================

import { getUserFromRequest } from '@/lib/auth';
import { ensureDbInitialized, getUserOrders } from '@/lib/db';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    await ensureDbInitialized();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const user = getUserFromRequest(request);
    if (!user) {
      return NextResponse.json({ error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }, { status: 401 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
    const orders = await getUserOrders(user.id);

    return NextResponse.json({
      success: true,
      orders: orders.map((o) => ({
        id: o.id,
        orderNumber: o.order_number,
        serviceName: o.service_name,
        taskId: o.task_id,
        childName: o.child_name,
        videoUrl: o.video_url,
        status: o.status,
        statusDescription: o.status_description,
        createdAt: o.created_at,
        completedAt: o.completed_at,
      })),
    });
  } catch (error) {
    console.error('Get videos history error:', error);
    return NextResponse.json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 35/69: app\api\videos\stream\[...path]\route.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\api\videos\stream\[...path]\route.ts
================================================================================

import { VIDEO_STORAGE_PATH } from '@/lib/config';
import { ensureDbInitialized, getDb, get } from '@/lib/db';
import fs from 'fs';
import { NextRequest, NextResponse } from 'next/server';
import path from 'path';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ path: string[] }> }
) {
  try {
    // –û–∂–∏–¥–∞–µ–º params (–≤ Next.js 16 —ç—Ç–æ Promise)
    const resolvedParams = await params;
    // –°–æ–±–∏—Ä–∞–µ–º –ø—É—Ç—å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const filePath = resolvedParams.path.join('/');

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—É—Ç—å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    if (filePath.includes('..') || !filePath.match(/^[a-zA-Z0-9_/-]+\.mp4$/)) {
      console.log('Invalid video path:', filePath);
      return NextResponse.json({ error: 'Invalid path' }, { status: 400 });
    }

    // –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    const fullPath = path.join(VIDEO_STORAGE_PATH, filePath);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!fs.existsSync(fullPath)) {
      console.log('Video file not found:', fullPath);
      return NextResponse.json({ error: 'File not found' }, { status: 404 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ñ–∞–π–ª (–Ω–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è)
    const stats = fs.statSync(fullPath);
    if (!stats.isFile()) {
      return NextResponse.json({ error: 'Not a file' }, { status: 400 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ VIDEO_STORAGE_PATH (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
    const resolvedPath = path.resolve(fullPath);
    const resolvedStorage = path.resolve(VIDEO_STORAGE_PATH);
    if (!resolvedPath.startsWith(resolvedStorage)) {
      return NextResponse.json({ error: 'Access denied' }, { status: 403 });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤–∏–¥–µ–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è final –≤–∏–¥–µ–æ)
    if (filePath.startsWith('final/')) {
      await ensureDbInitialized();
      const orderIdMatch = filePath.match(/final_(\d+)\.mp4/);
      if (orderIdMatch) {
        const orderId = parseInt(orderIdMatch[1], 10);
        const db = await getDb();
        const order = await get(
          db,
          'SELECT video_expires_at FROM orders WHERE id = ?',
          [orderId]
        );
        db.close();

        if (order && order.video_expires_at) {
          const expiresAt = new Date(order.video_expires_at);
          if (expiresAt < new Date()) {
            // –í–∏–¥–µ–æ –∏—Å—Ç–µ–∫–ª–æ - —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 404
            try {
              fs.unlinkSync(fullPath);
              console.log(`üóëÔ∏è Deleted expired video: ${filePath}`);
            } catch (err) {
              console.error('Error deleting expired video:', err);
            }
            return NextResponse.json({ error: 'Video expired' }, { status: 410 });
          }
        }
      }
    }

    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
    const fileBuffer = fs.readFileSync(fullPath);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º Content-Type
    const ext = path.extname(fullPath).toLowerCase();
    const contentType = ext === '.mp4' ? 'video/mp4' : 'application/octet-stream';

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ETag –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    const etag = `"${stats.mtime.getTime()}-${stats.size}"`;
    const ifNoneMatch = request.headers.get('if-none-match');
    if (ifNoneMatch === etag) {
      return new NextResponse(null, { status: 304 });
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Range –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–∏–¥–µ–æ (–¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)
    const range = request.headers.get('range');
    if (range) {
      const parts = range.replace(/bytes=/, '').split('-');
      const start = parseInt(parts[0], 10);
      const end = parts[1] ? parseInt(parts[1], 10) : fileBuffer.length - 1;
      const chunkSize = end - start + 1;
      const chunk = fileBuffer.slice(start, end + 1);

      return new NextResponse(chunk, {
        status: 206,
        headers: {
          'Content-Range': `bytes ${start}-${end}/${fileBuffer.length}`,
          'Accept-Ranges': 'bytes',
          'Content-Length': chunkSize.toString(),
          'Content-Type': contentType,
          'Cache-Control': 'public, max-age=31536000, immutable',
          'ETag': etag,
        },
      });
    }

    // –û–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å —Ñ–∞–π–ª
    return new NextResponse(fileBuffer, {
      headers: {
        'Content-Type': contentType,
        'Content-Length': fileBuffer.length.toString(),
        'Accept-Ranges': 'bytes',
        'Cache-Control': 'public, max-age=31536000, immutable',
        'ETag': etag,
      },
    });
  } catch (error) {
    console.error('Video stream error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}



================================================================================
–§–ê–ô–õ 36/69: app\contacts\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\contacts\layout.tsx
================================================================================

import type { Metadata } from 'next';
import { BASE_URL } from '@/lib/config';

export const metadata: Metadata = {
  title: '–ö–æ–Ω—Ç–∞–∫—Ç—ã | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. Telegram, Email –∏ –¥—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã —Å–≤—è–∑–∏.',
  keywords: [
    '–∫–æ–Ω—Ç–∞–∫—Ç—ã',
    '–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
    '—Å–≤—è–∑–∞—Ç—å—Å—è',
    '–ø–æ–º–æ—â—å',
    '—Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    '–î–µ–¥ –ú–æ—Ä–æ–∑',
  ],
  openGraph: {
    title: '–ö–æ–Ω—Ç–∞–∫—Ç—ã | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description:
      '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞.',
    url: `${BASE_URL}/contacts`,
    type: 'website',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–ö–æ–Ω—Ç–∞–∫—Ç—ã - –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  alternates: {
    canonical: `${BASE_URL}/contacts`,
  },
  robots: {
    index: true,
    follow: true,
  },
};

export default function ContactsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



================================================================================
–§–ê–ô–õ 37/69: app\contacts\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\contacts\page.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { motion } from "framer-motion";
import Link from "next/link";
import { ArrowLeft, Mail, MessageCircle, Loader } from "lucide-react";

export default function ContactsPage() {
  const [contactsText, setContactsText] = useState<string>("");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch("/api/settings/contacts")
      .then((res) => res.json())
      .then((data) => {
        if (data.contacts_text) {
          setContactsText(data.contacts_text);
        }
      })
      .catch(() => {})
      .finally(() => setLoading(false));
  }, []);

  if (loading) {
    return (
      <main className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <Loader className="w-12 h-12 text-[#ffd700] animate-spin" />
      </main>
    );
  }

  return (
    <main className="min-h-screen bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –•–µ–¥–µ—Ä */}
      <header className="bg-black/30 border-b border-white/10">
        <div className="container mx-auto px-4 py-4 flex items-center gap-4">
          <Link
            href="/"
            className="text-[#a8d8ea] hover:text-white transition-colors"
          >
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex items-center gap-2">
            <MessageCircle className="w-6 h-6 text-[#ffd700]" />
            <h1 className="text-xl font-bold text-white">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h1>
          </div>
        </div>
      </header>

      <div className="container mx-auto px-4 py-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="card-festive rounded-3xl p-6"
        >
          <div
            className="prose prose-invert max-w-none text-[#f0f8ff]"
            dangerouslySetInnerHTML={{ __html: contactsText || "<p>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>" }}
          />
        </motion.div>
      </div>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 38/69: app\forgot-password\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\forgot-password\layout.tsx
================================================================================

import type { Metadata } from 'next';
import { BASE_URL } from '@/lib/config';

export const metadata: Metadata = {
  title: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É. –í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è.',
  keywords: [
    '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è',
    '–∑–∞–±—ã–ª –ø–∞—Ä–æ–ª—å',
    '—Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
  ],
  openGraph: {
    title: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π.',
    url: `${BASE_URL}/forgot-password`,
    type: 'website',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  alternates: {
    canonical: `${BASE_URL}/forgot-password`,
  },
  robots: {
    index: false,
    follow: false,
  },
};

export default function ForgotPasswordLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



================================================================================
–§–ê–ô–õ 39/69: app\forgot-password\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\forgot-password\page.tsx
================================================================================

'use client';

import { motion } from 'framer-motion';
import { ArrowLeft, Mail, Sparkles } from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

export default function ForgotPasswordPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setSuccess(false);

    if (!email) {
      setError('–í–≤–µ–¥–∏—Ç–µ email');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      setError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
      }

      setSuccess(true);
    } catch (err) {
      setError(err instanceof Error ? err.message : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    } finally {
      setLoading(false);
    }
  };

  return (
    <main className="min-h-screen relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {[...Array(30)].map((_, i) => (
          <div
            key={i}
            className="star"
            style={{
              left: `${(i * 3.3) % 100}%`,
              top: `${(i * 5) % 80}%`,
              animationDelay: `${i * 0.15}s`,
            }}
          />
        ))}
      </div>

      <div className="container mx-auto px-4 py-8 relative z-10">
        <Link
          href="/login"
          className="inline-flex items-center gap-2 text-[#a8d8ea] hover:text-white transition-colors mb-6"
        >
          <ArrowLeft className="w-5 h-5" />
          –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É
        </Link>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="max-w-md mx-auto"
        >
          <div className="card-festive rounded-3xl p-8">
            <div className="text-center mb-6">
              <motion.div
                animate={{ rotate: [0, 5, -5, 0] }}
                transition={{ duration: 2, repeat: Infinity }}
                className="inline-block mb-4"
              >
                <span className="text-6xl">üîê</span>
              </motion.div>
              <h1 className="text-3xl font-bold text-gradient font-display mb-2">
                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
              </h1>
              <p className="text-[#a8d8ea]/80">
                –í–≤–µ–¥–∏—Ç–µ email, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∏ –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é
                –ø–∞—Ä–æ–ª—è
              </p>
            </div>

            {success ? (
              <motion.div
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                className="text-center py-6"
              >
                <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
                  <Mail className="w-8 h-8 text-green-400" />
                </div>
                <h2 className="text-xl font-bold text-white mb-2">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É!</h2>
                <p className="text-[#a8d8ea] mb-6">
                  –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —Å email <strong className="text-white">{email}</strong> —Å—É—â–µ—Å—Ç–≤—É–µ—Ç,
                  –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è.
                </p>
                <Link
                  href="/login"
                  className="btn-magic px-6 py-3 rounded-xl text-white inline-flex items-center gap-2"
                >
                  –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É
                </Link>
              </motion.div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label className="block text-[#a8d8ea] mb-2 font-semibold">Email</label>
                  <div className="relative">
                    <Mail className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#a8d8ea]/60" />
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="your@email.com"
                      required
                      className="input-magic w-full pl-12 pr-5 py-4 rounded-xl text-[#f0f8ff]"
                    />
                  </div>
                </div>

                {error && (
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-200"
                  >
                    ‚ö†Ô∏è {error}
                  </motion.div>
                )}

                <motion.button
                  type="submit"
                  disabled={loading}
                  whileHover={{ scale: loading ? 1 : 1.02 }}
                  whileTap={{ scale: loading ? 1 : 0.98 }}
                  className="btn-magic w-full py-4 rounded-xl text-lg font-bold text-white flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? (
                    <>
                      <Sparkles className="w-5 h-5 animate-spin" />
                      <span>–û—Ç–ø—Ä–∞–≤–∫–∞...</span>
                    </>
                  ) : (
                    <>
                      <Mail className="w-5 h-5" />
                      <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</span>
                    </>
                  )}
                </motion.button>
              </form>
            )}

            <div className="mt-6 text-center">
              <p className="text-[#a8d8ea]/60 text-sm">
                –ü–æ–º–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å?{' '}
                <Link href="/login" className="text-[#ffd700] hover:underline">
                  –í–æ–π—Ç–∏
                </Link>
              </p>
            </div>
          </div>
        </motion.div>
      </div>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 40/69: app\globals.css
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\globals.css
================================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: #0c1929;
  --foreground: #e8f4fc;
  --primary: #c41e3a;
  --primary-light: #e74c3c;
  --secondary: #1a5f7a;
  --gold: #ffd700;
  --snow: #f0f8ff;
  --ice: #a8d8ea;
  --forest: #0d4f2b;
}

* {
  box-sizing: border-box;
}

body {
  background: linear-gradient(180deg, #0c1929 0%, #1a3a5c 50%, #0d2840 100%);
  color: var(--foreground);
  font-family: var(--font-nunito), sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 640px) {
  body {
    font-size: 14px;
  }

  /* –£–ª—É—á—à–∞–µ–º —Ç–∞—á-—Ç–∞—Ä–≥–µ—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  button, a, input, select, textarea {
    min-height: 44px;
    min-width: 44px;
  }

  /* –£–±–∏—Ä–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
  @media (hover: none) {
    .btn-magic:hover {
      transform: none;
    }
  }
}

/* –°–Ω–µ–∂–∏–Ω–∫–∏ */
@keyframes snowfall {
  0% {
    transform: translateY(-10vh) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(110vh) rotate(360deg);
    opacity: 0.3;
  }
}

@keyframes twinkle {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4),
                0 0 40px rgba(255, 215, 0, 0.2),
                0 0 60px rgba(255, 215, 0, 0.1);
  }
  50% {
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4),
                0 0 90px rgba(255, 215, 0, 0.2);
  }
}

@keyframes shimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}

.snowflake {
  position: fixed;
  top: -10vh;
  color: white;
  font-size: 1rem;
  pointer-events: none;
  animation: snowfall linear infinite;
  z-index: 1;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
}

.star {
  position: absolute;
  width: 4px;
  height: 4px;
  background: white;
  border-radius: 50%;
  animation: twinkle ease-in-out infinite;
}

/* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç */
.text-gradient {
  background: linear-gradient(135deg, #ffd700 0%, #ffed4a 50%, #ffd700 100%);
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 3s linear infinite;
}

/* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç */
.glass {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.glass-dark {
  background: rgba(12, 25, 41, 0.7);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* –ö–Ω–æ–ø–∫–∞ */
.btn-magic {
  background: linear-gradient(135deg, #c41e3a 0%, #e74c3c 50%, #c41e3a 100%);
  background-size: 200% 200%;
  border: 2px solid rgba(255, 215, 0, 0.5);
  transition: all 0.4s ease;
  position: relative;
  overflow: hidden;
}

.btn-magic::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.5s ease;
}

.btn-magic:hover::before {
  left: 100%;
}

.btn-magic:hover {
  background-position: right center;
  transform: translateY(-3px);
  box-shadow: 0 10px 40px rgba(196, 30, 58, 0.5),
              0 0 20px rgba(255, 215, 0, 0.3);
  border-color: rgba(255, 215, 0, 0.8);
}

.btn-magic:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* –ò–Ω–ø—É—Ç */
.input-magic {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(168, 216, 234, 0.3);
  transition: all 0.3s ease;
}

.input-magic:focus {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 215, 0, 0.6);
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.2),
              inset 0 0 20px rgba(255, 215, 0, 0.05);
  outline: none;
}

.input-magic::placeholder {
  color: rgba(232, 244, 252, 0.5);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è select –∏ option */
.input-magic option {
  background: #0c1929;
  color: #f0f8ff;
  padding: 10px;
}

.input-magic option:hover,
.input-magic option:checked,
.input-magic option:focus {
  background: rgba(196, 30, 58, 0.3);
  color: #ffd700;
}

select.input-magic {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffd700' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 3rem;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ */
.card-festive {
  background: linear-gradient(145deg, rgba(26, 58, 92, 0.6) 0%, rgba(12, 25, 41, 0.8) 100%);
  border: 1px solid rgba(255, 215, 0, 0.2);
  position: relative;
  overflow: hidden;
}

.card-festive::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, #ffd700, transparent);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
.loading-magic {
  position: relative;
}

.loading-magic::after {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: inherit;
  background: conic-gradient(from 0deg, transparent, #ffd700, #c41e3a, transparent);
  animation: spin 2s linear infinite;
  z-index: -1;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(12, 25, 41, 0.5);
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #c41e3a, #1a5f7a);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #e74c3c, #2980b9);
}

/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
.ornament {
  filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
}

.tree-glow {
  filter: drop-shadow(0 0 20px rgba(13, 79, 43, 0.8));
}



================================================================================
–§–ê–ô–õ 41/69: app\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\layout.tsx
================================================================================

import type { Metadata } from 'next';
import Script from 'next/script';
// import { Nunito, Marck_Script } from 'next/font/google';
import Footer from '@/components/Footer';
import { BASE_URL } from '@/lib/config';
import './globals.css';

// –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã Google Fonts –¥–ª—è —Å–±–æ—Ä–∫–∏ –≤ Docker
// const nunito = Nunito({
//   subsets: ['latin', 'cyrillic'],
//   weight: ['400', '600', '700', '800'],
//   variable: '--font-nunito',
//   display: 'swap',
// });

// const marckScript = Marck_Script({
//   subsets: ['latin', 'cyrillic'],
//   weight: ['400'],
//   variable: '--font-marck-script',
//   display: 'swap',
// });

const siteName = '–í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞';
// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è SEO (–¥–æ 160 —Å–∏–º–≤–æ–ª–æ–≤)
const siteDescription =
  '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞. AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –∏–º—è —Ä–µ–±—ë–Ω–∫–∞, –≤–∞—à–∏ —Ñ–æ—Ç–æ. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ!';
const siteUrl = BASE_URL;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: siteName,
  description: siteDescription,
  url: siteUrl,
  applicationCategory: 'MultimediaApplication',
  operatingSystem: 'Web',
  browserRequirements: 'Requires JavaScript. Requires HTML5.',
  softwareVersion: '1.0',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'RUB',
    availability: 'https://schema.org/InStock',
    priceValidUntil: '2026-12-31',
  },
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: '5',
    ratingCount: '1',
    bestRating: '5',
    worstRating: '1',
  },
  featureList: [
    '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è',
    '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ä–µ–±—ë–Ω–∫–∞',
    '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π',
    'AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é Sora 2',
    'HD –∫–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ',
  ],
  potentialAction: {
    '@type': 'UseAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: `${siteUrl}/service/ded-moroz`,
      actionPlatform: [
        'http://schema.org/DesktopWebPlatform',
        'http://schema.org/MobileWebPlatform',
      ],
    },
  },
  creator: {
    '@type': 'Organization',
    name: 'AI Video Generator',
    url: siteUrl,
  },
  inLanguage: 'ru',
  isAccessibleForFree: true,
};

export const metadata: Metadata = {
  metadataBase: new URL(siteUrl),
  viewport: {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 5,
  },
  title: {
    default: 'üéÖ –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ | AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä',
    template: '%s | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  },
  description: siteDescription,
  keywords: [
    '–î–µ–¥ –ú–æ—Ä–æ–∑',
    '–ù–æ–≤—ã–π –ì–æ–¥',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    'AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–æ',
    '–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ',
    '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç—è–º',
    '–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –ø–æ–¥–∞—Ä–æ–∫',
    'Sora 2',
    '–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç',
    '–≤–∏–¥–µ–æ –¥–ª—è –¥–µ—Ç–µ–π',
    '–Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –≤–∏–¥–µ–æ',
    '2026 –≥–æ–¥',
    '–ì–æ–¥ –õ–æ—à–∞–¥–∏',
  ],
  authors: [{ name: 'AI Video Generator' }],
  creator: 'AI Video Generator',
  publisher: 'AI Video Generator',
  formatDetection: {
    email: false,
    address: false,
    telephone: false,
  },
  openGraph: {
    type: 'website',
    locale: 'ru_RU',
    url: siteUrl,
    siteName,
    title: 'üéÖ –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ | AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä',
    description: siteDescription,
    images: [
      {
        url: `${siteUrl}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  twitter: {
    card: 'summary_large_image',
    title: 'üéÖ –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ | AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä',
    description: siteDescription,
    images: [`${siteUrl}/og-image.jpg`],
  },
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
  alternates: {
    canonical: siteUrl,
  },
  verification: {
    // –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–ª—é—á–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    // google: 'your-google-verification-code',
    // yandex: 'your-yandex-verification-code',
    // bing: 'your-bing-verification-code',
  },
  other: {
    'dns-prefetch': siteUrl,
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="ru" suppressHydrationWarning>
      <head>
        <link rel="preconnect" href={siteUrl} />
        <link rel="dns-prefetch" href={siteUrl} />
        <link rel="manifest" href="/manifest.json" />
        <link rel="icon" href="/favicon.ico" />
        <link rel="apple-touch-icon" href="/favicon.ico" />
        <meta name="theme-color" content="#c41e3a" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="–î–µ–¥ –ú–æ—Ä–æ–∑ AI" />
      </head>
      <body className="antialiased" suppressHydrationWarning>
        {children}
        <Footer />
        <Script
          id="structured-data"
          type="application/ld+json"
          dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
        />
        <Script
          id="organization-structured-data"
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify({
              '@context': 'https://schema.org',
              '@type': 'Organization',
              name: 'AI Video Generator',
              url: siteUrl,
              logo: `${siteUrl}/favicon.ico`,
              contactPoint: {
                '@type': 'ContactPoint',
                contactType: 'Customer Service',
                availableLanguage: ['Russian', 'English'],
              },
              sameAs: [],
            }),
          }}
        />
      </body>
    </html>
  );
}



================================================================================
–§–ê–ô–õ 42/69: app\loading.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\loading.tsx
================================================================================

export default function Loading() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      <div className="text-center">
        <div className="w-16 h-16 border-4 border-[#ffd700]/30 border-t-[#ffd700] rounded-full animate-spin mx-auto mb-4" />
        <p className="text-[#a8d8ea] text-lg">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      </div>
    </div>
  );
}



================================================================================
–§–ê–ô–õ 43/69: app\login\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\login\layout.tsx
================================================================================

import type { Metadata } from 'next';
import { BASE_URL } from '@/lib/config';

export const metadata: Metadata = {
  title: '–í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ!',
  keywords: [
    '–≤–æ–π—Ç–∏',
    '—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
    '–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
    '–∞–∫–∫–∞—É–Ω—Ç',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    '–î–µ–¥ –ú–æ—Ä–æ–∑',
  ],
  openGraph: {
    title: '–í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description:
      '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞.',
    url: `${BASE_URL}/login`,
    type: 'website',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  alternates: {
    canonical: `${BASE_URL}/login`,
  },
  robots: {
    index: false,
    follow: false,
  },
};

export default function LoginLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



================================================================================
–§–ê–ô–õ 44/69: app\login\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\login\page.tsx
================================================================================

'use client';

import { motion } from 'framer-motion';
import { Eye, EyeOff, LogIn, Sparkles, UserPlus } from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

export default function LoginPage() {
  const router = useRouter();
  const [isLogin, setIsLogin] = useState(true);
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    password2: '',
    nickname: '',
    firstName: '',
    lastName: '',
    agreedToTerms: false,
  });
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (!isLogin) {
      if (formData.password !== formData.password2) {
        setError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
      }
      if (!formData.agreedToTerms) {
        setError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');
        return;
      }
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(formData.email)) {
        setError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email (–ø—Ä–∏–º–µ—Ä: name@domain.com)');
        return;
      }
    }

    setLoading(true);

    try {
      const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
      const body = isLogin
        ? { email: formData.email, password: formData.password }
        : {
            email: formData.email,
            password: formData.password,
            nickname: formData.nickname,
            firstName: formData.firstName,
            lastName: formData.lastName,
            agreedToTerms: formData.agreedToTerms,
          };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞');
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));

      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
      router.push('/');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    } finally {
      setLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({
      email: '',
      password: '',
      password2: '',
      nickname: '',
      firstName: '',
      lastName: '',
      agreedToTerms: false,
    });
    setError(null);
  };

  return (
    <main className="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840] py-8">
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {[...Array(20)].map((_, i) => (
          <div
            key={i}
            className="star"
            style={{
              left: `${(i * 5) % 100}%`,
              top: `${(i * 7) % 60}%`,
              animationDelay: `${i * 0.2}s`,
              animationDuration: `${2 + (i % 3)}s`,
            }}
          />
        ))}
      </div>

      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="card-festive rounded-3xl p-8 md:p-10 w-full max-w-md mx-4 relative z-10"
      >
        <div className="text-center mb-6">
          <motion.div
            animate={{ rotate: [0, 5, -5, 0] }}
            transition={{ duration: 2, repeat: Infinity }}
            className="inline-block mb-4"
          >
            <span className="text-6xl">üéÖ</span>
          </motion.div>
          <h1 className="text-3xl md:text-4xl font-bold text-gradient font-display mb-2">
            {isLogin ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}
          </h1>
          <p className="text-[#a8d8ea]/60">
            {isLogin ? '–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç' : '–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –∑–∞–∫–∞–∑–∞ –≤–∏–¥–µ–æ'}
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          {!isLogin && (
            <>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-[#a8d8ea] mb-1 text-sm font-semibold">–ò–º—è</label>
                  <input
                    type="text"
                    value={formData.firstName}
                    onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                    placeholder="–ò–≤–∞–Ω"
                    required={!isLogin}
                    disabled={loading}
                    className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] disabled:opacity-50"
                  />
                </div>
                <div>
                  <label className="block text-[#a8d8ea] mb-1 text-sm font-semibold">–§–∞–º–∏–ª–∏—è</label>
                  <input
                    type="text"
                    value={formData.lastName}
                    onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                    placeholder="–ò–≤–∞–Ω–æ–≤"
                    required={!isLogin}
                    disabled={loading}
                    className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] disabled:opacity-50"
                  />
                </div>
              </div>

              <div>
                <label className="block text-[#a8d8ea] mb-1 text-sm font-semibold">
                  –ù–∏–∫ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è)
                </label>
                <input
                  type="text"
                  value={formData.nickname}
                  onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                  placeholder="Ivan2025"
                  required={!isLogin}
                  disabled={loading}
                  className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] disabled:opacity-50"
                />
              </div>
            </>
          )}

          <div>
            <label className="block text-[#a8d8ea] mb-1 text-sm font-semibold">Email</label>
            <input
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              placeholder="your@email.com"
              required
              disabled={loading}
              className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] disabled:opacity-50"
            />
          </div>

          <div>
            <label className="block text-[#a8d8ea] mb-1 text-sm font-semibold">–ü–∞—Ä–æ–ª—å</label>
            <div className="relative">
              <input
                type={showPassword ? 'text' : 'password'}
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                minLength={6}
                disabled={loading}
                className="input-magic w-full px-4 py-3 pr-12 rounded-xl text-[#f0f8ff] disabled:opacity-50"
              />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="absolute right-3 top-1/2 -translate-y-1/2 text-[#a8d8ea]/60 hover:text-[#a8d8ea]"
              >
                {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
              </button>
            </div>
          </div>

          {!isLogin && (
            <>
              <div>
                <label className="block text-[#a8d8ea] mb-1 text-sm font-semibold">
                  –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å
                </label>
                <input
                  type={showPassword ? 'text' : 'password'}
                  value={formData.password2}
                  onChange={(e) => setFormData({ ...formData, password2: e.target.value })}
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required={!isLogin}
                  minLength={6}
                  disabled={loading}
                  className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] disabled:opacity-50"
                />
              </div>

              <div className="flex items-start gap-3 mt-4">
                <input
                  type="checkbox"
                  id="agree"
                  checked={formData.agreedToTerms}
                  onChange={(e) => setFormData({ ...formData, agreedToTerms: e.target.checked })}
                  className="mt-1 w-5 h-5 rounded accent-[#c41e3a]"
                />
                <label htmlFor="agree" className="text-[#a8d8ea]/80 text-sm">
                  –Ø —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å{' '}
                  <Link href="/terms" target="_blank" className="text-[#ffd700] hover:underline">
                    —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                  </Link>{' '}
                  –∏ –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                </label>
              </div>
            </>
          )}

          {error && (
            <motion.div
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-200"
            >
              ‚ö†Ô∏è {error}
            </motion.div>
          )}

          <motion.button
            type="submit"
            disabled={loading}
            whileHover={!loading ? { scale: 1.02 } : {}}
            whileTap={!loading ? { scale: 0.98 } : {}}
            className="btn-magic w-full py-4 rounded-xl text-lg font-bold text-white flex items-center justify-center gap-3 disabled:cursor-not-allowed mt-6"
          >
            {loading ? (
              <>
                <Sparkles className="w-6 h-6 animate-spin" />
                <span>–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
              </>
            ) : isLogin ? (
              <>
                <LogIn className="w-6 h-6" />
                <span>–í–æ–π—Ç–∏</span>
              </>
            ) : (
              <>
                <UserPlus className="w-6 h-6" />
                <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
              </>
            )}
          </motion.button>
        </form>

        <div className="mt-5 text-center">
          <button
            onClick={() => {
              setIsLogin(!isLogin);
              resetForm();
            }}
            className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors"
          >
            {isLogin ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π–¥–∏—Ç–µ'}
          </button>
        </div>

        {isLogin && (
          <div className="mt-3 text-center">
            <Link
              href="/forgot-password"
              className="text-[#ffd700]/60 hover:text-[#ffd700] transition-colors text-sm"
            >
              –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
            </Link>
          </div>
        )}

        <div className="mt-4 text-center">
          <Link
            href="/"
            className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm"
          >
            ‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
          </Link>
        </div>
      </motion.div>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 45/69: app\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\page.tsx
================================================================================

'use client';

import ExampleVideoPlayer from '@/components/ExampleVideoPlayer';
import { motion } from 'framer-motion';
import {
  ArrowRight,
  Coins,
  Gift,
  Heart,
  LogIn,
  Sparkles,
  Star,
  TreePine,
  User,
} from 'lucide-react';
import Link from 'next/link';
import { Suspense, lazy, useEffect, useState } from 'react';

// Lazy loading –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
const Snowfall = lazy(() => import('@/components/Snowfall'));

export default function Home() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ null, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å hydration mismatch
  const [user, setUser] = useState<{
    id: number;
    email: string;
    nickname?: string;
    balance?: number;
  } | null>(null);
  const [isClient, setIsClient] = useState(false);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–æ—Å–ª–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  useEffect(() => {
    setIsClient(true);
    if (typeof window !== 'undefined') {
      const token = localStorage.getItem('token');
      const userData = localStorage.getItem('user');
      if (token && userData) {
        try {
          const parsedUser = JSON.parse(userData);
          setUser(parsedUser);
        } catch {
          setUser(null);
        }
      }
    }
  }, []);

  // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
  useEffect(() => {
    if (isClient && user?.id && typeof window !== 'undefined') {
      const token = localStorage.getItem('token');
      if (token) {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const timeoutId = setTimeout(() => {
          fetch('/api/user/balance', {
            headers: { Authorization: `Bearer ${token}` },
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.balance !== undefined) {
                setUser((prev) => {
                  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è
                  if (prev && prev.balance !== data.balance) {
                    return { ...prev, balance: data.balance };
                  }
                  return prev;
                });
              }
            })
            .catch(() => {});
        }, 200);

        return () => clearTimeout(timeoutId);
      }
    }
  }, [isClient, user?.id]); // –ó–∞–≤–∏—Å–∏–º —Ç–æ–ª—å–∫–æ –æ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ –æ—Ç –≤—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞

  return (
    <main className="min-h-screen relative overflow-hidden">
      <Suspense fallback={null}>
        <Snowfall />
      </Suspense>

      {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–≤—ë–∑–¥—ã */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {[...Array(30)].map((_, i) => (
          <div
            key={i}
            className="star"
            style={{
              left: `${(i * 3.3) % 100}%`,
              top: `${(i * 5) % 80}%`,
              animationDelay: `${i * 0.15}s`,
            }}
          />
        ))}
      </div>

      {/* –•–µ–¥–µ—Ä */}
      <header className="relative z-10 pt-4 sm:pt-8 pb-4">
        <div className="absolute top-2 right-2 sm:top-4 sm:right-4 flex gap-2 sm:gap-3 z-20">
          {user ? (
            <Link
              href="/profile"
              className="glass px-2 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-[#f0f8ff] hover:bg-white/10 transition-colors flex items-center gap-1 sm:gap-2 text-sm sm:text-base"
            >
              <Coins className="w-4 h-4 sm:w-5 sm:h-5 text-[#ffd700]" />
              <span className="font-bold text-[#ffd700] hidden sm:inline">{user.balance || 0}</span>
              <span className="font-bold text-[#ffd700] sm:hidden">{user.balance || 0}</span>
              <User className="w-4 h-4 sm:w-5 sm:h-5 ml-1 sm:ml-2" />
              <span className="hidden sm:inline">{user.nickname || '–ü—Ä–æ—Ñ–∏–ª—å'}</span>
            </Link>
          ) : (
            <Link
              href="/login"
              className="btn-magic px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-white flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base"
            >
              <LogIn className="w-4 h-4 sm:w-5 sm:h-5" />
              <span className="hidden sm:inline">–í–æ–π—Ç–∏</span>
              <span className="sm:hidden">–í—Ö–æ–¥</span>
            </Link>
          )}
        </div>

        <motion.div
          initial={{ y: -50, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ duration: 0.8, type: 'spring' }}
          className="text-center"
        >
          <motion.div
            animate={{ rotate: [0, 5, -5, 0] }}
            transition={{ duration: 2, repeat: Infinity }}
            className="inline-block mb-2 sm:mb-4"
          >
            <span className="text-5xl sm:text-7xl drop-shadow-lg">üéÖ</span>
          </motion.div>

          <h1 className="text-2xl sm:text-4xl md:text-6xl font-bold mb-2 sm:mb-3 font-display px-4">
            <span className="text-gradient">–í–æ–ª—à–µ–±–Ω—ã–µ –í–∏–¥–µ–æ-–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è</span>
          </h1>
          <h2 className="text-base sm:text-xl md:text-2xl text-[#a8d8ea] font-medium px-4">
            –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞
          </h2>

          <motion.div
            className="flex justify-center gap-4 mt-4"
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            transition={{ delay: 0.5 }}
          >
            <Sparkles className="text-[#ffd700] w-6 h-6 animate-pulse" />
            <TreePine className="text-[#0d4f2b] w-6 h-6" />
            <Gift className="text-[#c41e3a] w-6 h-6" />
            <Star className="text-[#ffd700] w-6 h-6 animate-pulse" />
          </motion.div>
        </motion.div>
      </header>

      <div className="container mx-auto px-3 sm:px-4 py-4 sm:py-8 relative z-10">
        {/* –ì–ª–∞–≤–Ω–∞—è —É—Å–ª—É–≥–∞ */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="max-w-4xl mx-auto"
        >
          <div className="card-festive rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 shadow-2xl mb-6 sm:mb-8">
            <div className="grid md:grid-cols-2 gap-4 sm:gap-8 items-center">
              {/* –ü—Ä–µ–≤—å—é –≤–∏–¥–µ–æ - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ */}
              <div className="order-1 md:order-2">
                <Suspense
                  fallback={
                    <div className="relative aspect-video rounded-xl sm:rounded-2xl overflow-hidden bg-gradient-to-br from-[#1a3a5c] to-[#0c1929] flex items-center justify-center">
                      <div className="text-center">
                        <span className="text-4xl sm:text-6xl mb-2 sm:mb-4 block">üé¨</span>
                        <p className="text-sm sm:text-base text-[#a8d8ea]">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                      </div>
                    </div>
                  }
                >
                  <ExampleVideoPlayer />
                </Suspense>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
              <div className="order-2 md:order-1">
                <h3 className="text-xl sm:text-2xl md:text-3xl font-bold text-white mb-3 sm:mb-4 font-display">
                  –í–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
                </h3>

                <p className="text-sm sm:text-base text-[#a8d8ea] mb-3 sm:mb-4">
                  –í—ã –ø–æ–ª—É—á–∏—Ç–µ –≤–∏–¥–µ–æ –¥–ª–∏–Ω–æ–π <strong>2 –º–∏–Ω—É—Ç—ã</strong>, –≤ –∫–æ—Ç–æ—Ä–æ–º –î–µ–¥ –ú–æ—Ä–æ–∑ –æ–±—Ä–∞—Ç–∏—Ç—Å—è
                  –∫ –≤–∞—à–µ–º—É —Ä–µ–±—ë–Ω–∫—É –ø–æ –∏–º–µ–Ω–∏, –ø–æ–∫–∞–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç —Å –ù–æ–≤—ã–º
                  –ì–æ–¥–æ–º!
                </p>

                <div className="flex flex-wrap items-center gap-2 sm:gap-3 mb-4 sm:mb-6">
                  <Gift className="w-6 h-6 sm:w-8 sm:h-8 text-[#0d4f2b]" />
                  <span className="text-2xl sm:text-3xl font-bold text-[#0d4f2b]">–ë–ï–°–ü–õ–ê–¢–ù–û</span>
                  <span className="text-xs sm:text-sm bg-[#c41e3a] text-white px-2 py-1 rounded-lg">
                    –ê–∫—Ü–∏—è!
                  </span>
                </div>

                <Link
                  href="/service/ded-moroz"
                  className="btn-magic px-6 sm:px-8 py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold text-white flex items-center justify-center gap-2 sm:gap-3 w-full md:w-auto"
                >
                  <span>–ó–∞–∫–∞–∑–∞—Ç—å</span>
                  <ArrowRight className="w-4 h-4 sm:w-5 sm:h-5" />
                </Link>
              </div>
            </div>
          </div>

          {/* –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ */}
          <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.4 }}
              className="glass-dark p-4 sm:p-6 rounded-xl sm:rounded-2xl text-center"
            >
              <Sparkles className="w-10 h-10 sm:w-12 sm:h-12 text-[#ffd700] mx-auto mb-3 sm:mb-4" />
              <h4 className="text-base sm:text-lg font-bold text-white mb-2">
                –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ AI –≤–∏–¥–µ–æ
              </h4>
              <p className="text-[#a8d8ea]/80 text-xs sm:text-sm">
                –°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ–¥–æ–≤–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ Sora 2
              </p>
            </motion.div>

            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.5 }}
              className="glass-dark p-4 sm:p-6 rounded-xl sm:rounded-2xl text-center"
            >
              <Heart className="w-10 h-10 sm:w-12 sm:h-12 text-[#c41e3a] mx-auto mb-3 sm:mb-4" />
              <h4 className="text-base sm:text-lg font-bold text-white mb-2">
                –ü–æ–ª–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
              </h4>
              <p className="text-[#a8d8ea]/80 text-xs sm:text-sm">
                –ò–º—è —Ä–µ–±—ë–Ω–∫–∞ –∏ –≤–∞—à–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ –≤–∏–¥–µ–æ
              </p>
            </motion.div>

            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.6 }}
              className="glass-dark p-4 sm:p-6 rounded-xl sm:rounded-2xl text-center sm:col-span-2 md:col-span-1"
            >
              <Gift className="w-10 h-10 sm:w-12 sm:h-12 text-[#0d4f2b] mx-auto mb-3 sm:mb-4" />
              <h4 className="text-base sm:text-lg font-bold text-white mb-2">–ò–¥–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</h4>
              <p className="text-[#a8d8ea]/80 text-xs sm:text-sm">
                –°–∫–∞—á–∞–π—Ç–µ –∏ –ø–æ–∫–∞–∂–∏—Ç–µ —Ä–µ–±—ë–Ω–∫—É –ø–æ–¥ —ë–ª–∫–æ–π
              </p>
            </motion.div>
          </div>

          {/* –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.7 }}
            className="card-festive rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8"
          >
            <h3 className="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6 text-center font-display">
              –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
            </h3>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
              <div className="text-center">
                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#ffd700]/20 flex items-center justify-center mx-auto mb-2 sm:mb-3">
                  <span className="text-xl sm:text-2xl font-bold text-[#ffd700]">1</span>
                </div>
                <h4 className="text-sm sm:text-base font-semibold text-white mb-1">
                  –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å
                </h4>
                <p className="text-[#a8d8ea]/60 text-xs sm:text-sm">–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∑–∞ –º–∏–Ω—É—Ç—É</p>
              </div>

              <div className="text-center">
                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#ffd700]/20 flex items-center justify-center mx-auto mb-2 sm:mb-3">
                  <span className="text-xl sm:text-2xl font-bold text-[#ffd700]">2</span>
                </div>
                <h4 className="text-sm sm:text-base font-semibold text-white mb-1">
                  –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É
                </h4>
                <p className="text-[#a8d8ea]/60 text-xs sm:text-sm">–°–µ–π—á–∞—Å –≤–∏–¥–µ–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</p>
              </div>

              <div className="text-center">
                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#ffd700]/20 flex items-center justify-center mx-auto mb-2 sm:mb-3">
                  <span className="text-xl sm:text-2xl font-bold text-[#ffd700]">3</span>
                </div>
                <h4 className="text-sm sm:text-base font-semibold text-white mb-1">
                  –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É
                </h4>
                <p className="text-[#a8d8ea]/60 text-xs sm:text-sm">–ò–º—è —Ä–µ–±—ë–Ω–∫–∞ –∏ 2 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</p>
              </div>

              <div className="text-center">
                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#ffd700]/20 flex items-center justify-center mx-auto mb-2 sm:mb-3">
                  <span className="text-xl sm:text-2xl font-bold text-[#ffd700]">4</span>
                </div>
                <h4 className="text-sm sm:text-base font-semibold text-white mb-1">
                  –ü–æ–ª—É—á–∏—Ç–µ –≤–∏–¥–µ–æ
                </h4>
                <p className="text-[#a8d8ea]/60 text-xs sm:text-sm">–°–∫–∞—á–∞–π—Ç–µ –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</p>
              </div>
            </div>

            <div className="text-center mt-6 sm:mt-8">
              <Link
                href={user ? '/service/ded-moroz' : '/login'}
                className="btn-magic px-6 sm:px-10 py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold text-white inline-flex items-center gap-2 sm:gap-3"
              >
                <Sparkles className="w-5 h-5 sm:w-6 sm:h-6" />
                {user ? '–ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ' : '–ù–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å'}
              </Link>
            </div>
          </motion.div>
        </motion.div>
      </div>

      {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ë–ª–∫–∏ */}
      <div className="fixed bottom-0 left-0 text-6xl md:text-8xl opacity-30 pointer-events-none">
        üå≤
      </div>
      <div className="fixed bottom-0 right-0 text-6xl md:text-8xl opacity-30 pointer-events-none">
        üå≤
      </div>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 46/69: app\profile\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\profile\layout.tsx
================================================================================

import type { Metadata } from 'next';
import { BASE_URL } from '@/lib/config';

export const metadata: Metadata = {
  title: '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤, –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º.',
  keywords: [
    '–ø—Ä–æ—Ñ–∏–ª—å',
    '–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç',
    '–º–æ–∏ –∑–∞–∫–∞–∑—ã',
    '–±–∞–ª–∞–Ω—Å',
    '–∏—Å—Ç–æ—Ä–∏—è',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
  ],
  openGraph: {
    title: '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description: '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏–∏.',
    url: `${BASE_URL}/profile`,
    type: 'website',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å - –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  alternates: {
    canonical: `${BASE_URL}/profile`,
  },
  robots: {
    index: false,
    follow: false,
  },
};

export default function ProfileLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



================================================================================
–§–ê–ô–õ 47/69: app\profile\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\profile\page.tsx
================================================================================

'use client';

import { AnimatePresence, motion } from 'framer-motion';
import {
  ArrowLeft,
  CheckCircle,
  Clock,
  Coins,
  Download,
  ExternalLink,
  History,
  Loader,
  LogOut,
  MessageCircle,
  Play,
  Plus,
  RefreshCw,
  User,
  X,
  XCircle,
} from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useCallback, useEffect, useState } from 'react';


interface Order {
  id: number;
  orderNumber: string;
  serviceName: string;
  taskId: number;
  childName: string;
  videoUrl: string | null;
  status: string;
  statusDescription: string;
  createdAt: string;
  completedAt: string | null;
}

interface Transaction {
  id: number;
  amount: number;
  type: string;
  status: string;
  invoice_url: string | null;
  created_at: string;
  completed_at: string | null;
}

export default function ProfilePage() {
  const router = useRouter();
  const [user, setUser] = useState<{
    id: number;
    email: string;
    nickname: string;
    firstName?: string;
    lastName?: string;
    balance: number;
  } | null>(null);
  const [orders, setOrders] = useState<Order[]>([]);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'orders' | 'balance'>('orders');
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);
  const [showTopupModal, setShowTopupModal] = useState(false);
  const [topupAmount, setTopupAmount] = useState(10);
  const [topupLoading, setTopupLoading] = useState(false);
  const [selectedCrypto, setSelectedCrypto] = useState<string[]>(['USDT', 'BTC', 'ETH', 'TRX']);
  const [checkingStatus, setCheckingStatus] = useState(false);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è pending –∑–∞–∫–∞–∑–æ–≤
  const checkPendingOrders = useCallback(async () => {
    const token = localStorage.getItem('token');
    if (!token) return;

    const pendingOrders = orders.filter(
      (o) =>
        o.taskId &&
        (o.status === 'pending' || o.status === 'in queue' || o.status === 'in progress')
    );

    if (pendingOrders.length === 0) return;

    setCheckingStatus(true);

    for (const order of pendingOrders) {
      try {
        const response = await fetch(`/api/check-status?taskId=${order.taskId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await response.json();

        if (data.isCompleted && data.videoUrl) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ —Å–ø–∏—Å–∫–µ
          setOrders((prev) =>
            prev.map((o) =>
              o.id === order.id
                ? {
                    ...o,
                    status: 'completed',
                    statusDescription: '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ',
                    videoUrl: data.videoUrl,
                  }
                : o
            )
          );
        } else if (data.isFailed && !data.introReady) {
          // –ï—Å–ª–∏ intro –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤, –Ω–µ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—à–∏–±–∫—É - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å
          console.log('Personal failed but intro not ready, continuing...');
        } else if (data.isFailed) {
          setOrders((prev) =>
            prev.map((o) =>
              o.id === order.id
                ? {
                    ...o,
                    status: data.statusDescription || 'error',
                    statusDescription: data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏',
                  }
                : o
            )
          );
        } else if (data.statusDescription) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          setOrders((prev) =>
            prev.map((o) =>
              o.id === order.id
                ? {
                    ...o,
                    status: data.statusDescription,
                    statusDescription: data.statusDescription,
                  }
                : o
            )
          );
        }
      } catch (error) {
        console.error('Check status error:', error);
      }
    }

    setCheckingStatus(false);
  }, [orders]);

  useEffect(() => {
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('user');

    if (!token || !userData) {
      router.push('/login');
      return;
    }

    setUser(JSON.parse(userData));
    loadData(token);
  }, [router]);

  // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤
  useEffect(() => {
    if (!loading && orders.length > 0) {
      const hasPending = orders.some(
        (o) =>
          o.taskId &&
          (o.status === 'pending' || o.status === 'in queue' || o.status === 'in progress')
      );
      if (hasPending) {
        checkPendingOrders();
      }
    }
  }, [loading, orders.length]); // eslint-disable-line react-hooks/exhaustive-deps

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  useEffect(() => {
    const hasPending = orders.some(
      (o) =>
        o.taskId &&
        (o.status === 'pending' || o.status === 'in queue' || o.status === 'in progress')
    );

    if (!hasPending) return;

    const interval = setInterval(() => {
      checkPendingOrders();
    }, 10000); // 10 —Å–µ–∫—É–Ω–¥

    return () => clearInterval(interval);
  }, [orders, checkPendingOrders]);

  const loadData = async (token: string) => {
    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
      const ordersRes = await fetch('/api/videos/history', {
        headers: { Authorization: `Bearer ${token}` },
      });
      const ordersData = await ordersRes.json();
      if (ordersData.orders) {
        setOrders(ordersData.orders);
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
      const balanceRes = await fetch('/api/user/balance', {
        headers: { Authorization: `Bearer ${token}` },
      });
      const balanceData = await balanceRes.json();
      if (balanceData.balance !== undefined) {
        setUser((prev) => (prev ? { ...prev, balance: balanceData.balance } : null));
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
      const transactionsRes = await fetch('/api/user/transactions', {
        headers: { Authorization: `Bearer ${token}` },
      });
      const transactionsData = await transactionsRes.json();
      if (transactionsData.transactions) {
        setTransactions(transactionsData.transactions);
      }
    } catch (error) {
      console.error('Load data error:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    router.push('/');
    router.refresh();
  };

  const handleDownload = async (taskId: number, childName: string) => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/videos/download?taskId=${taskId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pozdravlenie-${childName}.mp4`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } else {
        const data = await response.json();
        if (data.directDownload && data.videoUrl) {
          window.open(data.videoUrl, '_blank');
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ');
        }
      }
    } catch (error) {
      console.error('Download error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ');
    }
  };

  const handleTopup = async () => {
    setTopupLoading(true);
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/payment/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ amount: topupAmount, paymentCurrency: selectedCrypto }),
      });

      const data = await response.json();

      if (data.invoiceUrl) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
        window.open(data.invoiceUrl, '_blank');
        setShowTopupModal(false);
      } else {
        alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
      }
    } catch (error) {
      console.error('Topup error:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
    } finally {
      setTopupLoading(false);
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'completed':
        return <CheckCircle className="w-5 h-5 text-green-400" />;
      case 'pending':
      case 'in queue':
      case 'in progress':
        return <Loader className="w-5 h-5 text-yellow-400 animate-spin" />;
      case 'rejected with error':
      case 'rejected due to timeout':
        return <XCircle className="w-5 h-5 text-red-400" />;
      default:
        return <Clock className="w-5 h-5 text-[#a8d8ea]" />;
    }
  };

  const getStatusText = (status: string) => {
    const statusMap: Record<string, string> = {
      pending: '–í –æ—á–µ—Ä–µ–¥–∏',
      'in queue': '–í –æ—á–µ—Ä–µ–¥–∏',
      'in progress': '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è',
      completed: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
      'rejected with error': '–û—à–∏–±–∫–∞',
      'rejected due to timeout': '–¢–∞–π–º–∞—É—Ç',
    };
    return statusMap[status] || status;
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  if (loading) {
    return (
      <main className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <Loader className="w-12 h-12 text-[#ffd700] animate-spin" />
      </main>
    );
  }

  return (
    <main className="min-h-screen relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –•–µ–¥–µ—Ä */}
      <header className="relative z-10 pt-6 pb-4 border-b border-white/10">
        <div className="container mx-auto px-4 flex justify-between items-center">
          <Link
            href="/"
            className="text-[#a8d8ea] hover:text-white transition-colors flex items-center gap-2"
          >
            <ArrowLeft className="w-5 h-5" />
            –ù–∞ –≥–ª–∞–≤–Ω—É—é
          </Link>

          <button
            onClick={handleLogout}
            className="text-[#a8d8ea]/60 hover:text-red-400 transition-colors flex items-center gap-2"
          >
            <LogOut className="w-5 h-5" />
            –í—ã–π—Ç–∏
          </button>
        </div>
      </header>

      <div className="container mx-auto px-4 py-8">
        {/* –ü—Ä–æ—Ñ–∏–ª—å */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="card-festive rounded-3xl p-6 mb-8"
        >
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-[#c41e3a] to-[#8b0000] flex items-center justify-center">
                <User className="w-8 h-8 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-white">
                  {user?.nickname || user?.firstName}
                </h1>
                <p className="text-[#a8d8ea]/60">{user?.email}</p>
              </div>
            </div>

            <div className="flex items-center gap-4">
              <div className="glass-dark px-6 py-4 rounded-xl">
                <p className="text-[#a8d8ea]/60 text-sm">–ë–∞–ª–∞–Ω—Å</p>
                <div className="flex items-center gap-2">
                  <Coins className="w-6 h-6 text-[#ffd700]" />
                  <span className="text-2xl font-bold text-[#ffd700]">{user?.balance || 0}</span>
                  <span className="text-[#a8d8ea]">–ö–æ–π–Ω–æ–≤</span>
                </div>
              </div>
              <button
                onClick={() => setShowTopupModal(true)}
                className="btn-magic px-4 py-4 rounded-xl text-white flex items-center gap-2"
              >
                <Plus className="w-5 h-5" />
                –ü–æ–ø–æ–ª–Ω–∏—Ç—å
              </button>
            </div>
          </div>
        </motion.div>

        {/* –¢–∞–±—ã */}
        <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
          <button
            onClick={() => setActiveTab('orders')}
            className={`px-6 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2 whitespace-nowrap ${
              activeTab === 'orders'
                ? 'bg-[#c41e3a] text-white'
                : 'glass text-[#a8d8ea] hover:bg-white/10'
            }`}
          >
            <History className="w-5 h-5" />
            –ó–∞–∫–∞–∑—ã
          </button>
          <button
            onClick={() => setActiveTab('balance')}
            className={`px-6 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2 whitespace-nowrap ${
              activeTab === 'balance'
                ? 'bg-[#c41e3a] text-white'
                : 'glass text-[#a8d8ea] hover:bg-white/10'
            }`}
          >
            <Coins className="w-5 h-5" />
            –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π
          </button>
          <Link
            href="/contacts"
            className={`px-6 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2 whitespace-nowrap ${
              'glass text-[#a8d8ea] hover:bg-white/10'
            }`}
          >
            <MessageCircle className="w-5 h-5" />
            –¢–∏–∫–µ—Ç—ã
          </Link>
        </div>

        {/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–æ–≤ */}
        <AnimatePresence mode="wait">
          {activeTab === 'orders' && (
            <motion.div
              key="orders"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="card-festive rounded-3xl p-6"
            >
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-white">–ú–æ–∏ –∑–∞–∫–∞–∑—ã ({orders.length})</h2>
                {orders.some(
                  (o) =>
                    o.taskId &&
                    (o.status === 'pending' ||
                      o.status === 'in queue' ||
                      o.status === 'in progress')
                ) && (
                  <button
                    onClick={checkPendingOrders}
                    disabled={checkingStatus}
                    className="flex items-center gap-2 px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-[#a8d8ea] transition-colors disabled:opacity-50"
                  >
                    <RefreshCw className={`w-4 h-4 ${checkingStatus ? 'animate-spin' : ''}`} />
                    {checkingStatus ? '–ü—Ä–æ–≤–µ—Ä—è–µ–º...' : '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å'}
                  </button>
                )}
              </div>

              {orders.length === 0 ? (
                <div className="text-center py-10">
                  <p className="text-[#a8d8ea]/60 mb-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
                  <Link
                    href="/service/ded-moroz"
                    className="btn-magic px-6 py-3 rounded-xl text-white inline-flex items-center gap-2"
                  >
                    –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑
                  </Link>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="text-[#a8d8ea]/60 text-left border-b border-white/10">
                        <th className="pb-3 pr-4">–ù–æ–º–µ—Ä</th>
                        <th className="pb-3 pr-4">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th className="pb-3 pr-4">–°—Ç–∞—Ç—É—Å</th>
                        <th className="pb-3 pr-4">–î–∞—Ç–∞</th>
                        <th className="pb-3"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {orders.map((order) => (
                        <tr key={order.id} className="border-b border-white/5 hover:bg-white/5">
                          <td className="py-4 pr-4 text-[#ffd700] font-mono text-sm">
                            {order.orderNumber}
                          </td>
                          <td className="py-4 pr-4">
                            <div>
                              <p className="text-white">{order.serviceName}</p>
                              <p className="text-[#a8d8ea]/60 text-sm">–¥–ª—è {order.childName}</p>
                            </div>
                          </td>
                          <td className="py-4 pr-4">
                            <span className="flex items-center gap-2">
                              {getStatusIcon(order.status)}
                              <span className="text-[#a8d8ea]">{getStatusText(order.status)}</span>
                            </span>
                          </td>
                          <td className="py-4 pr-4 text-[#a8d8ea]/60">
                            {formatDate(order.createdAt)}
                          </td>
                          <td className="py-4">
                            <div className="flex gap-2">
                              {order.videoUrl && (
                                <>
                                  <button
                                    onClick={() => setSelectedOrder(order)}
                                    className="p-2 rounded-lg bg-white/10 hover:bg-white/20 text-[#a8d8ea] transition-colors"
                                    title="–°–º–æ—Ç—Ä–µ—Ç—å"
                                  >
                                    <Play className="w-4 h-4" />
                                  </button>
                                  <button
                                    onClick={() => handleDownload(order.taskId, order.childName)}
                                    className="p-2 rounded-lg bg-white/10 hover:bg-white/20 text-[#a8d8ea] transition-colors"
                                    title="–°–∫–∞—á–∞—Ç—å"
                                  >
                                    <Download className="w-4 h-4" />
                                  </button>
                                </>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </motion.div>
          )}

          {activeTab === 'balance' && (
            <motion.div
              key="balance"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="card-festive rounded-3xl p-6"
            >
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-white">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</h2>
                <button
                  onClick={() => setShowTopupModal(true)}
                  className="btn-magic px-4 py-2 rounded-xl text-white flex items-center gap-2"
                >
                  <Plus className="w-5 h-5" />
                  –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                </button>
              </div>

              {transactions.length === 0 ? (
                <div className="text-center py-10 text-[#a8d8ea]/60">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="text-[#a8d8ea]/60 text-left border-b border-white/10">
                        <th className="pb-3 pr-4">–ò–Ω–≤–æ–π—Å</th>
                        <th className="pb-3 pr-4">–°—É–º–º–∞</th>
                        <th className="pb-3 pr-4">–°—Ç–∞—Ç—É—Å</th>
                        <th className="pb-3 pr-4">–î–∞—Ç–∞</th>
                      </tr>
                    </thead>
                    <tbody>
                      {transactions.map((t) => (
                        <tr key={t.id} className="border-b border-white/5 hover:bg-white/5">
                          <td className="py-4 pr-4">
                            {t.invoice_url ? (
                              <a
                                href={t.invoice_url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-[#ffd700] hover:underline flex items-center gap-1"
                              >
                                –°—Å—ã–ª–∫–∞
                                <ExternalLink className="w-4 h-4" />
                              </a>
                            ) : (
                              <span className="text-[#a8d8ea]/60">‚Äî</span>
                            )}
                          </td>
                          <td className="py-4 pr-4">
                            <span className="text-green-400 font-bold">+{t.amount}</span>
                            <span className="text-[#a8d8ea]/60 ml-1">–ö–æ–π–Ω–æ–≤</span>
                          </td>
                          <td className="py-4 pr-4">
                            <span
                              className={`px-3 py-1 rounded-full text-sm ${
                                t.status === 'completed'
                                  ? 'bg-green-500/20 text-green-400'
                                  : t.status === 'pending'
                                  ? 'bg-yellow-500/20 text-yellow-400'
                                  : 'bg-red-500/20 text-red-400'
                              }`}
                            >
                              {t.status === 'completed'
                                ? '–û–ø–ª–∞—á–µ–Ω–æ'
                                : t.status === 'pending'
                                ? '–û–∂–∏–¥–∞–µ—Ç'
                                : '–û—Ç–º–µ–Ω–µ–Ω–æ'}
                            </span>
                          </td>
                          <td className="py-4 pr-4 text-[#a8d8ea]/60">
                            {formatDate(t.created_at)}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </motion.div>
          )}

        </AnimatePresence>
      </div>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ */}
      <AnimatePresence>
        {selectedOrder && selectedOrder.videoUrl && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4"
            onClick={() => setSelectedOrder(null)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="max-w-4xl w-full"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-white text-xl font-bold">
                  {selectedOrder.serviceName} –¥–ª—è {selectedOrder.childName}
                </h3>
                <button
                  onClick={() => setSelectedOrder(null)}
                  className="text-white/60 hover:text-white"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>
              <video src={selectedOrder.videoUrl} controls autoPlay className="w-full rounded-xl" />
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è */}
      <AnimatePresence>
        {showTopupModal && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
            onClick={() => setShowTopupModal(false)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="card-festive rounded-3xl p-6 md:p-8 w-full max-w-md"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-gradient font-display">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h2>
                <button
                  onClick={() => setShowTopupModal(false)}
                  className="text-[#a8d8ea]/60 hover:text-white"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="mb-6">
                <label className="block text-[#a8d8ea] mb-2 font-semibold">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <div className="flex gap-2 mb-4">
                  {[5, 10, 20, 50].map((amount) => (
                    <button
                      key={amount}
                      onClick={() => setTopupAmount(amount)}
                      className={`flex-1 py-3 rounded-xl font-semibold transition-colors ${
                        topupAmount === amount
                          ? 'bg-[#ffd700] text-black'
                          : 'glass text-[#a8d8ea] hover:bg-white/10'
                      }`}
                    >
                      {amount}
                    </button>
                  ))}
                </div>
                <input
                  type="number"
                  min="1"
                  value={topupAmount}
                  onChange={(e) => setTopupAmount(parseInt(e.target.value) || 1)}
                  className="input-magic w-full px-5 py-4 rounded-xl text-[#f0f8ff] text-lg"
                />
              </div>

              <div className="mb-6">
                <label className="block text-[#a8d8ea] mb-2 font-semibold">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                <div className="grid grid-cols-4 gap-2">
                  {['USDT', 'BTC', 'ETH', 'TRX', 'USDC', 'ATOM', 'AVAX', 'LTC'].map((crypto) => (
                    <button
                      key={crypto}
                      onClick={() => {
                        if (selectedCrypto.includes(crypto)) {
                          if (selectedCrypto.length > 1) {
                            setSelectedCrypto(selectedCrypto.filter((c) => c !== crypto));
                          }
                        } else {
                          setSelectedCrypto([...selectedCrypto, crypto]);
                        }
                      }}
                      className={`py-2 px-2 rounded-lg text-xs font-semibold transition-colors ${
                        selectedCrypto.includes(crypto)
                          ? 'bg-[#ffd700] text-black'
                          : 'glass text-[#a8d8ea] hover:bg-white/10'
                      }`}
                    >
                      {crypto}
                    </button>
                  ))}
                </div>
                <p className="text-[#a8d8ea]/40 text-xs mt-2">
                  –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã (–º–∏–Ω–∏–º—É–º –æ–¥–Ω–∞)
                </p>
              </div>

              <div className="bg-white/5 rounded-xl p-4 mb-6">
                <div className="flex justify-between items-center">
                  <span className="text-[#a8d8ea]">–ö –æ–ø–ª–∞—Ç–µ</span>
                  <span className="text-2xl font-bold text-[#ffd700]">${topupAmount}</span>
                </div>
                <p className="text-[#a8d8ea]/60 text-sm mt-2">
                  1 –ö–æ–π–Ω = 1 USD. –û–ø–ª–∞—Ç–∞: {selectedCrypto.join(', ')}
                </p>
              </div>

              <button
                onClick={handleTopup}
                disabled={topupLoading}
                className="btn-magic w-full py-4 rounded-xl text-lg font-bold text-white flex items-center justify-center gap-3 disabled:opacity-50"
              >
                {topupLoading ? (
                  <Loader className="w-6 h-6 animate-spin" />
                ) : (
                  <>
                    <Coins className="w-6 h-6" />
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                  </>
                )}
              </button>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 48/69: app\reset-password\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\reset-password\layout.tsx
================================================================================

import type { Metadata } from 'next';
import { BASE_URL } from '@/lib/config';

export const metadata: Metadata = {
  title: '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.',
  keywords: [
    '—Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è',
    '–Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å',
    '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
  ],
  openGraph: {
    title: '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.',
    url: `${BASE_URL}/reset-password`,
    type: 'website',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è - –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  alternates: {
    canonical: `${BASE_URL}/reset-password`,
  },
  robots: {
    index: false,
    follow: false,
  },
};

export default function ResetPasswordLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



================================================================================
–§–ê–ô–õ 49/69: app\reset-password\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\reset-password\page.tsx
================================================================================

'use client';

import { motion } from 'framer-motion';
import { ArrowLeft, Eye, EyeOff, Lock, Sparkles } from 'lucide-react';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import { Suspense, useEffect, useState } from 'react';

function ResetPasswordForm() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  const [password, setPassword] = useState('');
  const [password2, setPassword2] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [loading, setLoading] = useState(false);
  const [validating, setValidating] = useState(true);
  const [tokenValid, setTokenValid] = useState(false);

  useEffect(() => {
    if (!token) {
      setError('–¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
      setValidating(false);
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
    fetch(`/api/auth/forgot-password?token=${token}`)
      .then((res) => res.json())
      .then((data) => {
        if (data.valid) {
          setTokenValid(true);
        } else {
          setError(data.error || '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫');
        }
      })
      .catch(() => {
        setError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞');
      })
      .finally(() => {
        setValidating(false);
      });
  }, [token]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    if (!password || !password2) {
      setError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    if (password.length < 6) {
      setError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
      return;
    }

    if (password !== password2) {
      setError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token, newPassword: password }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è');
      }

      setSuccess(true);
      setTimeout(() => {
        router.push('/login');
      }, 2000);
    } catch (err) {
      setError(err instanceof Error ? err.message : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    } finally {
      setLoading(false);
    }
  };

  if (validating) {
    return (
      <main className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <div className="text-center">
          <Sparkles className="w-12 h-12 text-[#ffd700] animate-spin mx-auto mb-4" />
          <p className="text-[#a8d8ea]">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞...</p>
        </div>
      </main>
    );
  }

  if (!tokenValid) {
    return (
      <main className="min-h-screen relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
        <div className="container mx-auto px-4 py-8 relative z-10">
          <Link
            href="/login"
            className="inline-flex items-center gap-2 text-[#a8d8ea] hover:text-white transition-colors mb-6"
          >
            <ArrowLeft className="w-5 h-5" />
            –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É
          </Link>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="max-w-md mx-auto"
          >
            <div className="card-festive rounded-3xl p-8 text-center">
              <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                <Lock className="w-8 h-8 text-red-400" />
              </div>
              <h1 className="text-2xl font-bold text-white mb-4">–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</h1>
              <p className="text-[#a8d8ea] mb-6">
                {error || '–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ –∏—Å—Ç—ë–∫–ª–∞'}
              </p>
              <Link
                href="/forgot-password"
                className="btn-magic px-6 py-3 rounded-xl text-white inline-flex items-center gap-2"
              >
                –ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É
              </Link>
            </div>
          </motion.div>
        </div>
      </main>
    );
  }

  return (
    <main className="min-h-screen relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {[...Array(30)].map((_, i) => (
          <div
            key={i}
            className="star"
            style={{
              left: `${(i * 3.3) % 100}%`,
              top: `${(i * 5) % 80}%`,
              animationDelay: `${i * 0.15}s`,
            }}
          />
        ))}
      </div>

      <div className="container mx-auto px-4 py-8 relative z-10">
        <Link
          href="/login"
          className="inline-flex items-center gap-2 text-[#a8d8ea] hover:text-white transition-colors mb-6"
        >
          <ArrowLeft className="w-5 h-5" />
          –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É
        </Link>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="max-w-md mx-auto"
        >
          <div className="card-festive rounded-3xl p-8">
            <div className="text-center mb-6">
              <motion.div
                animate={{ rotate: [0, 5, -5, 0] }}
                transition={{ duration: 2, repeat: Infinity }}
                className="inline-block mb-4"
              >
                <span className="text-6xl">üîë</span>
              </motion.div>
              <h1 className="text-3xl font-bold text-gradient font-display mb-2">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</h1>
              <p className="text-[#a8d8ea]/80">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
            </div>

            {success ? (
              <motion.div
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                className="text-center py-6"
              >
                <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
                  <Lock className="w-8 h-8 text-green-400" />
                </div>
                <h2 className="text-xl font-bold text-white mb-2">–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω!</h2>
                <p className="text-[#a8d8ea] mb-6">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...</p>
              </motion.div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label className="block text-[#a8d8ea] mb-2 font-semibold">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#a8d8ea]/60" />
                    <input
                      type={showPassword ? 'text' : 'password'}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                      required
                      minLength={6}
                      className="input-magic w-full pl-12 pr-12 py-4 rounded-xl text-[#f0f8ff]"
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-4 top-1/2 -translate-y-1/2 text-[#a8d8ea]/60 hover:text-[#a8d8ea]"
                    >
                      {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-[#a8d8ea] mb-2 font-semibold">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
                  </label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#a8d8ea]/60" />
                    <input
                      type={showPassword ? 'text' : 'password'}
                      value={password2}
                      onChange={(e) => setPassword2(e.target.value)}
                      placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                      required
                      minLength={6}
                      className="input-magic w-full pl-12 pr-12 py-4 rounded-xl text-[#f0f8ff]"
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-4 top-1/2 -translate-y-1/2 text-[#a8d8ea]/60 hover:text-[#a8d8ea]"
                    >
                      {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                    </button>
                  </div>
                </div>

                {error && (
                  <motion.div
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-200"
                  >
                    ‚ö†Ô∏è {error}
                  </motion.div>
                )}

                <motion.button
                  type="submit"
                  disabled={loading}
                  whileHover={{ scale: loading ? 1 : 1.02 }}
                  whileTap={{ scale: loading ? 1 : 0.98 }}
                  className="btn-magic w-full py-4 rounded-xl text-lg font-bold text-white flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? (
                    <>
                      <Sparkles className="w-5 h-5 animate-spin" />
                      <span>–ò–∑–º–µ–Ω–µ–Ω–∏–µ...</span>
                    </>
                  ) : (
                    <>
                      <Lock className="w-5 h-5" />
                      <span>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
                    </>
                  )}
                </motion.button>
              </form>
            )}
          </div>
        </motion.div>
      </div>
    </main>
  );
}

export default function ResetPasswordPage() {
  return (
    <Suspense
      fallback={
        <main className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
          <div className="text-center">
            <Sparkles className="w-12 h-12 text-[#ffd700] animate-spin mx-auto mb-4" />
            <p className="text-[#a8d8ea]">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
          </div>
        </main>
      }
    >
      <ResetPasswordForm />
    </Suspense>
  );
}



================================================================================
–§–ê–ô–õ 50/69: app\robots.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\robots.ts
================================================================================

import { BASE_URL } from '@/lib/config';
import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  const baseUrl = BASE_URL;

  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: [
          '/api/',
          '/admin/',
          '/_next/',
          '/profile',
          '/login',
          '/register',
          '/forgot-password',
          '/reset-password',
        ],
      },
      {
        userAgent: 'Googlebot',
        allow: '/',
        disallow: [
          '/api/',
          '/admin/',
          '/profile',
          '/login',
          '/register',
          '/forgot-password',
          '/reset-password',
        ],
      },
      {
        userAgent: 'Yandex',
        allow: '/',
        disallow: [
          '/api/',
          '/admin/',
          '/profile',
          '/login',
          '/register',
          '/forgot-password',
          '/reset-password',
        ],
      },
      {
        userAgent: 'Bingbot',
        allow: '/',
        disallow: [
          '/api/',
          '/admin/',
          '/profile',
          '/login',
          '/register',
          '/forgot-password',
          '/reset-password',
        ],
      },
    ],
    sitemap: `${baseUrl}/sitemap.xml`,
    host: baseUrl.replace(/^https?:\/\//, ''),
  };
}



================================================================================
–§–ê–ô–õ 51/69: app\service\ded-moroz\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\service\ded-moroz\layout.tsx
================================================================================

import type { Metadata } from 'next';
import Script from 'next/script';
import { BASE_URL } from '@/lib/config';

const serviceStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: '–í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ Sora 2',
  provider: {
    '@type': 'Organization',
    name: 'AI Video Generator',
    url: BASE_URL,
  },
  areaServed: {
    '@type': 'Country',
    name: 'RU',
  },
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'RUB',
    availability: 'https://schema.org/InStock',
    priceValidUntil: '2026-12-31',
  },
  serviceType: 'Video Generation',
  category: 'Entertainment',
  inLanguage: 'ru',
};

const breadcrumbsStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: '–ì–ª–∞–≤–Ω–∞—è',
      item: BASE_URL,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: '–ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ',
      item: `${BASE_URL}/service/ded-moroz`,
    },
  ],
};

export const metadata: Metadata = {
  title: '–ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ù–æ–≤—ã–º –ì–æ–¥–æ–º',
  description:
    '–ó–∞–∫–∞–∂–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. –ò–º—è —Ä–µ–±—ë–Ω–∫–∞, –≤–∞—à–∏ —Ñ–æ—Ç–æ, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ù–æ–≤—ã–º –ì–æ–¥–æ–º. AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, HD –∫–∞—á–µ—Å—Ç–≤–æ. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ!',
  keywords: [
    '–∑–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    '–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    '–Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –≤–∏–¥–µ–æ –¥–ª—è –¥–µ—Ç–µ–π',
    '–î–µ–¥ –ú–æ—Ä–æ–∑ –≤–∏–¥–µ–æ',
    'AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–æ',
    '–≤–∏–¥–µ–æ –ø–æ–¥–∞—Ä–æ–∫ –Ω–∞ –ù–æ–≤—ã–π –ì–æ–¥',
    '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    'Sora 2',
    '–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç',
    '–≤–∏–¥–µ–æ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞',
    '–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –ø–æ–¥–∞—Ä–æ–∫',
    '2026 –≥–æ–¥',
  ],
  openGraph: {
    title: '–ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    description:
      '–ó–∞–∫–∞–∂–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. –ò–º—è —Ä–µ–±—ë–Ω–∫–∞, –≤–∞—à–∏ —Ñ–æ—Ç–æ, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ù–æ–≤—ã–º –ì–æ–¥–æ–º. AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, HD –∫–∞—á–µ—Å—Ç–≤–æ. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ!',
    url: `${BASE_URL}/service/ded-moroz`,
    type: 'website',
    locale: 'ru_RU',
    siteName: '–í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  twitter: {
    card: 'summary_large_image',
    title: '–ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description:
      '–ó–∞–∫–∞–∂–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. –ò–º—è —Ä–µ–±—ë–Ω–∫–∞, –≤–∞—à–∏ —Ñ–æ—Ç–æ, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ù–æ–≤—ã–º –ì–æ–¥–æ–º. –ë–µ—Å–ø–ª–∞—Ç–Ω–æ!',
    images: [`${BASE_URL}/og-image.jpg`],
  },
  alternates: {
    canonical: `${BASE_URL}/service/ded-moroz`,
  },
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
};

export default function DedMorozLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <>
      {children}
      <Script
        id="service-structured-data"
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(serviceStructuredData) }}
      />
      <Script
        id="breadcrumbs-structured-data"
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(breadcrumbsStructuredData) }}
      />
    </>
  );
}



================================================================================
–§–ê–ô–õ 52/69: app\service\ded-moroz\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\service\ded-moroz\page.tsx
================================================================================

'use client';

import { AnimatePresence, motion } from 'framer-motion';
import {
  ArrowLeft,
  Check,
  Clock,
  Coins,
  Gift,
  Image as ImageIcon,
  Play,
  ShoppingCart,
  Sparkles,
  Star,
  Upload,
  User,
  X,
} from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useEffect, useRef, useState } from 'react';

const COMMENT_SUGGESTIONS = [
  '–∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–ø–æ—Ä—Ç–æ–º –∏ –ª—é–±–∏—Ç —Ñ—É—Ç–±–æ–ª',
  '–æ—Ç–ª–∏—á–Ω–æ —É—á–∏—Ç—Å—è –≤ —à–∫–æ–ª–µ',
  '–ø–æ–º–æ–≥–∞–µ—Ç –º–∞–º–µ –ø–æ –¥–æ–º—É',
  '–ª—é–±–∏—Ç —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏',
  '—Ä–∏—Å—É–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω—ã',
  '–∏–≥—Ä–∞–µ—Ç –Ω–∞ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ',
  '–∑–∞–±–æ—Ç–∏—Ç—Å—è –æ –º–ª–∞–¥—à–∏—Ö',
  '–≤—Å–µ–≥–¥–∞ –¥–µ–ª–∏—Ç—Å—è —Å –¥—Ä—É–∑—å—è–º–∏',
];

export default function DedMorozServicePage() {
  const router = useRouter();
  const videoRef = useRef<HTMLVideoElement>(null);
  const [user, setUser] = useState<{
    id: number;
    email: string;
    nickname: string;
    balance: number;
  } | null>(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [showOrderForm, setShowOrderForm] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [exampleVideoUrl, setExampleVideoUrl] = useState<string | null>(null);
  const [shouldLoadVideo, setShouldLoadVideo] = useState(false);

  const [formData, setFormData] = useState({
    childName: '',
    childAge: '' as string | number,
    photo1: null as File | null,
    photo1Preview: '',
    photo1Comment: '',
    photo2: null as File | null,
    photo2Preview: '',
    photo2Comment: '',
  });

  useEffect(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏–∑ localStorage
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('user');
    if (token && userData) {
      setUser(JSON.parse(userData));

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
      const timeoutId = setTimeout(() => {
        fetch('/api/user/balance', {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.balance !== undefined) {
              setUser((prev) => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (prev && prev.balance !== data.balance) {
                  return { ...prev, balance: data.balance };
                }
                return prev;
              });
            }
          })
          .catch(() => {});
      }, 100);

      return () => clearTimeout(timeoutId);
    }

    // –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Å—Ä–∞–∑—É - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
  }, []);

  const handlePhotoChange = (e: React.ChangeEvent<HTMLInputElement>, photoNum: 1 | 2) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å 5 –ú–ë)
    if (file.size > 5 * 1024 * 1024) {
      setError('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 5 –ú–ë');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø
    if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
      setError('–î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPEG, JPG, PNG');
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      if (photoNum === 1) {
        setFormData({
          ...formData,
          photo1: file,
          photo1Preview: reader.result as string,
        });
      } else {
        setFormData({
          ...formData,
          photo2: file,
          photo2Preview: reader.result as string,
        });
      }
    };
    reader.readAsDataURL(file);
  };

  const handleOrder = () => {
    if (!user) {
      router.push('/login');
      return;
    }
    setShowOrderForm(true);
  };

  const handleSubmitOrder = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    if (!formData.childName.trim()) {
      setError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ–±—ë–Ω–∫–∞');
      return;
    }
    if (formData.childAge && (Number(formData.childAge) < 1 || Number(formData.childAge) > 18)) {
      setError('–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 18 –ª–µ—Ç');
      return;
    }
    if (!formData.photo1 || !formData.photo2) {
      setError('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–æ—Ç–æ');
      return;
    }
    if (!formData.photo1Comment.trim() || !formData.photo2Comment.trim()) {
      setError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –æ–±–æ–∏–º —Ñ–æ—Ç–æ');
      return;
    }

    // –ë–ï–°–ü–õ–ê–¢–ù–û - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –Ω–µ –Ω—É–∂–Ω–∞

    setLoading(true);

    try {
      const token = localStorage.getItem('token');

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –≤ base64
      const photo1Base64 = formData.photo1Preview;
      const photo2Base64 = formData.photo2Preview;

      const response = await fetch('/api/generate-video', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          childName: formData.childName,
          childAge: formData.childAge ? Number(formData.childAge) : undefined,
          photo1: photo1Base64,
          photo1Comment: formData.photo1Comment,
          photo2: photo2Base64,
          photo2Comment: formData.photo2Comment,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
      if (user && data.balance !== undefined) {
        setUser({ ...user, balance: data.balance });
        localStorage.setItem('user', JSON.stringify({ ...user, balance: data.balance }));
      }

      setSuccess(
        `–ó–∞–∫–∞–∑ #${data.orderNumber} —Å–æ–∑–¥–∞–Ω! –í–∏–¥–µ–æ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.`
      );
      setShowOrderForm(false);

      // –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        router.push('/profile');
      }, 3000);
    } catch (err) {
      setError(err instanceof Error ? err.message : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    } finally {
      setLoading(false);
    }
  };

  const toggleVideo = () => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
    if (!shouldLoadVideo) {
      setShouldLoadVideo(true);
      // –ó–∞–≥—Ä—É–∂–∞–µ–º URL –≤–∏–¥–µ–æ
      fetch('/api/videos/example/random')
        .then((res) => res.json())
        .then((data) => {
          if (data.success && data.videoUrl) {
            setExampleVideoUrl(data.videoUrl);
          } else {
            setExampleVideoUrl('/api/videos/stream/final/final_2.mp4');
          }
        })
        .catch(() => {
          setExampleVideoUrl('/api/videos/stream/final/final_2.mp4');
        });
      return;
    }

    if (videoRef.current) {
      if (isPlaying) {
        videoRef.current.pause();
      } else {
        videoRef.current.play();
      }
      setIsPlaying(!isPlaying);
    }
  };

  const handleVideoHover = () => {
    if (!shouldLoadVideo) {
      setShouldLoadVideo(true);
      // –ó–∞–≥—Ä—É–∂–∞–µ–º URL –≤–∏–¥–µ–æ –ø—Ä–∏ hover
      fetch('/api/videos/example/random')
        .then((res) => res.json())
        .then((data) => {
          if (data.success && data.videoUrl) {
            setExampleVideoUrl(data.videoUrl);
          } else {
            setExampleVideoUrl('/api/videos/stream/final/final_2.mp4');
          }
        })
        .catch(() => {
          setExampleVideoUrl('/api/videos/stream/final/final_2.mp4');
        });
    }
  };

  return (
    <main className="min-h-screen relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840]">
      {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {[...Array(30)].map((_, i) => (
          <div
            key={i}
            className="star"
            style={{
              left: `${(i * 3.3) % 100}%`,
              top: `${(i * 5) % 80}%`,
              animationDelay: `${i * 0.15}s`,
            }}
          />
        ))}
      </div>

      {/* –•–µ–¥–µ—Ä */}
      <header className="relative z-10 pt-4 sm:pt-6 pb-4">
        <div className="container mx-auto px-3 sm:px-4 flex justify-between items-center">
          <Link
            href="/"
            className="text-[#a8d8ea] hover:text-white transition-colors flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base"
          >
            <ArrowLeft className="w-4 h-4 sm:w-5 sm:h-5" />
            <span className="hidden sm:inline">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            <span className="sm:hidden">–ù–∞–∑–∞–¥</span>
          </Link>

          {user ? (
            <Link
              href="/profile"
              className="glass px-2 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-[#f0f8ff] hover:bg-white/10 transition-colors flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base"
            >
              <Coins className="w-4 h-4 sm:w-5 sm:h-5 text-[#ffd700]" />
              <span className="font-bold text-[#ffd700]">{user.balance}</span>
              <span className="text-[#a8d8ea]/60 hidden sm:inline">–ö–æ–π–Ω–æ–≤</span>
            </Link>
          ) : (
            <Link
              href="/login"
              className="btn-magic px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-white flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base"
            >
              <User className="w-4 h-4 sm:w-5 sm:h-5" />
              <span className="hidden sm:inline">–í–æ–π—Ç–∏</span>
              <span className="sm:hidden">–í—Ö–æ–¥</span>
            </Link>
          )}
        </div>
      </header>

      <div className="container mx-auto px-3 sm:px-4 py-4 sm:py-8 relative z-10">
        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Å–ª—É–≥–∏ */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-6 sm:mb-8"
        >
          <span className="text-5xl sm:text-7xl mb-2 sm:mb-4 block">üéÖ</span>
          <h1 className="text-2xl sm:text-4xl md:text-5xl font-bold text-gradient font-display mb-2 sm:mb-3 px-2">
            –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
          </h1>
          <p className="text-base sm:text-xl text-[#a8d8ea] px-2">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞</p>
        </motion.div>

        <div className="grid lg:grid-cols-2 gap-4 sm:gap-8 max-w-6xl mx-auto">
          {/* –í–∏–¥–µ–æ-–ø—Ä–µ–≤—å—é */}
          <motion.div
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.2 }}
            className="card-festive rounded-2xl sm:rounded-3xl p-4 sm:p-6 overflow-hidden order-2 lg:order-1"
          >
            <h2 className="text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4 flex items-center gap-2">
              <Play className="w-4 h-4 sm:w-5 sm:h-5 text-[#c41e3a]" />
              –ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ
            </h2>

            <div
              className="relative aspect-video rounded-2xl overflow-hidden bg-black/50 cursor-pointer"
              onMouseEnter={handleVideoHover}
            >
              {shouldLoadVideo && exampleVideoUrl ? (
                <video
                  ref={videoRef}
                  className="w-full h-full object-cover"
                  onEnded={() => setIsPlaying(false)}
                  playsInline
                  preload="none"
                  key={exampleVideoUrl}
                >
                  <source src={exampleVideoUrl} type="video/mp4" />
                  <source
                    src={exampleVideoUrl.replace('/api/videos/stream/', '/videos/')}
                    type="video/mp4"
                  />
                </video>
              ) : (
                <div className="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-[#1a3a5c] to-[#0c1929]">
                  <div className="text-center">
                    <span className="text-6xl mb-4 block">üé¨</span>
                    <p className="text-[#a8d8ea]">–ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ</p>
                    <p className="text-[#a8d8ea]/60 text-sm mt-2">
                      –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    </p>
                  </div>
                </div>
              )}
              <button
                onClick={toggleVideo}
                className="absolute inset-0 flex items-center justify-center bg-black/30 hover:bg-black/40 transition-colors"
              >
                {isPlaying ? (
                  <span className="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center">
                    <span className="w-4 h-12 bg-white rounded mx-1"></span>
                    <span className="w-4 h-12 bg-white rounded mx-1"></span>
                  </span>
                ) : (
                  <Play className="w-16 h-16 text-white" />
                )}
              </button>
            </div>
          </motion.div>

          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∑–∞–∫–∞–∑ */}
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.3 }}
            className="card-festive rounded-2xl sm:rounded-3xl p-4 sm:p-6 order-1 lg:order-2"
          >
            {/* –¶–µ–Ω–∞ */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sm:mb-6 pb-4 sm:pb-6 border-b border-white/10 gap-4">
              <div>
                <p className="text-[#a8d8ea]/60 text-xs sm:text-sm line-through">–°—Ç–æ–∏–º–æ—Å—Ç—å: 5 –ö–æ–π–Ω–æ–≤</p>
                <div className="flex flex-wrap items-center gap-2">
                  <Gift className="w-6 h-6 sm:w-8 sm:h-8 text-[#0d4f2b]" />
                  <span className="text-2xl sm:text-4xl font-bold text-[#0d4f2b]">–ë–ï–°–ü–õ–ê–¢–ù–û</span>
                  <span className="text-xs sm:text-sm bg-[#c41e3a] text-white px-2 py-1 rounded-lg">
                    –ê–∫—Ü–∏—è!
                  </span>
                </div>
              </div>
              <motion.button
                onClick={handleOrder}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="btn-magic px-4 sm:px-6 py-3 sm:py-4 rounded-xl text-base sm:text-lg font-bold text-white flex items-center gap-2 w-full sm:w-auto justify-center"
              >
                <ShoppingCart className="w-5 h-5 sm:w-6 sm:h-6" />
                –ó–∞–∫–∞–∑–∞—Ç—å
              </motion.button>
            </div>

            {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
            <div className="space-y-3 sm:space-y-4 text-[#a8d8ea]">
              <h3 className="text-lg sm:text-xl font-bold text-white flex items-center gap-2">
                <Gift className="w-4 h-4 sm:w-5 sm:h-5 text-[#c41e3a]" />
                –ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ
              </h3>

              <p className="text-sm sm:text-base leading-relaxed">
                –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –¥–ª–∏–Ω–æ–π <strong>2 –º–∏–Ω—É—Ç—ã</strong>, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Å—Ç–æ—è—â–∏–π –î–µ–¥ –ú–æ—Ä–æ–∑
                –æ–±—Ä–∞—Ç–∏—Ç—Å—è –∫ –≤–∞—à–µ–º—É —Ä–µ–±—ë–Ω–∫—É –ø–æ –∏–º–µ–Ω–∏!
              </p>

              <ul className="space-y-2 sm:space-y-3">
                <li className="flex items-start gap-2 sm:gap-3">
                  <Check className="w-4 h-4 sm:w-5 sm:h-5 text-[#0d4f2b] mt-0.5 flex-shrink-0" />
                  <span className="text-sm sm:text-base">–î–µ–¥—É—à–∫–∞ –ú–æ—Ä–æ–∑ –Ω–∞–∑–æ–≤—ë—Ç –∏–º—è –≤–∞—à–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ –∏ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç —Å –ù–æ–≤—ã–º –ì–æ–¥–æ–º</span>
                </li>
                <li className="flex items-start gap-2 sm:gap-3">
                  <Check className="w-4 h-4 sm:w-5 sm:h-5 text-[#0d4f2b] mt-0.5 flex-shrink-0" />
                  <span className="text-sm sm:text-base">–ü–æ–∫–∞–∂–µ—Ç –∏ –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</span>
                </li>
                <li className="flex items-start gap-2 sm:gap-3">
                  <Check className="w-4 h-4 sm:w-5 sm:h-5 text-[#0d4f2b] mt-0.5 flex-shrink-0" />
                  <span className="text-sm sm:text-base">–†–∞—Å—Å–∫–∞–∂–µ—Ç –ø—Ä–æ –ì–æ–¥ –õ–æ—à–∞–¥–∏ 2026 –∏ –ø–æ–∂–µ–ª–∞–µ—Ç —É–¥–∞—á–∏</span>
                </li>
                <li className="flex items-start gap-2 sm:gap-3">
                  <Check className="w-4 h-4 sm:w-5 sm:h-5 text-[#0d4f2b] mt-0.5 flex-shrink-0" />
                  <span className="text-sm sm:text-base">–í–∏–¥–µ–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ</span>
                </li>
              </ul>

              <div className="flex flex-wrap items-center gap-3 sm:gap-4 pt-3 sm:pt-4 text-xs sm:text-sm text-[#a8d8ea]/60">
                <span className="flex items-center gap-1">
                  <Clock className="w-3 h-3 sm:w-4 sm:h-4" />
                  ~2 –º–∏–Ω—É—Ç—ã
                </span>
                <span className="flex items-center gap-1">
                  <Star className="w-3 h-3 sm:w-4 sm:h-4" />
                  HD –∫–∞—á–µ—Å—Ç–≤–æ
                </span>
                <span className="flex items-center gap-1">
                  <ImageIcon className="w-4 h-4" />2 –≤–∞—à–∏—Ö —Ñ–æ—Ç–æ
                </span>
              </div>
            </div>
          </motion.div>
        </div>

        {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
        <AnimatePresence>
          {success && (
            <motion.div
              initial={{ opacity: 0, y: 50 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 50 }}
              className="fixed bottom-4 sm:bottom-8 left-1/2 -translate-x-1/2 bg-green-500/90 text-white px-4 sm:px-6 py-3 sm:py-4 rounded-xl shadow-2xl max-w-md text-center z-50 mx-4"
            >
              <Check className="w-5 h-5 sm:w-6 sm:h-6 mx-auto mb-1 sm:mb-2" />
              <p className="text-sm sm:text-base">{success}</p>
            </motion.div>
          )}
        </AnimatePresence>

        {/* –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) */}
        <AnimatePresence>
          {showOrderForm && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
              onClick={(e) => e.target === e.currentTarget && setShowOrderForm(false)}
            >
              <motion.div
                initial={{ scale: 0.9, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0.9, opacity: 0 }}
                className="card-festive rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 w-full max-w-2xl max-h-[90vh] flex flex-col"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="flex-shrink-0 flex justify-between items-center mb-4 sm:mb-6">
                  <h2 className="text-xl sm:text-2xl font-bold text-gradient font-display">
                    –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
                  </h2>
                  <button
                    onClick={() => setShowOrderForm(false)}
                    className="text-[#a8d8ea]/60 hover:text-white p-1"
                  >
                    <X className="w-5 h-5 sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="flex-1 overflow-y-auto pr-1 sm:pr-2 -mr-1 sm:-mr-2 min-h-0">
                  <form onSubmit={handleSubmitOrder} className="space-y-4 sm:space-y-6">
                    {/* –ò–º—è —Ä–µ–±—ë–Ω–∫–∞ */}
                    <div>
                      <label className="block text-[#a8d8ea] mb-2 font-semibold text-sm sm:text-base">–ò–º—è —Ä–µ–±—ë–Ω–∫–∞</label>
                      <input
                        type="text"
                        value={formData.childName}
                        onChange={(e) => setFormData({ ...formData, childName: e.target.value })}
                        placeholder="–ö–∞–∫ –∑–æ–≤—É—Ç —Ä–µ–±—ë–Ω–∫–∞?"
                        required
                        className="input-magic w-full px-4 sm:px-5 py-3 sm:py-4 rounded-xl text-[#f0f8ff] text-base sm:text-lg"
                      />
                    </div>

                    {/* –í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ */}
                    <div>
                      <label className="block text-[#a8d8ea] mb-2 font-semibold text-sm sm:text-base">
                        –í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ <span className="text-[#a8d8ea]/60 text-xs sm:text-sm">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                      </label>
                      <input
                        type="number"
                        min="1"
                        max="18"
                        value={formData.childAge}
                        onChange={(e) =>
                          setFormData({ ...formData, childAge: e.target.value || '' })
                        }
                        placeholder="–°–∫–æ–ª—å–∫–æ –ª–µ—Ç —Ä–µ–±—ë–Ω–∫—É?"
                        className="input-magic w-full px-4 sm:px-5 py-3 sm:py-4 rounded-xl text-[#f0f8ff] text-base sm:text-lg"
                      />
                      <p className="text-[#a8d8ea]/60 text-xs sm:text-sm mt-1">
                        –£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç, —á—Ç–æ–±—ã –î–µ–¥ –ú–æ—Ä–æ–∑ –æ–±—Ä–∞—Ç–∏–ª—Å—è –∫ —Ä–µ–±—ë–Ω–∫—É –±–æ–ª–µ–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ
                      </p>
                    </div>

                    {/* –§–æ—Ç–æ 1 */}
                    <div className="space-y-2 sm:space-y-3">
                      <label className="block text-[#a8d8ea] font-semibold text-sm sm:text-base">–§–æ—Ç–æ ‚Ññ1</label>
                      <div className="grid sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                          {formData.photo1Preview ? (
                            <div className="relative aspect-video rounded-xl overflow-hidden">
                              <img
                                src={formData.photo1Preview}
                                alt="–§–æ—Ç–æ 1 - –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                                className="w-full h-full object-cover"
                                loading="lazy"
                                decoding="async"
                              />
                              <button
                                type="button"
                                onClick={() =>
                                  setFormData({
                                    ...formData,
                                    photo1: null,
                                    photo1Preview: '',
                                  })
                                }
                                className="absolute top-2 right-2 bg-red-500 rounded-full p-1"
                              >
                                <X className="w-4 h-4 text-white" />
                              </button>
                            </div>
                          ) : (
                            <label className="block aspect-video rounded-xl border-2 border-dashed border-[#a8d8ea]/30 hover:border-[#a8d8ea]/60 cursor-pointer transition-colors">
                              <div className="h-full flex flex-col items-center justify-center text-[#a8d8ea]/60">
                                <Upload className="w-8 h-8 mb-2" />
                                <span className="text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                              </div>
                              <input
                                type="file"
                                accept="image/jpeg,image/jpg,image/png"
                                onChange={(e) => handlePhotoChange(e, 1)}
                                className="hidden"
                              />
                            </label>
                          )}
                        </div>
                        <div>
                          <label className="block text-[#a8d8ea]/80 mb-1 text-sm">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–æ—Ç–æ
                          </label>
                          <textarea
                            value={formData.photo1Comment}
                            onChange={(e) =>
                              setFormData({
                                ...formData,
                                photo1Comment: e.target.value,
                              })
                            }
                            placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–ø–æ—Ä—Ç–æ–º –∏ –ª—é–±–∏—Ç —Ñ—É—Ç–±–æ–ª)"
                            rows={3}
                            className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] resize-none"
                          />
                          <div className="flex flex-wrap gap-1 mt-2">
                            {COMMENT_SUGGESTIONS.slice(0, 3).map((s, i) => (
                              <button
                                key={i}
                                type="button"
                                onClick={() => setFormData({ ...formData, photo1Comment: s })}
                                className="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded-lg text-[#a8d8ea]/80"
                              >
                                {s}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* –§–æ—Ç–æ 2 */}
                    <div className="space-y-2 sm:space-y-3">
                      <label className="block text-[#a8d8ea] font-semibold text-sm sm:text-base">–§–æ—Ç–æ ‚Ññ2</label>
                      <div className="grid sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                          {formData.photo2Preview ? (
                            <div className="relative aspect-video rounded-xl overflow-hidden">
                              <img
                                src={formData.photo2Preview}
                                alt="–§–æ—Ç–æ 2 - –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                                className="w-full h-full object-cover"
                                loading="lazy"
                                decoding="async"
                              />
                              <button
                                type="button"
                                onClick={() =>
                                  setFormData({
                                    ...formData,
                                    photo2: null,
                                    photo2Preview: '',
                                  })
                                }
                                className="absolute top-2 right-2 bg-red-500 rounded-full p-1"
                              >
                                <X className="w-4 h-4 text-white" />
                              </button>
                            </div>
                          ) : (
                            <label className="block aspect-video rounded-xl border-2 border-dashed border-[#a8d8ea]/30 hover:border-[#a8d8ea]/60 cursor-pointer transition-colors">
                              <div className="h-full flex flex-col items-center justify-center text-[#a8d8ea]/60">
                                <Upload className="w-8 h-8 mb-2" />
                                <span className="text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                              </div>
                              <input
                                type="file"
                                accept="image/jpeg,image/jpg,image/png"
                                onChange={(e) => handlePhotoChange(e, 2)}
                                className="hidden"
                              />
                            </label>
                          )}
                        </div>
                        <div>
                          <label className="block text-[#a8d8ea]/80 mb-1 text-sm">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–æ—Ç–æ
                          </label>
                          <textarea
                            value={formData.photo2Comment}
                            onChange={(e) =>
                              setFormData({
                                ...formData,
                                photo2Comment: e.target.value,
                              })
                            }
                            placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç–ª–∏—á–Ω–æ —É—á–∏—Ç—Å—è –≤ —à–∫–æ–ª–µ)"
                            rows={3}
                            className="input-magic w-full px-4 py-3 rounded-xl text-[#f0f8ff] resize-none"
                          />
                          <div className="flex flex-wrap gap-1 mt-2">
                            {COMMENT_SUGGESTIONS.slice(3, 6).map((s, i) => (
                              <button
                                key={i}
                                type="button"
                                onClick={() => setFormData({ ...formData, photo2Comment: s })}
                                className="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded-lg text-[#a8d8ea]/80"
                              >
                                {s}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* –û—à–∏–±–∫–∞ */}
                    {error && (
                      <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-200">
                        ‚ö†Ô∏è {error}
                      </div>
                    )}
                  </form>
                </div>

                {/* –ò—Ç–æ–≥–æ –∏ –∫–Ω–æ–ø–∫–∞ - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–Ω–∏–∑—É */}
                <div className="flex-shrink-0 pt-3 sm:pt-4 border-t border-white/10 mt-3 sm:mt-4 space-y-3 sm:space-y-4">
                  <div className="bg-[#0d4f2b]/20 rounded-xl p-3 sm:p-4 text-center">
                    <p className="text-[#0d4f2b] text-base sm:text-lg font-bold flex items-center justify-center gap-2">
                      <Gift className="w-5 h-5 sm:w-6 sm:h-6" />
                      –≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ! üéÅ
                    </p>
                    <p className="text-[#a8d8ea]/60 text-xs sm:text-sm mt-1">–ê–∫—Ü–∏—è –Ω–∞ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏</p>
                  </div>

                  <motion.button
                    type="button"
                    onClick={handleSubmitOrder}
                    disabled={loading}
                    whileHover={{ scale: 1.02 }}
                    whileTap={{ scale: 0.98 }}
                    className="btn-magic w-full py-4 sm:py-5 rounded-xl text-base sm:text-xl font-bold text-white flex items-center justify-center gap-2 sm:gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? (
                      <>
                        <Sparkles className="w-5 h-5 sm:w-6 sm:h-6 animate-spin" />
                        <span>–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ...</span>
                      </>
                    ) : (
                      <>
                        <Gift className="w-5 h-5 sm:w-6 sm:h-6" />
                        <span>–ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                      </>
                    )}
                  </motion.button>
                </div>
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 53/69: app\sitemap.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\sitemap.ts
================================================================================

import { BASE_URL } from '@/lib/config';
import { MetadataRoute } from 'next';

export default function sitemap(): MetadataRoute.Sitemap {
  const baseUrl = BASE_URL;
  const now = new Date();

  const routes: MetadataRoute.Sitemap = [
    {
      url: `${baseUrl}`,
      lastModified: now,
      changeFrequency: 'daily',
      priority: 1.0,
    },
    {
      url: `${baseUrl}/service/ded-moroz`,
      lastModified: now,
      changeFrequency: 'weekly',
      priority: 0.9,
    },
    {
      url: `${baseUrl}/contacts`,
      lastModified: now,
      changeFrequency: 'monthly',
      priority: 0.8,
    },
    {
      url: `${baseUrl}/terms`,
      lastModified: now,
      changeFrequency: 'monthly',
      priority: 0.7,
    },
  ];

  return routes;
}



================================================================================
–§–ê–ô–õ 54/69: app\terms\layout.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\terms\layout.tsx
================================================================================

import type { Metadata } from 'next';
import { BASE_URL } from '@/lib/config';

export const metadata: Metadata = {
  title: '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
  description:
    '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.',
  keywords: [
    '—É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è',
    '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
    '–ø—Ä–∞–≤–∏–ª–∞',
    '–ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏',
    '–≤–∏–¥–µ–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
    '–î–µ–¥ –ú–æ—Ä–æ–∑',
  ],
  openGraph: {
    title: '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
    description:
      '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞.',
    url: `${BASE_URL}/terms`,
    type: 'website',
    images: [
      {
        url: `${BASE_URL}/og-image.jpg`,
        width: 1200,
        height: 630,
        alt: '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è - –í–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞',
      },
    ],
  },
  alternates: {
    canonical: `${BASE_URL}/terms`,
  },
  robots: {
    index: true,
    follow: true,
  },
};

export default function TermsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}



================================================================================
–§–ê–ô–õ 55/69: app\terms\page.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\app\terms\page.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { motion } from "framer-motion";
import Link from "next/link";
import { ArrowLeft, FileText } from "lucide-react";

export default function TermsPage() {
  const [agreementText, setAgreementText] = useState("");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch("/api/settings/agreement")
      .then((res) => res.json())
      .then((data) => {
        setAgreementText(data.text || "–¢–µ–∫—Å—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω");
        setLoading(false);
      })
      .catch(() => {
        setAgreementText("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è");
        setLoading(false);
      });
  }, []);

  return (
    <main className="min-h-screen relative overflow-hidden bg-gradient-to-br from-[#0c1929] via-[#1a3a5c] to-[#0d2840] py-8">
      <div className="container mx-auto px-4 max-w-3xl">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="card-festive rounded-3xl p-8 md:p-10"
        >
          <div className="flex items-center gap-4 mb-8">
            <Link
              href="/login"
              className="text-[#a8d8ea] hover:text-white transition-colors"
            >
              <ArrowLeft className="w-6 h-6" />
            </Link>
            <div className="flex items-center gap-3">
              <FileText className="w-8 h-8 text-[#ffd700]" />
              <h1 className="text-2xl md:text-3xl font-bold text-gradient font-display">
                –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
              </h1>
            </div>
          </div>

          {loading ? (
            <div className="text-center text-[#a8d8ea]/60 py-10">
              –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
          ) : (
            <div className="prose prose-invert max-w-none">
              <div className="text-[#a8d8ea]/90 whitespace-pre-wrap leading-relaxed">
                {agreementText}
              </div>
            </div>
          )}

          <div className="mt-8 pt-6 border-t border-white/10">
            <Link
              href="/login"
              className="btn-magic px-6 py-3 rounded-xl text-white inline-flex items-center gap-2"
            >
              <ArrowLeft className="w-5 h-5" />
              –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            </Link>
          </div>
        </motion.div>
      </div>
    </main>
  );
}



================================================================================
–§–ê–ô–õ 56/69: components\BreadcrumbsSchema.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\components\BreadcrumbsSchema.tsx
================================================================================

import Script from 'next/script';
import { BASE_URL } from '@/lib/config';

interface BreadcrumbsSchemaProps {
  items: Array<{
    name: string;
    url: string;
  }>;
}

export default function BreadcrumbsSchema({ items }: BreadcrumbsSchemaProps) {
  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: items.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.name,
      item: `${BASE_URL}${item.url}`,
    })),
  };

  return (
    <Script
      id="breadcrumbs-structured-data"
      type="application/ld+json"
      dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
    />
  );
}



================================================================================
–§–ê–ô–õ 57/69: components\ExampleVideoPlayer.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\components\ExampleVideoPlayer.tsx
================================================================================

'use client';

import { useEffect, useRef, useState } from 'react';

export default function ExampleVideoPlayer() {
  const videoRef = useRef<HTMLVideoElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [showPlaceholder, setShowPlaceholder] = useState(true);
  const [videoUrl, setVideoUrl] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [shouldLoad, setShouldLoad] = useState(false);
  const [isHovered, setIsHovered] = useState(false);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–Ω
  useEffect(() => {
    if (!shouldLoad) return;

    const loadRandomVideo = async () => {
      try {
        setIsLoading(true);
        const response = await fetch('/api/videos/example/random');
        const data = await response.json();
        if (data.success && data.videoUrl) {
          setVideoUrl(data.videoUrl);
        } else {
          setVideoUrl('/api/videos/stream/final/final_2.mp4');
        }
      } catch (error) {
        console.error('Error loading random example video:', error);
        setVideoUrl('/api/videos/stream/final/final_2.mp4');
      } finally {
        setIsLoading(false);
      }
    };

    loadRandomVideo();
  }, [shouldLoad]);

  // Intersection Observer - –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–≥–¥–∞ —ç–ª–µ–º–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –≤ viewport
  useEffect(() => {
    if (!containerRef.current) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !shouldLoad) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø–æ—Å–ª–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ viewport
            setTimeout(() => {
              setShouldLoad(true);
            }, 500);
            observer.disconnect();
          }
        });
      },
      {
        rootMargin: '100px', // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–∞ 100px –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
        threshold: 0.1,
      }
    );

    observer.observe(containerRef.current);

    return () => observer.disconnect();
  }, [shouldLoad]);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ hover
  const handleMouseEnter = () => {
    setIsHovered(true);
    if (!shouldLoad) {
      setShouldLoad(true);
    }
  };

  const handleClick = () => {
    if (!shouldLoad) {
      setShouldLoad(true);
    }
    if (videoRef.current) {
      if (videoRef.current.paused) {
        videoRef.current.play();
      } else {
        videoRef.current.pause();
      }
    }
  };

  const handleVideoLoaded = () => {
    setShowPlaceholder(false);
    setIsLoading(false);
  };

  const handleVideoError = () => {
    setShowPlaceholder(true);
    setIsLoading(false);
    if (videoUrl !== '/api/videos/stream/final/final_2.mp4') {
      setVideoUrl('/api/videos/stream/final/final_2.mp4');
    }
  };

  return (
    <div
      ref={containerRef}
      className="relative aspect-video rounded-2xl overflow-hidden bg-black group cursor-pointer"
      onMouseEnter={handleMouseEnter}
      onClick={handleClick}
    >
      {/* –í–∏–¥–µ–æ - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ */}
      {videoUrl && shouldLoad && (
        <video
          ref={videoRef}
          className="w-full h-full object-cover"
          autoPlay={isHovered}
          loop
          muted
          playsInline
          preload="none"
          onLoadedData={handleVideoLoaded}
          onError={handleVideoError}
          style={{ display: showPlaceholder ? 'none' : 'block' }}
          key={videoUrl}
        >
          <source src={videoUrl} type="video/mp4" />
          <source src={videoUrl.replace('/api/videos/stream/', '/videos/')} type="video/mp4" />
        </video>
      )}

      {/* –ó–∞–≥–ª—É—à–∫–∞ */}
      {(showPlaceholder || isLoading || !shouldLoad) && (
        <div className="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-[#1a3a5c] to-[#0c1929] transition-opacity hover:opacity-90">
          <div className="text-center">
            <span className="text-6xl mb-4 block">üé¨</span>
            <p className="text-[#a8d8ea]">–ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ</p>
            <p className="text-[#a8d8ea]/60 text-sm mt-2">
              {isLoading
                ? '–ó–∞–≥—Ä—É–∑–∫–∞...'
                : !shouldLoad
                ? '–ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'
                : '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞'}
            </p>
            {!shouldLoad && (
              <p className="text-[#a8d8ea]/40 text-xs mt-2">üí° –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            )}
          </div>
        </div>
      )}

      {/* –ì—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ */}
      {!showPlaceholder && videoUrl && (
        <>
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent pointer-events-none" />
          <div className="absolute bottom-4 left-4 right-4 pointer-events-none">
            <p className="text-white text-sm font-semibold drop-shadow-lg">–ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ</p>
          </div>
        </>
      )}
    </div>
  );
}



================================================================================
–§–ê–ô–õ 58/69: components\Footer.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\components\Footer.tsx
================================================================================

'use client';

import { ArrowRight, FileText, Gift, Info, MessageCircle, Shield, User } from 'lucide-react';
import Link from 'next/link';
import { useEffect, useState } from 'react';

export default function Footer() {
  const [user, setUser] = useState<{
    id: number;
    email: string;
    nickname?: string;
    balance?: number;
  } | null>(null);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–æ—Å–ª–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const userData = localStorage.getItem('user');
      if (userData) {
        try {
          const parsedUser = JSON.parse(userData);
          setUser(parsedUser);
        } catch {
          setUser(null);
        }
      }
    }
  }, []);

  return (
    <footer className="relative z-10 py-8 sm:py-12 mt-8 sm:mt-12 border-t border-white/10 bg-black/20">
      <div className="container mx-auto px-3 sm:px-4">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 sm:gap-8 mb-6">
          {/* –û —Å–µ—Ä–≤–∏—Å–µ */}
          <div>
            <h3 className="text-white font-bold text-lg mb-3 flex items-center gap-2">
              <Info className="w-5 h-5 text-[#ffd700]" />–û —Å–µ—Ä–≤–∏—Å–µ
            </h3>
            <p className="text-[#a8d8ea]/60 text-sm mb-3">
              –°–æ–∑–¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ-–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
              –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ Sora 2
            </p>
            <div className="flex flex-wrap gap-2">
              <Link
                href="/service/ded-moroz"
                className="text-[#a8d8ea]/60 hover:text-[#ffd700] transition-colors text-sm flex items-center gap-1"
              >
                <Gift className="w-4 h-4" />
                –ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ
              </Link>
            </div>
          </div>

          {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
          <div>
            <h3 className="text-white font-bold text-lg mb-3 flex items-center gap-2">
              <FileText className="w-5 h-5 text-[#ffd700]" />
              –ù–∞–≤–∏–≥–∞—Ü–∏—è
            </h3>
            <ul className="space-y-2">
              <li>
                <Link
                  href="/"
                  className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm flex items-center gap-2"
                >
                  <ArrowRight className="w-3 h-3" />
                  –ì–ª–∞–≤–Ω–∞—è
                </Link>
              </li>
              <li>
                <Link
                  href="/service/ded-moroz"
                  className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm flex items-center gap-2"
                >
                  <ArrowRight className="w-3 h-3" />
                  –ó–∞–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ
                </Link>
              </li>
              <li>
                <Link
                  href="/contacts"
                  className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm flex items-center gap-2"
                >
                  <MessageCircle className="w-3 h-3" />
                  –ö–æ–Ω—Ç–∞–∫—Ç—ã
                </Link>
              </li>
              <li>
                <Link
                  href="/terms"
                  className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm flex items-center gap-2"
                >
                  <FileText className="w-3 h-3" />
                  –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                </Link>
              </li>
            </ul>
          </div>

          {/* –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∞–¥–º–∏–Ω–∫–∞ */}
          <div>
            <h3 className="text-white font-bold text-lg mb-3 flex items-center gap-2">
              <MessageCircle className="w-5 h-5 text-[#ffd700]" />
              –ö–æ–Ω—Ç–∞–∫—Ç—ã
            </h3>
            <ul className="space-y-2 mb-4">
              <li>
                <Link
                  href="/contacts"
                  className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm flex items-center gap-2"
                >
                  <MessageCircle className="w-3 h-3" />
                  –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                </Link>
              </li>
              {user && (
                <li>
                  <Link
                    href="/profile"
                    className="text-[#a8d8ea]/60 hover:text-[#a8d8ea] transition-colors text-sm flex items-center gap-2"
                  >
                    <User className="w-3 h-3" />
                    –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                  </Link>
                </li>
              )}
              {user?.email?.endsWith('@admin.com') && (
                <li>
                  <Link
                    href="/admin"
                    className="text-[#ffd700]/60 hover:text-[#ffd700] transition-colors text-sm flex items-center gap-2"
                  >
                    <Shield className="w-3 h-3" />
                    –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                  </Link>
                </li>
              )}
            </ul>
          </div>
        </div>

        {/* –ö–æ–ø–∏—Ä–∞–π—Ç */}
        <div className="border-t border-white/10 pt-6 text-center">
          <p className="text-[#a8d8ea]/60 text-xs sm:text-sm mb-2">
            –í–∏–¥–µ–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ Sora 2
          </p>
          <p className="text-[#a8d8ea]/60 text-xs sm:text-sm">
            –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –≤–æ–ª—à–µ–±–Ω—ã—Ö –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ ¬© 2024-2025
          </p>
        </div>
      </div>
    </footer>
  );
}



================================================================================
–§–ê–ô–õ 59/69: components\GenerationProgress.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\components\GenerationProgress.tsx
================================================================================

"use client";

import { motion } from "framer-motion";
import { Sparkles, Clock, Loader2 } from "lucide-react";

interface GenerationProgressProps {
  progress: number;
  statusMessage?: string;
  taskId?: number | null;
}

const magicMessages = [
  "üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ —á–∏—Ç–∞–µ—Ç –≤–∞—à–µ –ø–∏—Å—å–º–æ...",
  "‚ú® –ì–æ—Ç–æ–≤–∏–º –≤–æ–ª—à–µ–±–Ω—É—é –ø—ã–ª—å—Ü—É...",
  "ü¶å –û–ª–µ–Ω–∏ –∑–∞–ø—Ä—è–≥–∞—é—Ç—Å—è –≤ —Å–∞–Ω–∏...",
  "‚ùÑÔ∏è –°–æ–∑–¥–∞—ë–º —Å–Ω–µ–∂–Ω–æ–µ –≤–æ–ª—à–µ–±—Å—Ç–≤–æ...",
  "üéÑ –£–∫—Ä–∞—à–∞–µ–º —ë–ª–∫—É –∑–≤—ë–∑–¥–∞–º–∏...",
  "üéÅ –ó–∞–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ–¥–∞—Ä–∫–∏...",
  "‚≠ê –î–æ–±–∞–≤–ª—è–µ–º –∏—Å–∫—Ä—ã —Å—á–∞—Å—Ç—å—è...",
  "üåü –§–∏–Ω–∞–ª—å–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏ –º–∞–≥–∏–∏...",
  "üé¨ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–∏–¥–µ–æ-–ø–æ—Å–ª–∞–Ω–∏–µ...",
  "‚úÖ –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!",
];

export default function GenerationProgress({
  progress,
  statusMessage,
  taskId
}: GenerationProgressProps) {
  const messageIndex = Math.min(
    Math.floor(progress / 10),
    magicMessages.length - 1
  );

  const displayMessage = statusMessage || magicMessages[messageIndex];

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className="glass rounded-xl p-6"
    >
      <div className="flex items-center gap-3 mb-4">
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
        >
          <Sparkles className="w-6 h-6 text-[#ffd700]" />
        </motion.div>
        <span className="text-lg font-semibold text-[#f0f8ff]">
          {displayMessage}
        </span>
      </div>

      {/* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */}
      <div className="relative h-4 bg-white/10 rounded-full overflow-hidden">
        <motion.div
          className="absolute inset-y-0 left-0 rounded-full"
          style={{
            background: "linear-gradient(90deg, #c41e3a, #ffd700, #c41e3a)",
            backgroundSize: "200% 100%",
          }}
          animate={{
            width: `${Math.min(progress, 100)}%`,
            backgroundPosition: ["0% center", "100% center", "0% center"],
          }}
          transition={{
            width: { duration: 0.5 },
            backgroundPosition: { duration: 2, repeat: Infinity },
          }}
        />

        {/* –ò—Å–∫—Ä—ã –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–µ */}
        {progress > 0 && progress < 100 && (
          <motion.div
            className="absolute inset-y-0 w-8"
            style={{ left: `calc(${Math.min(progress, 100)}% - 16px)` }}
            animate={{ opacity: [0.5, 1, 0.5] }}
            transition={{ duration: 0.5, repeat: Infinity }}
          >
            <div className="w-full h-full bg-gradient-to-r from-transparent via-white/50 to-transparent" />
          </motion.div>
        )}
      </div>

      <div className="flex justify-between items-center mt-2 text-sm text-[#a8d8ea]/60">
        <span className="flex items-center gap-1">
          {progress < 100 ? (
            <>
              <Loader2 className="w-3 h-3 animate-spin" />
              –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ
            </>
          ) : (
            "‚úÖ –ì–æ—Ç–æ–≤–æ!"
          )}
        </span>
        <span className="font-mono">{Math.round(progress)}%</span>
      </div>

      {/* ID –∑–∞–¥–∞–Ω–∏—è */}
      {taskId && (
        <div className="flex items-center justify-center gap-2 mt-3 text-xs text-[#a8d8ea]/40">
          <Clock className="w-3 h-3" />
          <span>–ó–∞–¥–∞–Ω–∏–µ #{taskId}</span>
        </div>
      )}

      {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */}
      <div className="flex justify-center gap-2 mt-4">
        {[...Array(5)].map((_, i) => (
          <motion.span
            key={i}
            className="text-xl"
            animate={{
              y: [0, -10, 0],
              opacity: [0.5, 1, 0.5],
            }}
            transition={{
              duration: 1,
              repeat: Infinity,
              delay: i * 0.2,
            }}
          >
            {["üéÑ", "‚≠ê", "üéÅ", "‚ùÑÔ∏è", "‚ú®"][i]}
          </motion.span>
        ))}
      </div>

      {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 2 }}
        className="mt-4 text-center text-xs text-[#a8d8ea]/50"
      >
        <p>‚è±Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 1-5 –º–∏–Ω—É—Ç</p>
        <p>–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É!</p>
      </motion.div>
    </motion.div>
  );
}



================================================================================
–§–ê–ô–õ 60/69: components\Snowfall.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\components\Snowfall.tsx
================================================================================

"use client";

import { useEffect, useState } from "react";
import { motion } from "framer-motion";

interface Snowflake {
  id: number;
  x: number;
  size: number;
  duration: number;
  delay: number;
  opacity: number;
  symbol: string;
  drift: number;
}

const snowSymbols = ["‚ùÑ", "‚ùÖ", "‚ùÜ", "‚úª", "‚úº", "‚ùâ"];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
function seededRandom(seed: number): number {
  const x = Math.sin(seed * 9999) * 10000;
  return x - Math.floor(x);
}

export default function Snowfall() {
  const [snowflakes, setSnowflakes] = useState<Snowflake[]>([]);
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setIsClient(true);

    const flakes: Snowflake[] = [];
    for (let i = 0; i < 40; i++) {
      const seed = i + 1;
      flakes.push({
        id: i,
        x: seededRandom(seed * 1) * 100,
        size: seededRandom(seed * 2) * 1.2 + 0.5,
        duration: seededRandom(seed * 3) * 10 + 10,
        delay: seededRandom(seed * 4) * 10,
        opacity: seededRandom(seed * 5) * 0.5 + 0.3,
        symbol: snowSymbols[Math.floor(seededRandom(seed * 6) * snowSymbols.length)],
        drift: (seededRandom(seed * 7) - 0.5) * 15,
      });
    }
    setSnowflakes(flakes);
  }, []);

  // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  if (!isClient) {
    return null;
  }

  return (
    <div className="fixed inset-0 pointer-events-none overflow-hidden z-0">
      {snowflakes.map((flake) => (
        <motion.div
          key={flake.id}
          className="snowflake"
          initial={{
            x: `${flake.x}vw`,
            y: "-5vh",
            rotate: 0
          }}
          animate={{
            y: "105vh",
            rotate: 360,
            x: [
              `${flake.x}vw`,
              `${flake.x + flake.drift}vw`,
              `${flake.x}vw`,
            ]
          }}
          transition={{
            duration: flake.duration,
            repeat: Infinity,
            delay: flake.delay,
            ease: "linear",
            x: {
              duration: flake.duration / 2,
              repeat: Infinity,
              ease: "easeInOut"
            }
          }}
          style={{
            fontSize: `${flake.size}rem`,
            opacity: flake.opacity,
          }}
        >
          {flake.symbol}
        </motion.div>
      ))}
    </div>
  );
}



================================================================================
–§–ê–ô–õ 61/69: components\VideoPlayer.tsx
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\components\VideoPlayer.tsx
================================================================================

"use client";

import { motion } from "framer-motion";
import { Maximize, Pause, Play, Volume2, VolumeX, RotateCcw } from "lucide-react";
import { useRef, useState } from "react";

interface VideoPlayerProps {
  videoUrl: string;
  childName: string;
}

export default function VideoPlayer({ videoUrl, childName }: VideoPlayerProps) {
  const [isPlaying, setIsPlaying] = useState(false);
  const [isMuted, setIsMuted] = useState(false);
  const [progress, setProgress] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [hasError, setHasError] = useState(false);
  const videoRef = useRef<HTMLVideoElement>(null);

  const togglePlay = () => {
    if (videoRef.current) {
      if (isPlaying) {
        videoRef.current.pause();
      } else {
        videoRef.current.play();
      }
      setIsPlaying(!isPlaying);
    }
  };

  const toggleMute = () => {
    if (videoRef.current) {
      videoRef.current.muted = !isMuted;
      setIsMuted(!isMuted);
    }
  };

  const handleTimeUpdate = () => {
    if (videoRef.current) {
      const current = videoRef.current.currentTime;
      const duration = videoRef.current.duration;
      if (duration > 0) {
        setProgress((current / duration) * 100);
      }
    }
  };

  const handleProgressClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (videoRef.current && videoRef.current.duration) {
      const rect = e.currentTarget.getBoundingClientRect();
      const clickPosition = (e.clientX - rect.left) / rect.width;
      videoRef.current.currentTime = clickPosition * videoRef.current.duration;
    }
  };

  const toggleFullscreen = () => {
    if (videoRef.current) {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        videoRef.current.requestFullscreen();
      }
    }
  };

  const handleLoadedData = () => {
    setIsLoading(false);
    setHasError(false);
  };

  const handleError = () => {
    setIsLoading(false);
    setHasError(true);
  };

  const handleReplay = () => {
    if (videoRef.current) {
      videoRef.current.currentTime = 0;
      videoRef.current.play();
      setIsPlaying(true);
    }
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="relative rounded-2xl overflow-hidden bg-black group"
    >
      {/* Video */}
      <video
        ref={videoRef}
        src={videoUrl}
        className="w-full aspect-video object-contain bg-black"
        onTimeUpdate={handleTimeUpdate}
        onEnded={() => setIsPlaying(false)}
        onLoadedData={handleLoadedData}
        onError={handleError}
        playsInline
        preload="metadata"
      />

      {/* Loading state */}
      {isLoading && !hasError && (
        <div className="absolute inset-0 flex items-center justify-center bg-black/80">
          <div className="text-center">
            <motion.div
              animate={{ rotate: 360 }}
              transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
              className="w-12 h-12 border-4 border-[#ffd700]/30 border-t-[#ffd700] rounded-full mx-auto mb-4"
            />
            <p className="text-[#a8d8ea]">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</p>
          </div>
        </div>
      )}

      {/* Error state */}
      {hasError && (
        <div className="absolute inset-0 flex items-center justify-center bg-black/80">
          <div className="text-center p-6">
            <span className="text-4xl mb-4 block">‚ùå</span>
            <p className="text-red-400 font-semibold mb-2">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</p>
            <p className="text-[#a8d8ea]/60 text-sm mb-4">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ –Ω–∞–ø—Ä—è–º—É—é</p>
            <a
              href={videoUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-block px-4 py-2 bg-[#c41e3a] text-white rounded-lg hover:bg-[#e74c3c] transition-colors"
            >
              –û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ
            </a>
          </div>
        </div>
      )}

      {/* Overlay –ø—Ä–∏ –ø–∞—É–∑–µ */}
      {!isPlaying && !isLoading && !hasError && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="absolute inset-0 flex items-center justify-center"
          style={{
            background: "linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.1) 100%)"
          }}
        >
          <motion.button
            whileHover={{ scale: 1.1 }}
            whileTap={{ scale: 0.95 }}
            onClick={togglePlay}
            className="w-20 h-20 rounded-full flex items-center justify-center"
            style={{
              background: "linear-gradient(135deg, #c41e3a 0%, #e74c3c 100%)",
              boxShadow: "0 0 40px rgba(196, 30, 58, 0.5), 0 0 80px rgba(255, 215, 0, 0.3)",
            }}
          >
            <Play className="w-10 h-10 text-white ml-1" fill="white" />
          </motion.button>
        </motion.div>
      )}

      {/* –ö–æ–Ω—Ç—Ä–æ–ª—ã */}
      <div
        className="absolute bottom-0 left-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
        style={{
          background: "linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 50%, transparent 100%)"
        }}
      >
        {/* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */}
        <div
          className="h-1.5 bg-white/20 rounded-full cursor-pointer mb-3 overflow-hidden"
          onClick={handleProgressClick}
        >
          <motion.div
            className="h-full rounded-full"
            style={{
              width: `${progress}%`,
              background: "linear-gradient(90deg, #ffd700 0%, #c41e3a 100%)"
            }}
          />
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <button
              onClick={togglePlay}
              className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors"
              title={isPlaying ? "–ü–∞—É–∑–∞" : "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏"}
            >
              {isPlaying ? (
                <Pause className="w-5 h-5 text-white" />
              ) : (
                <Play className="w-5 h-5 text-white" fill="white" />
              )}
            </button>

            <button
              onClick={handleReplay}
              className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors"
              title="–°–Ω–∞—á–∞–ª–∞"
            >
              <RotateCcw className="w-5 h-5 text-white" />
            </button>

            <button
              onClick={toggleMute}
              className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors"
              title={isMuted ? "–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫" : "–í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫"}
            >
              {isMuted ? (
                <VolumeX className="w-5 h-5 text-white" />
              ) : (
                <Volume2 className="w-5 h-5 text-white" />
              )}
            </button>
          </div>

          <div className="flex items-center gap-3">
            <span className="text-white/80 text-sm font-medium hidden sm:block">
              üéÑ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è {childName}
            </span>

            <button
              onClick={toggleFullscreen}
              className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors"
              title="–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω"
            >
              <Maximize className="w-5 h-5 text-white" />
            </button>
          </div>
        </div>
      </div>
    </motion.div>
  );
}



================================================================================
–§–ê–ô–õ 62/69: lib\auth.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\lib\auth.ts
================================================================================

import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { JWT_SECRET } from './config';

export interface UserPayload {
  id: number;
  email: string;
  name: string;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞
export function generateToken(user: UserPayload): string {
  return jwt.sign(user, JWT_SECRET, { expiresIn: '30d' });
}

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞
export function verifyToken(token: string): UserPayload | null {
  try {
    return jwt.verify(token, JWT_SECRET) as UserPayload;
  } catch {
    return null;
  }
}

// –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, 10);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
export async function comparePassword(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash);
}

// –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è middleware)
export function getUserFromRequest(request: Request): UserPayload | null {
  const authHeader = request.headers.get('authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return null;
  }

  const token = authHeader.substring(7);
  return verifyToken(token);
}



================================================================================
–§–ê–ô–õ 63/69: lib\config.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\lib\config.ts
================================================================================

/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
 */

import path from 'path';

// === –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ===
// –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞—è
export const JWT_SECRET =
  process.env.JWT_SECRET?.trim() || 'your-super-secret-jwt-key-change-in-production-2024';

// === API Yes AI (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ) ===
export const YES_AI_API_BASE = process.env.YES_AI_API_BASE || 'https://api.yesai.su/v2';
export const YES_AI_TOKEN = process.env.YES_AI_TOKEN || '';

// === FFmpeg ===
export const FFMPEG_PATH = process.env.FFMPEG_PATH || '/usr/bin/ffmpeg';

// === –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã ===
export const ADMIN_EMAILS: string[] = (process.env.ADMIN_EMAILS || 'system@gmail.com')
  .split(',')
  .map((email) => email.trim().toLowerCase());

// === –ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Bitbanker ===
export const BITBANKER_API_KEY = process.env.BITBANKER_API_KEY || '';
export const BITBANKER_SECRET = process.env.BITBANKER_SECRET || '';
export const BITBANKER_API_URL = 'https://api.aws.bitbanker.org/latest/api/v1';

// –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã
export const BITBANKER_PAYMENT_CURRENCIES = [
  'BTC',
  'ETH',
  'USDT',
  'USDC',
  'TRX',
  'ATOM',
  'AVAX',
  'LTC',
] as const;
export type BitbankerCurrency = (typeof BITBANKER_PAYMENT_CURRENCIES)[number];

// === URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
// NEXT_PUBLIC_BASE_URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –≤ Next.js
export const BASE_URL = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

// === –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ===
export const SUPPORT_TELEGRAM = process.env.SUPPORT_TELEGRAM || '@your_support_bot';
export const SUPPORT_EMAIL = process.env.SUPPORT_EMAIL || 'support@your-domain.com';

// === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ ===
export const SERVICE_COST = Number(process.env.SERVICE_COST) || 0;
export const VIDEO_EXPIRY_DAYS = Number(process.env.VIDEO_EXPIRY_DAYS) || 7;
export const GENERATION_TIMEOUT_MINUTES = Number(process.env.GENERATION_TIMEOUT_MINUTES) || 15;

// === –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ===
// –î–ª—è Amvera –∏—Å–ø–æ–ª—å–∑—É–µ–º /data/app.db (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
export const DATABASE_PATH = process.env.DATABASE_PATH || '/data/app.db';

// === –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∏–¥–µ–æ ===
// –î–ª—è Amvera –∏—Å–ø–æ–ª—å–∑—É–µ–º /data/videos (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
// Next.js –±—É–¥–µ—Ç —Ä–∞–∑–¥–∞–≤–∞—Ç—å –∏–∑ public/videos —á–µ—Ä–µ–∑ —Å–∏–º–ª–∏–Ω–∫
export const VIDEO_STORAGE_PATH = process.env.VIDEO_STORAGE_PATH || '/data/videos';
export const VIDEO_PUBLIC_PATH =
  process.env.VIDEO_PUBLIC_PATH || path.join(process.cwd(), 'public', 'videos');

// === –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ ===
export const VIDEO_PROMPTS = {
  intro: `–î–µ–¥ –ú–æ—Ä–æ–∑ –≤ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä—É—Å—Å–∫–æ–π –∫—Ä–∞—Å–Ω–æ–π —à—É–±–µ —Å –±–µ–ª—ã–º –º–µ—Ö–æ–º —Å–∏–¥–∏—Ç —É —Å—Ç–æ–ª–∞ –≤ —É—é—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ. –ù–∞ —Ñ–æ–Ω–µ –±–æ–ª—å—à–∞—è —É–∫—Ä–∞—à–µ–Ω–Ω–∞—è –Ω–æ–≤–æ–≥–æ–¥–Ω—è—è —ë–ª–∫–∞ —Å –≥–∏—Ä–ª—è–Ω–¥–∞–º–∏ –∏ –∏–≥—Ä—É—à–∫–∞–º–∏, –≥–æ—Ä–∏—Ç –∫–∞–º–∏–Ω, –∑–∞ –æ–∫–Ω–æ–º –ø–∞–¥–∞–µ—Ç —Å–Ω–µ–≥. –¢—ë–ø–ª–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç –≤–æ–ª—à–µ–±–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É. –î–µ–¥ –ú–æ—Ä–æ–∑ –¥–æ–±—Ä–æ —É–ª—ã–±–∞–µ—Ç—Å—è, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–ª—à–µ–±–Ω—É—é –∫–Ω–∏–≥—É –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –≤ –∫–∞–º–µ—Ä—É. –û–Ω –º–∞—à–µ—Ç —Ä—É–∫–æ–π –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ —Å–∫–∞–∑–æ—á–Ω–∞—è, –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–∞—è, —É—é—Ç–Ω–∞—è. –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –≤—ã—Å–æ–∫–æ–µ, –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω–æ–µ. –î–µ–¥ –ú–æ—Ä–æ–∑ –≥–æ–≤–æ—Ä–∏—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –∏ —á–µ—Ç–∫–æ, –¥–µ–ª–∞—è –ø–∞—É–∑—ã –º–µ–∂–¥—É —Ñ—Ä–∞–∑–∞–º–∏, —á—Ç–æ–±—ã –≤—Å–µ —Å–ª–æ–≤–∞ –±—ã–ª–∏ –ø–æ–Ω—è—Ç–Ω—ã. –í–ê–ñ–ù–û: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–æ–≤–Ω–æ 20 —Å–µ–∫—É–Ω–¥. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ä–µ—á—å –∏ –¥–µ–π—Å—Ç–≤–∏—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –Ω–∞ –≤—Å–µ 20 —Å–µ–∫—É–Ω–¥, –Ω–µ –æ–±—Ä—ã–≤–∞–π—Ç–µ –≤–∏–¥–µ–æ —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.`,
  outro: `–î–µ–¥ –ú–æ—Ä–æ–∑ –≤ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä—É—Å—Å–∫–æ–π –∫—Ä–∞—Å–Ω–æ–π —à—É–±–µ —Å—Ç–æ–∏—Ç —É —É–∫—Ä–∞—à–µ–Ω–Ω–æ–π –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–π —ë–ª–∫–∏ —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏. –í–æ–∫—Ä—É–≥ –ª–µ—Ç–∞—é—Ç —Å–Ω–µ–∂–∏–Ω–∫–∏ –∏ –≤–æ–ª—à–µ–±–Ω—ã–µ –∏—Å–∫—Ä—ã. –û–Ω –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ä—É–∫—É –≤ –ø—Ä–æ—â–∞–ª—å–Ω–æ–º –∂–µ—Å—Ç–µ, –ø–æ—Å–æ—Ö —Å–≤–µ—Ç–∏—Ç—Å—è –º–∞–≥–∏—á–µ—Å–∫–∏–º —Å–≤–µ—Ç–æ–º. –ö–∞–º–µ—Ä–∞ –ø–ª–∞–≤–Ω–æ –æ—Ç—ä–µ–∑–∂–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—è –≤—Å—é –∫—Ä–∞—Å–æ—Ç—É –∑–∏–º–Ω–µ–π —Å–∫–∞–∑–∫–∏. –í –∫–∞–¥—Ä–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∑–æ–ª–æ—Ç—ã–µ –Ω–∞–¥–ø–∏—Å–∏ "–° –ù–æ–≤—ã–º 2026 –ì–æ–¥–æ–º!". –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ —Ç–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏ –≤–æ–ª—à–µ–±–Ω–∞—è. –î–µ–¥ –ú–æ—Ä–æ–∑ –≥–æ–≤–æ—Ä–∏—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –∏ —á–µ—Ç–∫–æ, –¥–µ–ª–∞—è –ø–∞—É–∑—ã –º–µ–∂–¥—É —Ñ—Ä–∞–∑–∞–º–∏, —á—Ç–æ–±—ã –≤—Å–µ —Å–ª–æ–≤–∞ –±—ã–ª–∏ –ø–æ–Ω—è—Ç–Ω—ã. –í–ê–ñ–ù–û: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–æ–≤–Ω–æ 20 —Å–µ–∫—É–Ω–¥. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ä–µ—á—å –∏ –¥–µ–π—Å—Ç–≤–∏—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –Ω–∞ –≤—Å–µ 20 —Å–µ–∫—É–Ω–¥, –Ω–µ –æ–±—Ä—ã–≤–∞–π—Ç–µ –≤–∏–¥–µ–æ —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.`,
};

// === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ===
export function validateConfig(): { valid: boolean; errors: string[] } {
  const errors: string[] = [];

  if (!YES_AI_TOKEN) {
    errors.push('YES_AI_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å');
  }

  if (JWT_SECRET === 'your-super-secret-jwt-key-change-in-production-2024') {
    errors.push('JWT_SECRET –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞!');
  }

  if (!BITBANKER_API_KEY && SERVICE_COST > 0) {
    errors.push('BITBANKER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å');
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}

// === –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞ ===
export function isAdmin(email: string): boolean {
  const normalizedEmail = email.toLowerCase().trim();
  return ADMIN_EMAILS.includes(normalizedEmail) || normalizedEmail.endsWith('@admin.com');
}



================================================================================
–§–ê–ô–õ 64/69: lib\db.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\lib\db.ts
================================================================================

import fs from 'fs';
import path from 'path';
import sqlite3 from 'sqlite3';
import { DATABASE_PATH, VIDEO_EXPIRY_DAYS } from './config';

const DB_PATH = DATABASE_PATH.startsWith('./')
  ? path.join(process.cwd(), DATABASE_PATH.slice(2))
  : DATABASE_PATH;

// –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ë–î –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
const dbDir = path.dirname(DB_PATH);
if (dbDir !== '.' && !fs.existsSync(dbDir)) {
  try {
    fs.mkdirSync(dbDir, { recursive: true });
  } catch (error) {
    console.warn(`Could not create database directory ${dbDir}:`, error);
  }
}

// === –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î ===

export function getDb(): Promise<sqlite3.Database> {
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(DB_PATH, (err) => {
      if (err) {
        reject(err);
      } else {
        resolve(db);
      }
    });
  });
}

export function run(
  db: sqlite3.Database,
  sql: string,
  params: any[] = []
): Promise<sqlite3.RunResult> {
  return new Promise((resolve, reject) => {
    db.run(sql, params, function (err) {
      if (err) {
        reject(err);
      } else {
        resolve(this);
      }
    });
  });
}

export function get(db: sqlite3.Database, sql: string, params: any[] = []): Promise<any> {
  return new Promise((resolve, reject) => {
    db.get(sql, params, (err, row) => {
      if (err) {
        reject(err);
      } else {
        resolve(row);
      }
    });
  });
}

export function all(db: sqlite3.Database, sql: string, params: any[] = []): Promise<any[]> {
  return new Promise((resolve, reject) => {
    db.all(sql, params, (err, rows) => {
      if (err) {
        reject(err);
      } else {
        resolve(rows || []);
      }
    });
  });
}

// === Singleton –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î ===

let dbInitPromise: Promise<void> | null = null;

export function ensureDbInitialized(): Promise<void> {
  if (!dbInitPromise) {
    dbInitPromise = initDb().catch((err) => {
      console.error('DB init error:', err);
      dbInitPromise = null;
      throw err;
    });
  }
  return dbInitPromise;
}

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ===

export async function initDb() {
  const db = await getDb();

  // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  await run(
    db,
    `CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      email TEXT UNIQUE NOT NULL,
      password TEXT NOT NULL,
      nickname TEXT NOT NULL,
      first_name TEXT NOT NULL,
      last_name TEXT NOT NULL,
      balance REAL DEFAULT 0,
      email_verified INTEGER DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`
  );

  // –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤
  await run(
    db,
    `CREATE TABLE IF NOT EXISTS orders (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      order_number TEXT UNIQUE NOT NULL,
      service_name TEXT NOT NULL,
      task_id INTEGER,
      child_name TEXT NOT NULL,
      photo1_url TEXT,
      photo1_comment TEXT,
      photo2_url TEXT,
      photo2_comment TEXT,
      video_url TEXT,
      status TEXT DEFAULT 'pending',
      status_description TEXT,
      cost REAL NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      completed_at DATETIME,
      video_expires_at DATETIME,
      FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    )`
  );

  // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
  await run(
    db,
    `CREATE TABLE IF NOT EXISTS balance_transactions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      amount REAL NOT NULL,
      type TEXT NOT NULL,
      status TEXT DEFAULT 'pending',
      invoice_id TEXT,
      invoice_url TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      completed_at DATETIME,
      FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    )`
  );

  // –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  await run(
    db,
    `CREATE TABLE IF NOT EXISTS settings (
      key TEXT PRIMARY KEY,
      value TEXT NOT NULL,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`
  );

  // –¢–∞–±–ª–∏—Ü–∞ –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
  await run(
    db,
    `CREATE TABLE IF NOT EXISTS video_queue (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      order_id INTEGER NOT NULL,
      task_type TEXT NOT NULL,
      task_id INTEGER,
      status TEXT DEFAULT 'pending',
      priority INTEGER DEFAULT 0,
      error_message TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
    )`
  );

  // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ (intro/outro)
  await run(
    db,
    `CREATE TABLE IF NOT EXISTS universal_videos (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      video_type TEXT UNIQUE NOT NULL,
      task_id INTEGER,
      status TEXT DEFAULT 'pending',
      video_url TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`
  );

  // –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  await run(db, `CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id)`);
  await run(db, `CREATE INDEX IF NOT EXISTS idx_orders_task_id ON orders(task_id)`);
  await run(db, `CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at DESC)`);
  await run(db, `CREATE INDEX IF NOT EXISTS idx_balance_user_id ON balance_transactions(user_id)`);
  await run(db, `CREATE INDEX IF NOT EXISTS idx_balance_status ON balance_transactions(status)`);
  await run(db, `CREATE INDEX IF NOT EXISTS idx_video_queue_order_id ON video_queue(order_id)`);
  await run(db, `CREATE INDEX IF NOT EXISTS idx_video_queue_status ON video_queue(status)`);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  await run(
    db,
    `INSERT OR IGNORE INTO settings (key, value) VALUES ('email_verification_required', '0')`
  );
  await run(
    db,
    `INSERT OR IGNORE INTO settings (key, value) VALUES ('user_agreement_text', '–¢–µ–∫—Å—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è...')`
  );

  db.close();
  console.log('Database initialized successfully');
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ===

export async function getUserByEmail(email: string) {
  const db = await getDb();
  const user = await get(db, 'SELECT * FROM users WHERE email = ?', [email]);
  db.close();
  return user;
}

export async function getUserById(id: number) {
  const db = await getDb();
  const user = await get(
    db,
    'SELECT id, email, nickname, first_name, last_name, balance, email_verified, created_at FROM users WHERE id = ?',
    [id]
  );
  db.close();
  return user;
}

export async function createUser(
  email: string,
  password: string,
  nickname: string,
  firstName: string,
  lastName: string
) {
  const db = await getDb();
  const result = await run(
    db,
    'INSERT INTO users (email, password, nickname, first_name, last_name) VALUES (?, ?, ?, ?, ?)',
    [email, password, nickname, firstName, lastName]
  );
  db.close();
  return result.lastID;
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏ ===

function generateOrderNumber(): string {
  return `ORD${Date.now()}${Math.floor(Math.random() * 1000)}`;
}

export async function createOrder(
  userId: number,
  childName: string,
  photo1Url: string,
  photo1Comment: string,
  photo2Url: string,
  photo2Comment: string,
  cost: number
) {
  const db = await getDb();
  const orderNumber = generateOrderNumber();
  const result = await run(
    db,
    `INSERT INTO orders (user_id, order_number, service_name, child_name, photo1_url, photo1_comment, photo2_url, photo2_comment, cost, status)
     VALUES (?, ?, '–°–æ–∑–¥–∞–Ω–∏–µ –í–∏–¥–µ–æ –î–µ–¥ –ú–æ—Ä–æ–∑', ?, ?, ?, ?, ?, ?, 'pending')`,
    [userId, orderNumber, childName, photo1Url, photo1Comment, photo2Url, photo2Comment, cost]
  );
  db.close();
  return { orderId: result.lastID, orderNumber };
}

export async function updateOrderTaskId(orderId: number, taskId: number) {
  const db = await getDb();
  await run(db, 'UPDATE orders SET task_id = ? WHERE id = ?', [taskId, orderId]);
  db.close();
}

export async function updateOrderStatus(
  taskId: number,
  status: string,
  statusDescription: string,
  videoUrl?: string,
  errorMessage?: string
) {
  const db = await getDb();
  const completedAt = status === 'completed' ? new Date().toISOString() : null;
  const expiresAt = videoUrl
    ? new Date(Date.now() + VIDEO_EXPIRY_DAYS * 24 * 60 * 60 * 1000).toISOString()
    : null;

  if (videoUrl) {
    await run(
      db,
      `UPDATE orders
       SET status = ?, status_description = ?, video_url = ?, completed_at = ?, video_expires_at = ?
       WHERE task_id = ?`,
      [status, statusDescription, videoUrl, completedAt, expiresAt, taskId]
    );
  } else {
    await run(
      db,
      `UPDATE orders
       SET status = ?, status_description = ?, completed_at = ?
       WHERE task_id = ?`,
      [status, statusDescription, completedAt, taskId]
    );
  }
  db.close();
}

export async function getUserOrders(userId: number, limit: number = 50) {
  const db = await getDb();
  const orders = await all(
    db,
    `SELECT id, order_number, service_name, task_id, child_name, status, status_description, created_at, completed_at, video_url
     FROM orders
     WHERE user_id = ?
     ORDER BY created_at DESC
     LIMIT ?`,
    [userId, limit]
  );
  db.close();
  return orders;
}

export async function getOrderByTaskId(taskId: number) {
  const db = await getDb();
  const order = await get(db, 'SELECT * FROM orders WHERE task_id = ?', [taskId]);
  db.close();
  return order;
}

export async function getOrderById(orderId: number) {
  const db = await getDb();
  const order = await get(db, 'SELECT * FROM orders WHERE id = ?', [orderId]);
  db.close();
  return order;
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º ===

export async function getUserBalance(userId: number): Promise<number> {
  const db = await getDb();
  const user = await get(db, 'SELECT balance FROM users WHERE id = ?', [userId]);
  db.close();
  return user?.balance || 0;
}

export async function updateUserBalance(userId: number, amount: number) {
  const db = await getDb();
  await run(db, 'UPDATE users SET balance = balance + ? WHERE id = ?', [amount, userId]);
  db.close();
}

export async function createBalanceTransaction(
  userId: number,
  amount: number,
  type: string,
  invoiceId?: string,
  invoiceUrl?: string
) {
  const db = await getDb();
  const result = await run(
    db,
    `INSERT INTO balance_transactions (user_id, amount, type, invoice_id, invoice_url, status)
     VALUES (?, ?, ?, ?, ?, 'pending')`,
    [userId, amount, type, invoiceId || null, invoiceUrl || null]
  );
  db.close();
  return result.lastID;
}

export async function getUserBalanceTransactions(userId: number) {
  const db = await getDb();
  const transactions = await all(
    db,
    `SELECT * FROM balance_transactions
     WHERE user_id = ?
     ORDER BY created_at DESC`,
    [userId]
  );
  db.close();
  return transactions;
}

export async function getBalanceTransactionByInvoiceId(invoiceId: string) {
  const db = await getDb();
  const transaction = await get(db, 'SELECT * FROM balance_transactions WHERE invoice_id = ?', [
    invoiceId,
  ]);
  db.close();
  return transaction;
}

export async function completeBalanceTransaction(transactionId: number) {
  const db = await getDb();
  await run(db, 'UPDATE balance_transactions SET status = ?, completed_at = ? WHERE id = ?', [
    'completed',
    new Date().toISOString(),
    transactionId,
  ]);
  db.close();
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ ===

export async function getSetting(key: string): Promise<string | null> {
  const db = await getDb();
  const setting = await get(db, 'SELECT value FROM settings WHERE key = ?', [key]);
  db.close();
  return setting?.value || null;
}

export async function setSetting(key: string, value: string) {
  const db = await getDb();
  await run(
    db,
    'INSERT OR REPLACE INTO settings (key, value, updated_at) VALUES (?, ?, CURRENT_TIMESTAMP)',
    [key, value]
  );
  db.close();
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—å—é –≤–∏–¥–µ–æ ===

export async function addToQueue(
  orderId: number,
  taskType: 'intro' | 'outro' | 'personal',
  priority: number = 0
): Promise<number> {
  const db = await getDb();
  const result = await run(
    db,
    `INSERT INTO video_queue (order_id, task_type, priority, status)
     VALUES (?, ?, ?, 'pending')`,
    [orderId, taskType, priority]
  );
  db.close();
  return result.lastID as number;
}

export async function getNextQueueTask(orderId: number): Promise<{
  id: number;
  order_id: number;
  task_type: 'intro' | 'outro' | 'personal';
  task_id: number | null;
  status: string;
  priority: number;
} | null> {
  const db = await getDb();
  const task = await get(
    db,
    `SELECT * FROM video_queue
     WHERE order_id = ? AND status = 'pending'
     ORDER BY priority DESC, id ASC
     LIMIT 1`,
    [orderId]
  );
  db.close();
  return task || null;
}

export async function getCurrentQueueTask(orderId: number): Promise<{
  id: number;
  order_id: number;
  task_type: 'intro' | 'outro' | 'personal';
  task_id: number | null;
  status: string;
  priority: number;
} | null> {
  const db = await getDb();
  const task = await get(
    db,
    `SELECT * FROM video_queue
     WHERE order_id = ? AND status = 'processing'
     LIMIT 1`,
    [orderId]
  );
  db.close();
  return task || null;
}

export async function updateQueueTaskStatus(
  queueId: number,
  status: 'pending' | 'processing' | 'completed' | 'failed',
  taskId?: number,
  errorMessage?: string
): Promise<void> {
  const db = await getDb();
  if (taskId !== undefined) {
    await run(
      db,
      `UPDATE video_queue SET status = ?, task_id = ?, error_message = ? WHERE id = ?`,
      [status, taskId, errorMessage || null, queueId]
    );
  } else {
    await run(db, `UPDATE video_queue SET status = ?, error_message = ? WHERE id = ?`, [
      status,
      errorMessage || null,
      queueId,
    ]);
  }
  db.close();
}

export async function getQueueProgress(orderId: number): Promise<{
  totalTasks: number;
  completedTasks: number;
  currentTask: {
    id: number;
    task_type: string;
    task_id: number | null;
    status: string;
  } | null;
  allTasks: Array<{
    id: number;
    task_type: string;
    task_id: number | null;
    status: string;
  }>;
}> {
  const db = await getDb();
  const allTasks = await all(
    db,
    `SELECT id, task_type, task_id, status FROM video_queue
     WHERE order_id = ?
     ORDER BY priority DESC, id ASC`,
    [orderId]
  );

  const completedTasks = allTasks.filter((t) => t.status === 'completed').length;
  const currentTask = allTasks.find((t) => t.status === 'processing') || null;

  db.close();
  return {
    totalTasks: allTasks.length,
    completedTasks,
    currentTask,
    allTasks,
  };
}

export async function getQueueTasks(orderId: number): Promise<
  Array<{
    id: number;
    order_id: number;
    task_type: string;
    task_id: number | null;
    status: string;
    priority: number;
    error_message: string | null;
  }>
> {
  const db = await getDb();
  const tasks = await all(
    db,
    `SELECT * FROM video_queue WHERE order_id = ? ORDER BY priority DESC, id ASC`,
    [orderId]
  );
  db.close();
  return tasks;
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º–∏ –≤–∏–¥–µ–æ ===

export async function setUniversalVideo(
  videoType: 'intro' | 'outro',
  taskId: number,
  status: 'pending' | 'processing' | 'completed' | 'failed' = 'pending'
): Promise<void> {
  const db = await getDb();
  await run(
    db,
    `INSERT OR REPLACE INTO universal_videos (video_type, task_id, status, updated_at)
     VALUES (?, ?, ?, CURRENT_TIMESTAMP)`,
    [videoType, taskId, status]
  );
  db.close();
}

export async function getUniversalVideo(videoType: 'intro' | 'outro'): Promise<{
  task_id: number;
  status: string;
  video_url: string | null;
  created_at: string;
  updated_at: string;
} | null> {
  const db = await getDb();
  const video = await get(
    db,
    `SELECT task_id, status, video_url, created_at, updated_at FROM universal_videos WHERE video_type = ?`,
    [videoType]
  );
  db.close();
  return video || null;
}

export async function updateUniversalVideoStatus(
  videoType: 'intro' | 'outro',
  status: 'pending' | 'processing' | 'completed' | 'failed',
  videoUrl?: string
): Promise<void> {
  const db = await getDb();
  if (videoUrl) {
    await run(
      db,
      `UPDATE universal_videos SET status = ?, video_url = ?, updated_at = CURRENT_TIMESTAMP WHERE video_type = ?`,
      [status, videoUrl, videoType]
    );
  } else {
    await run(
      db,
      `UPDATE universal_videos SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE video_type = ?`,
      [status, videoType]
    );
  }
  db.close();
}

// === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ ===

export async function getAllUsers() {
  const db = await getDb();
  const users = await all(
    db,
    `SELECT u.id, u.email, u.nickname, u.first_name, u.last_name, u.balance, u.created_at,
            (SELECT COUNT(*) FROM orders WHERE user_id = u.id) as orders_count
     FROM users u
     ORDER BY u.created_at DESC`
  );
  db.close();
  return users;
}

export async function searchUsers(query: string) {
  const db = await getDb();
  const searchPattern = `%${query}%`;
  const users = await all(
    db,
    `SELECT u.id, u.email, u.nickname, u.first_name, u.last_name, u.balance, u.created_at,
            (SELECT COUNT(*) FROM orders WHERE user_id = u.id) as orders_count
     FROM users u
     WHERE u.email LIKE ? OR u.nickname LIKE ? OR u.first_name LIKE ? OR u.last_name LIKE ?
     ORDER BY u.created_at DESC`,
    [searchPattern, searchPattern, searchPattern, searchPattern]
  );
  db.close();
  return users;
}

export async function getUserOrdersAdmin(userId: number) {
  const db = await getDb();
  const orders = await all(
    db,
    `SELECT id, order_number, service_name, status, created_at, video_url
     FROM orders WHERE user_id = ? ORDER BY created_at DESC`,
    [userId]
  );
  db.close();
  return orders;
}

export async function getUserTransactionsAdmin(userId: number) {
  const db = await getDb();
  const transactions = await all(
    db,
    `SELECT * FROM balance_transactions WHERE user_id = ? ORDER BY created_at DESC`,
    [userId]
  );
  db.close();
  return transactions;
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
export async function getAllTransactionsAdmin(
  startDate?: string,
  endDate?: string,
  status?: 'all' | 'completed' | 'pending',
  nickname?: string
) {
  const db = await getDb();
  let query = `
    SELECT
      bt.id,
      bt.user_id,
      bt.amount,
      bt.type,
      bt.status,
      bt.invoice_id,
      bt.invoice_url,
      bt.created_at,
      bt.completed_at,
      u.nickname,
      u.email,
      u.first_name,
      u.last_name
    FROM balance_transactions bt
    LEFT JOIN users u ON bt.user_id = u.id
    WHERE 1=1
  `;
  const params: any[] = [];

  if (startDate) {
    query += ` AND DATE(bt.created_at) >= DATE(?)`;
    params.push(startDate);
  }

  if (endDate) {
    query += ` AND DATE(bt.created_at) <= DATE(?)`;
    params.push(endDate);
  }

  if (status && status !== 'all') {
    query += ` AND bt.status = ?`;
    params.push(status);
  }

  if (nickname) {
    query += ` AND (u.nickname LIKE ? OR u.email LIKE ? OR u.first_name LIKE ? OR u.last_name LIKE ?)`;
    const searchPattern = `%${nickname}%`;
    params.push(searchPattern, searchPattern, searchPattern, searchPattern);
  }

  query += ` ORDER BY bt.created_at DESC`;

  const transactions = await all(db, query, params);
  db.close();
  return transactions;
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –≤–∏–¥–µ–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤
export async function getCompletedOrdersWithFinalVideos(): Promise<
  Array<{
    id: number;
    video_url: string;
  }>
> {
  const db = await getDb();
  const orders = await all(
    db,
    `SELECT id, video_url
     FROM orders
     WHERE status = 'completed'
       AND video_url IS NOT NULL
       AND video_url LIKE '/api/videos/stream/final/%'
     ORDER BY completed_at DESC
     LIMIT 100`,
    []
  );
  db.close();
  return orders;
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –∑–∞–∫–∞–∑—ã (–≤–∏–¥–µ–æ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
export async function getExpiredOrders(): Promise<
  Array<{
    id: number;
    video_url: string;
    video_expires_at: string;
  }>
> {
  const db = await getDb();
  const orders = await all(
    db,
    `SELECT id, video_url, video_expires_at
     FROM orders
     WHERE video_expires_at IS NOT NULL
       AND video_expires_at < datetime('now')
       AND video_url IS NOT NULL`,
    []
  );
  db.close();
  return orders;
}

// –£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ –∏–∑ –∑–∞–∫–∞–∑–∞ (–æ—á–∏—Å—Ç–∏—Ç—å video_url –∏ video_expires_at)
export async function clearExpiredVideo(orderId: number): Promise<void> {
  const db = await getDb();
  await run(db, `UPDATE orders SET video_url = NULL, video_expires_at = NULL WHERE id = ?`, [
    orderId,
  ]);
  db.close();
}



================================================================================
–§–ê–ô–õ 65/69: lib\reset-tokens.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\lib\reset-tokens.ts
================================================================================

/**
 * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
 * –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –∏–ª–∏ –ë–î
 */

interface ResetTokenData {
  email: string;
  expiresAt: number;
  token: string;
}

const resetTokens = new Map<string, ResetTokenData>();

// –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
setInterval(() => {
  const now = Date.now();
  for (const [token, data] of resetTokens.entries()) {
    if (data.expiresAt < now) {
      resetTokens.delete(token);
    }
  }
}, 10 * 60 * 1000);

export function createResetToken(email: string): string {
  const crypto = require('crypto');
  const resetToken = crypto.randomBytes(32).toString('hex');
  const expiresAt = Date.now() + 60 * 60 * 1000; // 1 —á–∞—Å

  resetTokens.set(resetToken, {
    email,
    expiresAt,
    token: resetToken,
  });

  return resetToken;
}

export function getResetTokenData(token: string): ResetTokenData | undefined {
  const tokenData = resetTokens.get(token);

  if (!tokenData) {
    return undefined;
  }

  if (tokenData.expiresAt < Date.now()) {
    resetTokens.delete(token);
    return undefined;
  }

  return tokenData;
}

export function deleteResetToken(token: string): void {
  resetTokens.delete(token);
}



================================================================================
–§–ê–ô–õ 66/69: lib\video-generator.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\lib\video-generator.ts
================================================================================

import fs from 'fs';
import path from 'path';
import {
  FFMPEG_PATH,
  VIDEO_PROMPTS,
  VIDEO_STORAGE_PATH,
  YES_AI_API_BASE,
  YES_AI_TOKEN,
} from './config';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤–∏–¥–µ–æ (—Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π)
function ensureVideoStorage() {
  const storageDirs = [
    VIDEO_STORAGE_PATH,
    path.join(VIDEO_STORAGE_PATH, 'intro'),
    path.join(VIDEO_STORAGE_PATH, 'outro'),
    path.join(VIDEO_STORAGE_PATH, 'personal'),
    path.join(VIDEO_STORAGE_PATH, 'final'),
    path.join(VIDEO_STORAGE_PATH, 'locks'), // –î–ª—è —Ñ–∞–π–ª-–ª–æ–∫–æ–≤
  ];

  for (const dir of storageDirs) {
    if (!fs.existsSync(dir)) {
      try {
        fs.mkdirSync(dir, { recursive: true });
      } catch (error) {
        console.warn(`Could not create directory ${dir}:`, error);
      }
    }
  }
}

ensureVideoStorage();

const INTRO_PATH = path.join(VIDEO_STORAGE_PATH, 'intro.mp4');
const OUTRO_PATH = path.join(VIDEO_STORAGE_PATH, 'outro.mp4');
const LOCK_DIR = path.join(VIDEO_STORAGE_PATH, 'locks');

// ============== –§–ê–ô–õ–û–í–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê ==============

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∫ –¥–ª—è FFmpeg - —Ç–æ–ª—å–∫–æ –û–î–ò–ù –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
const GLOBAL_FFMPEG_LOCK = path.join(LOCK_DIR, 'ffmpeg_global.lock');
const LOCK_TIMEOUT_MS = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç –º–∞–∫—Å –Ω–∞ –æ–¥–Ω–æ –≤–∏–¥–µ–æ

function acquireGlobalLock(): boolean {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–æ–∫
    if (fs.existsSync(GLOBAL_FFMPEG_LOCK)) {
      const lockData = fs.readFileSync(GLOBAL_FFMPEG_LOCK, 'utf8');
      const lockTime = parseInt(lockData, 10);

      // –ï—Å–ª–∏ –ª–æ–∫ —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç - —É–¥–∞–ª—è–µ–º (–ø—Ä–æ—Ü–µ—Å—Å —É–º–µ—Ä)
      if (Date.now() - lockTime > LOCK_TIMEOUT_MS) {
        console.log('‚ö†Ô∏è Removing stale FFmpeg lock');
        fs.unlinkSync(GLOBAL_FFMPEG_LOCK);
      } else {
        console.log('üîí FFmpeg lock held by another process');
        return false;
      }
    }

    // –°–æ–∑–¥–∞—ë–º –ª–æ–∫ –∞—Ç–æ–º–∞—Ä–Ω–æ (wx = exclusive)
    fs.writeFileSync(GLOBAL_FFMPEG_LOCK, Date.now().toString(), { flag: 'wx' });
    console.log('üîì Acquired FFmpeg lock');
    return true;
  } catch (error: unknown) {
    if (error && typeof error === 'object' && 'code' in error && error.code === 'EEXIST') {
      console.log('üîí FFmpeg lock already exists');
      return false;
    }
    console.error('Lock error:', error);
    return false;
  }
}

function releaseGlobalLock(): void {
  try {
    if (fs.existsSync(GLOBAL_FFMPEG_LOCK)) {
      fs.unlinkSync(GLOBAL_FFMPEG_LOCK);
      console.log('üîì Released FFmpeg lock');
    }
  } catch (error) {
    console.error('Error releasing lock:', error);
  }
}

// –õ–æ–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–æ–≥–æ –∂–µ –∑–∞–∫–∞–∑–∞)
function getFileLockPath(outputPath: string): string {
  const hash = Buffer.from(outputPath).toString('base64').replace(/[/+=]/g, '_');
  return path.join(LOCK_DIR, `file_${hash}.lock`);
}

function isFileLocked(outputPath: string): boolean {
  const lockPath = getFileLockPath(outputPath);
  if (fs.existsSync(lockPath)) {
    try {
      const lockTime = parseInt(fs.readFileSync(lockPath, 'utf8'), 10);
      if (Date.now() - lockTime > LOCK_TIMEOUT_MS) {
        fs.unlinkSync(lockPath);
        return false;
      }
      return true;
    } catch {
      return false;
    }
  }
  return false;
}

function setFileLock(outputPath: string): void {
  const lockPath = getFileLockPath(outputPath);
  fs.writeFileSync(lockPath, Date.now().toString());
}

function removeFileLock(outputPath: string): void {
  const lockPath = getFileLockPath(outputPath);
  try {
    if (fs.existsSync(lockPath)) {
      fs.unlinkSync(lockPath);
    }
  } catch {}
}

// ============== –ò–ù–¢–ï–†–§–ï–ô–°–´ ==============

interface GenerationResult {
  success: boolean;
  taskId?: number;
  error?: string;
}

interface StatusResult {
  success: boolean;
  status: string;
  videoUrl?: string;
  error?: string;
}

// ============== API –§–£–ù–ö–¶–ò–ò ==============

export function checkUniversalVideosExist(): { intro: boolean; outro: boolean } {
  return {
    intro: fs.existsSync(INTRO_PATH),
    outro: fs.existsSync(OUTRO_PATH),
  };
}

export async function createVideoTask(
  prompt: string,
  customerId: string,
  options?: {
    imageUrl?: string;
    resolution?: number;
    dimensions?: string;
    duration?: number;
    effectId?: number;
  }
): Promise<GenerationResult> {
  try {
    if (!YES_AI_TOKEN) {
      console.error('YES_AI_TOKEN not configured');
      return { success: false, error: 'API —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω' };
    }

    const resolution = options?.resolution || 720;
    const dimensions = options?.dimensions || '16:9';
    const duration = options?.duration || 15;
    const effectId = options?.effectId || 0;

    const requestBody: {
      prompt: string;
      customer_id: string;
      resolution: number;
      dimensions: string;
      duration: number;
      effect_id: number;
      version: number;
      image_url?: string;
    } = {
      prompt: prompt,
      customer_id: customerId,
      resolution: resolution,
      dimensions: dimensions,
      duration: duration,
      effect_id: effectId,
      version: 2,
    };

    if (options?.imageUrl) {
      requestBody.image_url = options.imageUrl;
    }

    console.log('Creating video task:', { customerId, resolution, dimensions, duration });

    const response = await fetch(`${YES_AI_API_BASE}/yesvideo/aniimage/sora`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${YES_AI_TOKEN}`,
      },
      body: JSON.stringify(requestBody),
    });

    const data = await response.json();

    if (!data.success) {
      // Fallback –ª–æ–≥–∏–∫–∞ –µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
      if (data.message === 'PARAMETERS_IS_NOT_ALLOWED') {
        return await createVideoTaskFallback(prompt, customerId, options, data);
      }

      // Fallback –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      if (data.message === 'IMAGE_NOT_FOUND' || data.message === 'IMAGE_FILE_SIZE_NOT_VALID') {
        delete requestBody.image_url;
        const retryResponse = await fetch(`${YES_AI_API_BASE}/yesvideo/aniimage/sora`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${YES_AI_TOKEN}`,
          },
          body: JSON.stringify(requestBody),
        });
        const retryData = await retryResponse.json();
        if (retryData.success) {
          return { success: true, taskId: retryData.results?.animation_data?.id };
        }
      }

      return { success: false, error: data.message };
    }

    const taskId = data.results?.animation_data?.id;
    if (!taskId) {
      return { success: false, error: '–ù–µ –ø–æ–ª—É—á–µ–Ω ID –∑–∞–¥–∞–Ω–∏—è' };
    }

    return { success: true, taskId };
  } catch (error) {
    console.error('Create video task error:', error);
    return { success: false, error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è' };
  }
}

async function createVideoTaskFallback(
  prompt: string,
  customerId: string,
  options:
    | {
        imageUrl?: string;
        resolution?: number;
        dimensions?: string;
        duration?: number;
        effectId?: number;
      }
    | undefined,
  errorData: {
    details?: {
      version_parameters?: {
        sora_resolutions?: number[];
        sora_dimensions?: string[];
        sora_durations?: number[];
      };
    };
  }
): Promise<GenerationResult> {
  const versionParams = errorData.details?.version_parameters;
  const availableResolutions = versionParams?.sora_resolutions || [720];
  const availableDimensions = versionParams?.sora_dimensions || ['16:9'];
  const availableDurations = versionParams?.sora_durations || [10, 15];

  const fallbackBody: {
    prompt: string;
    customer_id: string;
    resolution: number;
    dimensions: string;
    duration: number;
    effect_id: number;
    version: number;
  } = {
    prompt,
    customer_id: customerId,
    resolution: availableResolutions[availableResolutions.length - 1],
    dimensions: availableDimensions[0],
    duration: availableDurations[availableDurations.length - 1],
    effect_id: 0,
    version: 2,
  };

  const response = await fetch(`${YES_AI_API_BASE}/yesvideo/aniimage/sora`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${YES_AI_TOKEN}`,
    },
    body: JSON.stringify(fallbackBody),
  });

  const data = await response.json();
  if (!data.success) {
    return { success: false, error: data.message };
  }

  return { success: true, taskId: data.results?.animation_data?.id };
}

// –ö—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤
const statusCache = new Map<number, { result: StatusResult; timestamp: number }>();
const STATUS_CACHE_TTL = 5000;
const MIN_REQUEST_INTERVAL = 2000;
let lastRequestTime = 0;

export async function checkTaskStatus(taskId: number): Promise<StatusResult> {
  try {
    if (!YES_AI_TOKEN) {
      return { success: false, status: 'error', error: 'API —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω' };
    }

    const cached = statusCache.get(taskId);
    if (cached && Date.now() - cached.timestamp < STATUS_CACHE_TTL) {
      return cached.result;
    }

    const now = Date.now();
    const timeSinceLastRequest = now - lastRequestTime;
    if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
      await new Promise((resolve) =>
        setTimeout(resolve, MIN_REQUEST_INTERVAL - timeSinceLastRequest)
      );
    }
    lastRequestTime = Date.now();

    const response = await fetch(`${YES_AI_API_BASE}/yesvideo/animations/${taskId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${YES_AI_TOKEN}`,
      },
    });

    const data = await response.json();

    if (!data.success) {
      const result: StatusResult = { success: false, status: 'error', error: data.message };
      statusCache.set(taskId, { result, timestamp: Date.now() });
      return result;
    }

    const animationData = data.results?.animation_data;
    if (!animationData) {
      const result: StatusResult = { success: false, status: 'error', error: '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' };
      statusCache.set(taskId, { result, timestamp: Date.now() });
      return result;
    }

    const statusDescription = animationData.status_description || '';
    const isRejected = statusDescription.includes('rejected');

    const result: StatusResult = {
      success: true,
      status: statusDescription,
      videoUrl: animationData.result_url || undefined,
      error: isRejected ? animationData.error_message || '–í–∏–¥–µ–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ' : undefined,
    };

    statusCache.set(taskId, { result, timestamp: Date.now() });
    return result;
  } catch (error) {
    console.error('Check task status error:', error);
    return { success: false, status: 'error', error: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞' };
  }
}

export async function downloadVideo(url: string, savePath: string): Promise<boolean> {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Failed to download video');
    }

    const buffer = await response.arrayBuffer();
    const dir = path.dirname(savePath);
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }

    fs.writeFileSync(savePath, Buffer.from(buffer));
    return true;
  } catch (error) {
    console.error('Download video error:', error);
    return false;
  }
}

// ============== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–ú–ü–¢–û–í ==============

export function generatePersonalPrompt(
  childName: string,
  photo1Comment: string,
  photo2Comment: string,
  childAge?: number
): string {
  const ageText = childAge ? `, –∫–æ—Ç–æ—Ä–æ–º—É ${childAge} ${getAgeWord(childAge)}` : '';
  return `–î–µ–¥ –ú–æ—Ä–æ–∑ –≤ –∫—Ä–∞—Å–Ω–æ–π —à—É–±–µ —Å–∏–¥–∏—Ç –≤ —É—é—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ —Å —ë–ª–∫–æ–π. –û–Ω —Å–º–æ—Ç—Ä–∏—Ç –≤ –∫–∞–º–µ—Ä—É –∏ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç —Å–ª–æ–≤–∞, –æ–±—Ä–∞—â–∞—è—Å—å –∫ —Ä–µ–±—ë–Ω–∫—É –ø–æ –∏–º–µ–Ω–∏ ${childName}${ageText}. –í –∫–∞–¥—Ä–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –º—è–≥–∫–æ–µ —Å–∏—è–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–µ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ä–µ–±—ë–Ω–∫–µ - "${photo1Comment}". –ó–∞—Ç–µ–º –ø–ª–∞–≤–Ω—ã–π —Å–Ω–µ–∂–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –¥—Ä—É–≥–æ–º—É –º–æ–º–µ–Ω—Ç—É - "${photo2Comment}". –î–µ–¥ –ú–æ—Ä–æ–∑ —É–ª—ã–±–∞–µ—Ç—Å—è —Å —Ç–µ–ø–ª–æ—Ç–æ–π –∏ –≥–æ—Ä–¥–æ—Å—Ç—å—é. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –≤–æ–ª—à–µ–±–Ω–∞—è, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è, —Ç—ë–ø–ª–∞—è. –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –≤—ã—Å–æ–∫–æ–µ, –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω–æ–µ.`;
}

function getAgeWord(age: number): string {
  const lastDigit = age % 10;
  const lastTwoDigits = age % 100;
  if (lastTwoDigits >= 11 && lastTwoDigits <= 14) return '–ª–µ—Ç';
  if (lastDigit === 1) return '–≥–æ–¥';
  if (lastDigit >= 2 && lastDigit <= 4) return '–≥–æ–¥–∞';
  return '–ª–µ—Ç';
}

export async function generateIntroVideo(customerId: string): Promise<GenerationResult> {
  return createVideoTask(VIDEO_PROMPTS.intro, customerId, {
    resolution: 720,
    dimensions: '16:9',
    duration: 15,
    effectId: 0,
  });
}

export async function generateOutroVideo(customerId: string): Promise<GenerationResult> {
  return createVideoTask(VIDEO_PROMPTS.outro, customerId, {
    resolution: 720,
    dimensions: '16:9',
    duration: 15,
    effectId: 0,
  });
}

export async function saveIntroVideo(videoUrl: string): Promise<boolean> {
  return downloadVideo(videoUrl, INTRO_PATH);
}

export async function saveOutroVideo(videoUrl: string): Promise<boolean> {
  return downloadVideo(videoUrl, OUTRO_PATH);
}

export function getUniversalVideoPaths() {
  const introExists = fs.existsSync(INTRO_PATH);
  const outroExists = fs.existsSync(OUTRO_PATH);

  return {
    intro: INTRO_PATH,
    outro: OUTRO_PATH,
    introPublic: '/videos/intro.mp4',
    outroPublic: '/videos/outro.mp4',
    introExists,
    outroExists,
  };
}

// ============== –°–ö–õ–ï–ô–ö–ê –í–ò–î–ï–û (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø) ==============

export async function concatenateVideos(
  introPath: string,
  personalPath: string,
  outroPath: string,
  outputPath: string
): Promise<boolean> {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
  if (isFileLocked(outputPath)) {
    console.log(`‚è≥ File ${outputPath} is already being processed, skipping`);
    return false;
  }

  // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∫ FFmpeg
  if (!acquireGlobalLock()) {
    console.log('‚è≥ Another FFmpeg process is running, will retry later');
    return false;
  }

  setFileLock(outputPath);

  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
    if (!fs.existsSync(introPath)) {
      console.error('Intro video not found:', introPath);
      releaseGlobalLock();
      removeFileLock(outputPath);
      return false;
    }
    if (!fs.existsSync(personalPath)) {
      console.error('Personal video not found:', personalPath);
      releaseGlobalLock();
      removeFileLock(outputPath);
      return false;
    }
    if (!fs.existsSync(outroPath)) {
      console.error('Outro video not found:', outroPath);
      releaseGlobalLock();
      removeFileLock(outputPath);
      return false;
    }

    const introSize = fs.statSync(introPath).size;
    const personalSize = fs.statSync(personalPath).size;
    const outroSize = fs.statSync(outroPath).size;

    console.log('=== Starting Video Concatenation ===');
    console.log(`Intro: ${(introSize / 1024 / 1024).toFixed(2)} MB`);
    console.log(`Personal: ${(personalSize / 1024 / 1024).toFixed(2)} MB`);
    console.log(`Outro: ${(outroSize / 1024 / 1024).toFixed(2)} MB`);

    const outputDir = path.dirname(outputPath);
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç fluent-ffmpeg
    const ffmpegModule = await import('fluent-ffmpeg');
    const ffmpeg = ffmpegModule.default;

    ffmpeg.setFfmpegPath(FFMPEG_PATH);

    // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ)
    const getVideoMetadata = (
      videoPath: string
    ): Promise<{ duration: number; hasAudio: boolean }> => {
      return new Promise((resolve) => {
        ffmpeg.ffprobe(
          videoPath,
          (
            err: Error | null,
            metadata?: { format?: { duration?: number }; streams?: Array<{ codec_type?: string }> }
          ) => {
            if (err) {
              console.warn(`Error probing ${videoPath}:`, err.message);
              resolve({ duration: 15, hasAudio: false });
              return;
            }

            const duration = metadata?.format?.duration || 15;
            const hasAudio =
              metadata?.streams?.some((stream) => stream.codec_type === 'audio') || false;

            resolve({ duration, hasAudio });
          }
        );
      });
    };

    const [introMeta, personalMeta, outroMeta] = await Promise.all([
      getVideoMetadata(introPath),
      getVideoMetadata(personalPath),
      getVideoMetadata(outroPath),
    ]);

    const introDuration = introMeta.duration;
    const personalDuration = personalMeta.duration;
    const outroDuration = outroMeta.duration;

    console.log(
      `Durations - Intro: ${introDuration}s, Personal: ${personalDuration}s, Outro: ${outroDuration}s`
    );
    console.log(
      `Audio tracks - Intro: ${introMeta.hasAudio}, Personal: ${personalMeta.hasAudio}, Outro: ${outroMeta.hasAudio}`
    );

    // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–†–û–°–¢–ê–Ø –ö–û–ù–ö–ê–¢–ï–ù–ê–¶–ò–Ø - concat demuxer –ë–ï–ó –í–°–ï–• –§–ò–õ–¨–¢–†–û–í
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –≤–∏–¥–µ–æ –¥–ª—è concat demuxer
    const concatListPath = path.join(outputDir, `concat_list_${Date.now()}.txt`);
    const concatListContent = [
      `file '${introPath.replace(/'/g, "'\\''")}'`,
      `file '${personalPath.replace(/'/g, "'\\''")}'`,
      `file '${outroPath.replace(/'/g, "'\\''")}'`,
    ].join('\n');

    fs.writeFileSync(concatListPath, concatListContent, 'utf8');

    console.log('Using concat demuxer (no filters, no effects)');

    return new Promise((resolve) => {
      const ffmpegCommand = ffmpeg()
        .input(concatListPath)
        .inputOptions(['-f', 'concat', '-safe', '0'])
        .outputOptions([
          '-c:v',
          'libx264', // –ü–µ—Ä–µ–∫–æ–¥–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          '-preset',
          'ultrafast',
          '-crf',
          '28',
          '-pix_fmt',
          'yuv420p',
          '-c:a',
          'aac', // –ü–µ—Ä–µ–∫–æ–¥–∏—Ä—É–µ–º –∞—É–¥–∏–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          '-b:a',
          '128k',
          '-threads',
          '1',
          '-y',
        ])
        .output(outputPath);

      let lastProgress = 0;

      ffmpegCommand
        .on('start', (commandLine: string) => {
          console.log('FFmpeg started (concat demuxer, no filters)');
          console.log('FFmpeg command:', commandLine);
        })
        .on('progress', (progress) => {
          const percent = Math.round(progress.percent || 0);
          if (percent > lastProgress + 10) {
            console.log(`Progress: ${percent}%`);
            lastProgress = percent;
          }
        })
        .on('end', () => {
          // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–ø–∏—Å–∫–∞
          try {
            if (fs.existsSync(concatListPath)) {
              fs.unlinkSync(concatListPath);
            }
          } catch {}

          releaseGlobalLock();
          removeFileLock(outputPath);

          if (fs.existsSync(outputPath)) {
            const outputSize = fs.statSync(outputPath).size;
            const totalInput = introSize + personalSize + outroSize;

            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø
            // –ü—Ä–∏ CRF 28 –∏ ultrafast –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å 30-60% –æ—Ç –≤—Ö–æ–¥–Ω–æ–≥–æ
            const minExpectedSize = totalInput * 0.25; // 25% –º–∏–Ω–∏–º—É–º
            const maxExpectedSize = totalInput * 1.5; // 150% –º–∞–∫—Å–∏–º—É–º

            console.log(`Output: ${(outputSize / 1024 / 1024).toFixed(2)} MB`);
            console.log(
              `Expected range: ${(minExpectedSize / 1024 / 1024).toFixed(2)} - ${(
                maxExpectedSize /
                1024 /
                1024
              ).toFixed(2)} MB`
            );

            if (outputSize < minExpectedSize) {
              console.error('‚ùå Output file too small, likely corrupted');
              try {
                fs.unlinkSync(outputPath);
              } catch {}
              resolve(false);
            } else if (outputSize < 1024 * 1024) {
              // –ú–µ–Ω—å—à–µ 1MB —Ç–æ—á–Ω–æ –±–∏—Ç—ã–π
              console.error('‚ùå Output file suspiciously small (<1MB)');
              try {
                fs.unlinkSync(outputPath);
              } catch {}
              resolve(false);
            } else {
              console.log('‚úÖ Video concatenation successful');
              resolve(true);
            }
          } else {
            console.error('‚ùå Output file not created');
            resolve(false);
          }
        })
        .on('error', (err: Error) => {
          // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–ø–∏—Å–∫–∞
          try {
            if (fs.existsSync(concatListPath)) {
              fs.unlinkSync(concatListPath);
            }
          } catch {}

          releaseGlobalLock();
          removeFileLock(outputPath);

          const errorMsg = err.message || String(err);
          console.error('FFmpeg error:', errorMsg);

          // –í—ã–≤–æ–¥–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
          if (errorMsg.includes('exited with code')) {
            const codeMatch = errorMsg.match(/exited with code (\d+)/);
            if (codeMatch) {
              const exitCode = codeMatch[1];
              console.error(`FFmpeg exit code: ${exitCode}`);

              if (exitCode === '234' || exitCode === '1') {
                console.error('‚ö†Ô∏è Possible causes:');
                console.error('  - Missing audio streams in input videos');
                console.error('  - Incompatible video formats');
                console.error('  - Insufficient memory/resources');
              }
            }
          }

          if (errorMsg.includes('SIGKILL') || errorMsg.includes('killed')) {
            console.error('‚ö†Ô∏è FFmpeg killed by system - OUT OF MEMORY');
            console.error('Consider upgrading server RAM or using simpler video processing');
          }

          if (errorMsg.includes('No such file') || errorMsg.includes('not found')) {
            console.error('‚ö†Ô∏è Input file not found or inaccessible');
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–µ—Ç —Ñ–∞–π–ª –≤—Å—ë –∂–µ —Å–æ–∑–¥–∞–ª—Å—è
          if (fs.existsSync(outputPath)) {
            const outputSize = fs.statSync(outputPath).size;
            if (outputSize > 5 * 1024 * 1024) {
              // > 5MB
              console.log(
                '‚ö†Ô∏è File exists despite error, size:',
                (outputSize / 1024 / 1024).toFixed(2),
                'MB'
              );
              // –í–æ–∑–º–æ–∂–Ω–æ –æ—à–∏–±–∫–∞ –±—ã–ª–∞ –≤ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–æ —Ñ–∞–π–ª –≤–∞–ª–∏–¥–Ω—ã–π
              resolve(true);
              return;
            }
            try {
              fs.unlinkSync(outputPath);
            } catch {}
          }

          resolve(false);
        })
        .run();
    });
  } catch (error) {
    releaseGlobalLock();
    removeFileLock(outputPath);
    console.error('Concatenate videos error:', error);
    return false;
  }
}

// ============== –ü–£–¢–ò –ö –§–ê–ô–õ–ê–ú ==============

export function getPersonalVideoPath(orderId: number): string {
  const personalDir = path.join(VIDEO_STORAGE_PATH, 'personal');
  if (!fs.existsSync(personalDir)) {
    fs.mkdirSync(personalDir, { recursive: true });
  }
  return path.join(personalDir, `personal_${orderId}.mp4`);
}

export function getFinalVideoPath(orderId: number): string {
  const finalDir = path.join(VIDEO_STORAGE_PATH, 'final');
  if (!fs.existsSync(finalDir)) {
    fs.mkdirSync(finalDir, { recursive: true });
  }
  return path.join(finalDir, `final_${orderId}.mp4`);
}

// ============== –û–ß–ò–°–¢–ö–ê ==============

export function deleteOrderPhotos(orderId: number): void {
  try {
    const imagesDir = path.join(VIDEO_STORAGE_PATH, 'images');
    if (!fs.existsSync(imagesDir)) return;

    const photoPatterns = [
      `photo1_order${orderId}.jpg`,
      `photo1_order${orderId}.png`,
      `photo2_order${orderId}.jpg`,
      `photo2_order${orderId}.png`,
    ];

    for (const fileName of photoPatterns) {
      const filePath = path.join(imagesDir, fileName);
      if (fs.existsSync(filePath)) {
        try {
          fs.unlinkSync(filePath);
          console.log(`üóëÔ∏è Deleted: ${fileName}`);
        } catch {}
      }
    }
  } catch (error) {
    console.error(`Error deleting photos for order ${orderId}:`, error);
  }
}

export function deletePersonalVideo(orderId: number): void {
  try {
    const personalPath = getPersonalVideoPath(orderId);
    if (fs.existsSync(personalPath)) {
      fs.unlinkSync(personalPath);
      console.log(`üóëÔ∏è Deleted personal video for order ${orderId}`);
    }
  } catch (error) {
    console.error(`Error deleting personal video for order ${orderId}:`, error);
  }
}

// ============== –≠–ö–°–ü–û–†–¢ –•–ï–õ–ü–ï–†–û–í –î–õ–Ø –û–¢–õ–ê–î–ö–ò ==============

export function getFFmpegLockStatus(): { globalLocked: boolean; lockAge?: number } {
  if (fs.existsSync(GLOBAL_FFMPEG_LOCK)) {
    try {
      const lockTime = parseInt(fs.readFileSync(GLOBAL_FFMPEG_LOCK, 'utf8'), 10);
      return { globalLocked: true, lockAge: Date.now() - lockTime };
    } catch {
      return { globalLocked: true };
    }
  }
  return { globalLocked: false };
}

export function forceReleaseFFmpegLock(): void {
  releaseGlobalLock();
  console.log('‚ö†Ô∏è Force released FFmpeg lock');
}



================================================================================
–§–ê–ô–õ 67/69: scripts\add-system-admin.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\scripts\add-system-admin.ts
================================================================================

import { initDb, getUserByEmail, createUser } from '../lib/db';
import { hashPassword } from '../lib/auth';

// –î–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const SYSTEM_ADMIN = {
  email: 'system@gmail.com',
  password: 'I8378HVGDSKAHGFIO473IEUWH@UKGHLFDHLKZ;O;L;',
  nickname: 'System Admin',
  firstName: 'System',
  lastName: 'Administrator',
};

async function addSystemAdmin() {
  try {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
    await initDb();

    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
    const existingUser = await getUserByEmail(SYSTEM_ADMIN.email);

    if (existingUser) {
      console.log('‚ö†Ô∏è  –°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.');
      console.log(`ID: ${existingUser.id}`);
      console.log(`Email: ${existingUser.email}`);
      console.log(`Nickname: ${existingUser.nickname}`);
      return;
    }

    console.log('–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è...');
    const hashedPassword = await hashPassword(SYSTEM_ADMIN.password);

    console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
    const userId = await createUser(
      SYSTEM_ADMIN.email,
      hashedPassword,
      SYSTEM_ADMIN.nickname,
      SYSTEM_ADMIN.firstName,
      SYSTEM_ADMIN.lastName
    );

    console.log('‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
    console.log(`ID: ${userId}`);
    console.log(`Email: ${SYSTEM_ADMIN.email}`);
    console.log(`Nickname: ${SYSTEM_ADMIN.nickname}`);
    console.log('\nüîê –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:');
    console.log(`Email: ${SYSTEM_ADMIN.email}`);
    console.log(`–ü–∞—Ä–æ–ª—å: ${SYSTEM_ADMIN.password}`);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:', error);
    process.exit(1);
  }
}

// –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
addSystemAdmin();



================================================================================
–§–ê–ô–õ 68/69: scripts\collect-sources.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\scripts\collect-sources.ts
================================================================================

import fs from 'fs';
import path from 'path';

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
const PROJECT_ROOT = process.cwd();
const SRC_DIR = path.join(PROJECT_ROOT, 'src');
const OUTPUT_FILE = path.join(PROJECT_ROOT, 'allsource.txt');

// –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å
const INCLUDED_EXTENSIONS = ['.ts', '.tsx', '.js', '.jsx', '.css', '.json'];
// –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å
const EXCLUDED_EXTENSIONS = ['.ico', '.png', '.jpg', '.jpeg', '.gif', '.svg', '.woff', '.woff2', '.ttf', '.eot'];
// –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤/–ø–∞–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å
const EXCLUDED_PATTERNS = ['node_modules', '.next', '.git', 'allsource.txt'];

function shouldIncludeFile(filePath: string, fileName: string): boolean {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  const relativePath = path.relative(SRC_DIR, filePath);
  for (const pattern of EXCLUDED_PATTERNS) {
    if (relativePath.includes(pattern)) {
      return false;
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
  const ext = path.extname(fileName).toLowerCase();

  // –ò—Å–∫–ª—é—á–∞–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
  if (EXCLUDED_EXTENSIONS.includes(ext)) {
    return false;
  }

  // –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–º–µ–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –≤–∫–ª—é—á–∞–µ–º –µ–≥–æ
  if (INCLUDED_EXTENSIONS.includes(ext)) {
    return true;
  }

  // –ï—Å–ª–∏ —Ñ–∞–π–ª –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –Ω–æ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
  if (!ext) {
    return false; // –ë–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è - –Ω–µ –≤–∫–ª—é—á–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }

  return false;
}

function collectFiles(dir: string, fileList: string[] = []): string[] {
  const files = fs.readdirSync(dir);

  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
      collectFiles(filePath, fileList);
    } else if (stat.isFile() && shouldIncludeFile(filePath, file)) {
      fileList.push(filePath);
    }
  });

  return fileList;
}

function readFileContent(filePath: string): string {
  try {
    return fs.readFileSync(filePath, 'utf-8');
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ ${filePath}:`, error);
    return `// –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${filePath}\n`;
  }
}

function main() {
  console.log('–ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä –≤—Å–µ—Ö –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ src...');

  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
  const files = collectFiles(SRC_DIR);

  console.log(`–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${files.length}`);

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –ø—É—Ç–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  files.sort();

  let output = '';
  output += '='.repeat(80) + '\n';
  output += `–°–ë–û–† –í–°–ï–• –ò–°–•–û–î–ù–ò–ö–û–í –ò–ó –ü–ê–ü–ö–ò SRC\n`;
  output += `–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleString('ru-RU')}\n`;
  output += `–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${files.length}\n`;
  output += '='.repeat(80) + '\n\n';

  files.forEach((filePath, index) => {
    const relativePath = path.relative(SRC_DIR, filePath);
    const content = readFileContent(filePath);

    output += '\n' + '='.repeat(80) + '\n';
    output += `–§–ê–ô–õ ${index + 1}/${files.length}: ${relativePath}\n`;
    output += `–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: ${filePath}\n`;
    output += '='.repeat(80) + '\n\n';
    output += content;
    output += '\n\n';
  });

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª
  try {
    fs.writeFileSync(OUTPUT_FILE, output, 'utf-8');
    console.log(`\n–ì–æ—Ç–æ–≤–æ! –í—Å–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: ${OUTPUT_FILE}`);
    console.log(`–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${(Buffer.byteLength(output, 'utf-8') / 1024 / 1024).toFixed(2)} –ú–ë`);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞:', error);
    process.exit(1);
  }
}

main();



================================================================================
–§–ê–ô–õ 69/69: scripts\init-db.ts
–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: C:\Users\1\Desktop\AIvideoDedMoroz\ded-moroz-video\src\scripts\init-db.ts
================================================================================

import { initDb } from '../lib/db';

async function main() {
  console.log('Initializing database...');
  await initDb();
  console.log('Database initialized successfully!');
  process.exit(0);
}

main().catch((error) => {
  console.error('Error initializing database:', error);
  process.exit(1);
});


