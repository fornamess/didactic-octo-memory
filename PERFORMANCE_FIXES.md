# Исправления производительности

## Проблема

Сайт грузится 15-20 секунд вместо 1-2 секунд.

## Причины

1. `ensureDbInitialized()` вызывается на каждом запросе
2. `getServerUser()` делает запрос к БД каждый раз без кэширования
3. SQLite открывается заново на каждый запрос
4. Нет оптимизации для чтения из БД

## Исправления

### 1. Кэширование пользователя (5 секунд)

- Добавлен кэш в памяти для `getServerUser()`
- Баланс обновляется максимум раз в 5 секунд
- Очистка старых записей из кэша

### 2. Оптимизация SQLite

- Включен WAL режим для лучшей производительности
- Кэширование проверки существования файла БД (10 секунд)
- Оптимизированы PRAGMA настройки:
  - `synchronous = NORMAL` (быстрее чем FULL)
  - `cache_size = 10000` (больше кэша в памяти)

### 3. Singleton для инициализации БД

- `ensureDbInitialized()` использует Promise singleton
- БД инициализируется только один раз

## Дополнительные рекомендации

Если проблема сохраняется:

1. **Проверьте логи PM2:**

   ```bash
   pm2 logs ded-moroz-video --lines 50
   ```

2. **Проверьте время ответа БД:**

   - Может быть проблема с диском (медленный I/O)
   - Проверьте `iostat` или `iotop`

3. **Проверьте сеть:**

   - Может быть медленное DNS разрешение
   - Проверьте `dig prizmabox.org`

4. **Проверьте нагрузку:**

   ```bash
   top
   htop
   ```

5. **Рассмотрите использование connection pooling:**

   - Для продакшена можно использовать `better-sqlite3` вместо `sqlite3`
   - Или перейти на PostgreSQL/MySQL

6. **Добавьте мониторинг:**
   - Логируйте время выполнения запросов
   - Используйте `console.time()` / `console.timeEnd()`
