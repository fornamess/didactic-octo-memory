version: '3.8'

services:
  dedmoroz:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dedmoroz-video
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - FFMPEG_PATH=/usr/bin/ffmpeg
      # Безопасность
      - JWT_SECRET=${JWT_SECRET:-984Y39G8YSDKUGHLYIEGP;ASG9UESLKUKY4LGI8ZYLRIGHKZ8IR8G7HUIS8HLEHLRIUGULIALUHERULHIGLUKIEFUGYUKIGDFYK23T54YHFD}
      # API Yes AI
      - YES_AI_API_BASE=${YES_AI_API_BASE:-https://api.yesai.su/v2}
      - YES_AI_TOKEN=${YES_AI_TOKEN}
      # Администраторы
      - ADMIN_EMAILS=${ADMIN_EMAILS:-system@gmail.com}
      # Платёжная система
      - BITBANKER_API_KEY=${BITBANKER_API_KEY}
      - BITBANKER_SECRET=${BITBANKER_SECRET}
      # URL приложения
      - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
      # Поддержка
      - SUPPORT_TELEGRAM=${SUPPORT_TELEGRAM:-@your_support_bot}
      - SUPPORT_EMAIL=${SUPPORT_EMAIL:-support@your-domain.com}
      # Настройки сервиса
      - SERVICE_COST=${SERVICE_COST:-0}
      - VIDEO_EXPIRY_DAYS=${VIDEO_EXPIRY_DAYS:-7}
      - GENERATION_TIMEOUT_MINUTES=${GENERATION_TIMEOUT_MINUTES:-15}
      # База данных и хранилище
      - DATABASE_PATH=${DATABASE_PATH:-/data/app.db}
      - VIDEO_STORAGE_PATH=${VIDEO_STORAGE_PATH:-/data/videos}
    volumes:
      # Персистентное хранилище для БД и видео (для Amvera используйте /data)
      # Для локальной разработки можно использовать named volumes:
      - dedmoroz-data:/data
      # Или bind mount для локальной разработки:
      # - ./data:/data
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # Единый volume для всех данных (БД и видео)
  dedmoroz-data:
    driver: local
